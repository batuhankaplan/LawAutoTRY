{% extends "layout.html" %}

{% block title %}Dosya Ekle{% endblock %}

{% block content %}
<header>
    <div class="header-left">
        <h1>Dosya Ekle</h1>
        <button id="uyapSyncBtn" class="btn" style="margin-left: 15px;">
            <i class="fas fa-sync-alt"></i> UYAP'tan Dosyaları Çek
        </button>
    </div>
</header>

<div class="inbox">
    <form method="POST" class="search-form" id="addCaseForm">
        <div class="form-column">
            <div class="input-group">
                <label for="file-type">Dosya Türü</label>
                <select id="file-type" name="file-type" onchange="handleFileTypeChange()" required>
                    <option value="">Seçiniz</option>
                    <option value="ceza">Ceza</option>
                    <option value="hukuk">Hukuk</option>
                    <option value="icra">İcra</option>
                    <option value="savcilik">Savcılık</option>
                    <option value="ARABULUCULUK">Arabuluculuk</option>
                    <option value="AİHM">AİHM</option>
                    <option value="AYM">AYM</option>
                </select>
            </div>

            <div class="input-group">
                <label for="city">Şehir</label>
                <select id="city" name="city" onchange="updateCourthouses()" required>
                    <option value="">Seçiniz</option>
                    {% for city_name in cities %}
                        <option value="{{ city_name }}">{{ city_name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="input-group">
                <label for="courthouse">Adliye</label>
                <select id="courthouse" name="courthouse" class="form-control" required>
                    <option value="">Önce Şehir Seçiniz</option>
                </select>
            </div>

            <div class="input-group">
                <label for="department">Mahkeme</label>
                <select id="department" name="department" class="form-control" required>
                    <option value="">Seçiniz</option>
                    <option value="Asliye Hukuk Mahkemesi">Asliye Hukuk Mahkemesi</option>
                    <option value="Sulh Hukuk Mahkemesi">Sulh Hukuk Mahkemesi</option>
                    <option value="İş Mahkemesi">İş Mahkemesi</option>
                    <option value="Aile Mahkemesi">Aile Mahkemesi</option>
                    <option value="Ticaret Mahkemesi">Ticaret Mahkemesi</option>
                    <option value="İcra Hukuk Mahkemesi">İcra Hukuk Mahkemesi</option>
                    <option value="Tüketici Mahkemesi">Tüketici Mahkemesi</option>
                    <option value="Fikri ve Sınai Haklar Mahkemesi">Fikri ve Sınai Haklar Mahkemesi</option>
                    <option value="Asliye Ceza Mahkemesi">Asliye Ceza Mahkemesi</option>
                    <option value="Ağır Ceza Mahkemesi">Ağır Ceza Mahkemesi</option>
                    <option value="Sulh Ceza Hakimliği">Sulh Ceza Hakimliği</option>
                    <option value="İcra Dairesi">İcra Dairesi</option>
                </select>
            </div>

            <div class="input-group" id="court-number-container" style="display: none;">
                <label for="court-number">Numaralı Mahkeme</label>
                <select id="court-number" name="court-number">
                    <option value="">Seçiniz</option>
                </select>
            </div>

            <div class="input-group">
                <label for="year">Yıl</label>
                <input type="number" id="year" name="year" required>
            </div>
            
            <div class="input-group">
                <label for="case-number">Esas No</label>
                <input type="text" id="case-number" name="case-number" required>
            </div>
            
            <div class="input-group">
                <label for="client-name">Müvekkil Adı</label>
                <input type="text" id="client-name" name="client-name" required>
            </div>

            <div class="input-group">
                <label for="phone-number">Telefon Numarası</label>
                <input type="tel" id="phone-number" name="phone-number" pattern="[0-9]{10,11}" placeholder="5XX XXX XX XX">
            </div>

            <div class="input-group">
                <label for="open-date">Açılış Tarihi</label>
                <input type="date" id="open-date" name="open-date" required value="{{ today_date }}">
            </div>
        </div>

        <div class="search-button-container">
            <button type="submit" class="btn">Ekle</button>
        </div>
    </form>
</div>

<!-- UYAP Senkronizasyon Modal -->
<div class="modal" id="uyapSyncModal" tabindex="-1" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h5>UYAP Senkronizasyonu</h5>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <p>UYAP'a giriş yapmanız ve e-imzanızı kullanmanız gerekecektir. Bu işlem birkaç dakika sürebilir.</p>
            <div class="progress" style="display: none;">
                <div class="progress-bar"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary close-modal">İptal</button>
            <button type="button" class="btn" id="startSync">Senkronizasyonu Başlat</button>
        </div>
    </div>
</div>

<style>
.inbox {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 25px;
}

.search-form {
    width: 100%;
}

.form-column {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 90%;
}

.input-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.input-group label {
    font-weight: 500;
    color: #2c3e50;
    font-size: 0.9rem;
    margin-bottom: -2px;
}

.input-group input,
.input-group select {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    font-size: 1rem;
    color: #2c3e50;
    background: white;
    height: 48px;
    transition: all 0.2s ease;
    font-family: inherit;
    box-sizing: border-box;
}

.input-group select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 12px center;
    background-repeat: no-repeat;
    background-size: 16px;
    background-color: white;
    padding-right: 40px;
    min-height: 48px;
    line-height: 1.5;
}

.input-group select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

.input-group input:focus,
.input-group select:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
}

.search-button-container {
    display: flex;
    justify-content: flex-end;
    padding-top: 15px;
    margin-top: 0;
    border-top: 1px solid #dee2e6;
}

.btn {
    padding: 10px 25px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    height: 42px;
}

.btn:hover {
    background: var(--hover-color);
}

/* Modal Stilleri */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    position: relative;
    background-color: #fefefe;
    margin: 15% auto;
    padding: 0;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.modal-header {
    padding: 15px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 15px;
}

.modal-footer {
    padding: 15px;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: black;
}

.progress {
    width: 100%;
    height: 20px;
    background-color: #f0f0f0;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 10px;
}

.progress-bar {
    width: 100%;
    height: 100%;
    background-color: var(--primary-color);
    animation: progress-animation 2s linear infinite;
}

@keyframes progress-animation {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.btn-secondary {
    background-color: #6c757d;
}

.btn-secondary:hover {
    background-color: #5a6268;
}

.input-group select:disabled,
.input-group input:disabled {
    background-color: #e9ecef;
    cursor: not-allowed;
    opacity: 0.7;
}
</style>

<script>
// Backend'den gelen tüm adliye verisi
const allCourthousesData = JSON.parse('{{ all_courthouses | safe }}');

// Orijinal Birim seçeneklerini sakla
let originalDepartmentOptions = [];

// İstanbul'a özel adliyeler
const istanbulSpecificCourthouses = [
    "İstanbul Anadolu Adliyesi (Kartal)",
    "İstanbul Adliyesi (Çağlayan)",
    "Bakırköy Adliyesi",
    "Büyükçekmece Adliyesi",
    "Gaziosmanpaşa Adliyesi",
    "Küçükçekmece Adliyesi",
    "Silivri Adliyesi",
    "Çatalca Adliyesi",
    "Üsküdar Adliyesi",
    "Adalar Adliyesi",
    "Sarıyer Adliyesi"
];

document.addEventListener('DOMContentLoaded', () => {
    const departmentSelect = document.getElementById('department');
    // "Seçiniz" hariç orijinal seçenekleri al ve sakla
    originalDepartmentOptions = Array.from(departmentSelect.options)
                                    .filter(opt => opt.value !== '')
                                    .map(opt => opt.cloneNode(true));

    handleFileTypeChange(); // İlk yüklemede alanları ayarla

    // Modal logic...
    const modal = document.getElementById('uyapSyncModal');
    const btn = document.getElementById('uyapSyncBtn');
    const span = document.getElementsByClassName('close')[0];
    const cancelBtn = modal.querySelector('.close-modal');
    const startSyncBtn = document.getElementById('startSync');
    const progressBar = modal.querySelector('.progress');

    if (btn) {
         btn.onclick = function() {
            modal.style.display = 'block';
         }
    }
    if (span) {
        span.onclick = function() {
            modal.style.display = 'none';
        }
    }
    if (cancelBtn) {
        cancelBtn.onclick = function() {
            modal.style.display = 'none';
        }
    }
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
    if(startSyncBtn){
        startSyncBtn.onclick = function() {
             progressBar.style.display = 'block';
             console.log("UYAP senkronizasyonu başlatıldı...");
        }
    }
    
    // Form submit eventi
    const form = document.getElementById('addCaseForm');
    if (form) {
        form.addEventListener('submit', submitForm);
    }
});

function updateCourthouses() {
    const citySelect = document.getElementById('city');
    const courthouseSelect = document.getElementById('courthouse');
    
    if (!citySelect || !courthouseSelect) {
        console.error('City veya courthouse select elementleri bulunamadı');
        return;
    }
    
    const selectedCity = citySelect.value;

    // Önceki adliyeleri temizle
    courthouseSelect.innerHTML = '<option value="">Seçiniz</option>';

    if (!selectedCity) {
        courthouseSelect.innerHTML = '<option value="">Önce Şehir Seçiniz</option>';
        return;
    }

    let courthousesAdded = false;

    // Eğer İstanbul seçiliyse, spesifik İstanbul adliyelerini ekle
    if (selectedCity === 'İstanbul') {
        istanbulSpecificCourthouses.forEach(courthouse => {
            const option = document.createElement('option');
            option.value = courthouse;
            option.textContent = courthouse;
            courthouseSelect.appendChild(option);
        });
        courthousesAdded = true;
    }
    
    // Seçili şehir için adliyeleri ekle (allCourthousesData kontrol et)
    if (selectedCity && allCourthousesData && allCourthousesData[selectedCity]) {
        allCourthousesData[selectedCity].forEach(courthouse => {
            // İstanbul'da duplicate'leri önle
            if (selectedCity === 'İstanbul' && istanbulSpecificCourthouses.includes(courthouse)) {
                return;
            }
            const option = document.createElement('option');
            option.value = courthouse;
            option.textContent = courthouse;
            courthouseSelect.appendChild(option);
        });
        courthousesAdded = true;
    }

    // Hiç adliye yoksa hata mesajı göster
    if (!courthousesAdded || courthouseSelect.options.length <= 1) {
        courthouseSelect.innerHTML = '<option value="">Bu şehir için adliye bulunamadı</option>';
        console.warn(`${selectedCity} için adliye verisi bulunamadı`);
    }
}

function handleFileTypeChange() {
    const fileTypeSelect = document.getElementById('file-type');
    const courthouseSelect = document.getElementById('courthouse');
    const departmentSelect = document.getElementById('department');
    const citySelect = document.getElementById('city');
    const courtNumberContainer = document.getElementById('court-number-container');

    if (!fileTypeSelect || !courthouseSelect || !departmentSelect || !citySelect) {
        console.error('Gerekli form elementleri bulunamadı');
        return;
    }

    const selectedFileType = fileTypeSelect.value.toLowerCase(); // büyük/küçük harf standardizasyonu
    const originalValue = fileTypeSelect.value; // Orijinal değeri de alalım

    // Hangi alanların devre dışı bırakılacağını belirle
    // Türkçe karakter sorunu için doğrudan değeri de kontrol ediyoruz
    const disableCourthouseAndCity = ['arabuluculuk', 'aihm', 'ahm', 'aym'].includes(selectedFileType) || 
                                    originalValue === 'AİHM' || originalValue === 'AYM' || originalValue === 'ARABULUCULUK';
    
    const disableDepartment = ['arabuluculuk', 'aihm', 'ahm', 'aym', 'savcilik'].includes(selectedFileType) || 
                             originalValue === 'AİHM' || originalValue === 'AYM' || originalValue === 'ARABULUCULUK' || 
                             originalValue === 'Savcılık' || originalValue === 'savcilik';

    // Debug için konsola yazdıralım
    if (originalValue) {
        console.log("Seçilen dosya türü:", originalValue);
        console.log("toLowerCase sonucu:", selectedFileType);
        console.log("Şehir/Adliye devre dışı mı:", disableCourthouseAndCity);
        console.log("Mahkeme devre dışı mı:", disableDepartment);
    }

    // Alanları etkinleştir/devre dışı bırak
    courthouseSelect.disabled = disableCourthouseAndCity;
    citySelect.disabled = disableCourthouseAndCity;
    departmentSelect.disabled = disableDepartment;

    // Gerekli (required) attribute'larını ayarla
    courthouseSelect.required = !disableCourthouseAndCity;
    citySelect.required = !disableCourthouseAndCity;
    departmentSelect.required = !disableDepartment;

    // Önce mevcut birimleri temizle ("Seçiniz" hariç)
    while (departmentSelect.options.length > 1) {
        departmentSelect.remove(1);
    }

    // Dosya türüne göre mahkeme/birim listesini ayarla
    if (disableDepartment) {
        // Department disabled - value temizle
        departmentSelect.value = '';
        courtNumberContainer.style.display = 'none'; // Mahkeme seçimini gizle
    } else if (selectedFileType === 'hukuk') {
        // Hukuk mahkemeleri
        const hukukMahkemeleri = [
            'Asliye Hukuk Mahkemesi',
            'Sulh Hukuk Mahkemesi',
            'İş Mahkemesi',
            'Aile Mahkemesi',
            'Ticaret Mahkemesi',
            'İcra Hukuk Mahkemesi',
            'Tüketici Mahkemesi',
            'Fikri ve Sınai Haklar Mahkemesi'
        ];
        
        hukukMahkemeleri.forEach(mahkeme => {
            const option = document.createElement('option');
            option.value = mahkeme;
            option.textContent = mahkeme;
            departmentSelect.appendChild(option);
        });
        
        departmentSelect.onchange = function() {
            updateCourtNumbers(this.value);
        };
    } else if (selectedFileType === 'ceza') {
        // Ceza mahkemeleri
        const cezaMahkemeleri = [
            'Asliye Ceza Mahkemesi',
            'Ağır Ceza Mahkemesi',
            'Sulh Ceza Hakimliği'
        ];
        
        cezaMahkemeleri.forEach(mahkeme => {
            const option = document.createElement('option');
            option.value = mahkeme;
            option.textContent = mahkeme;
            departmentSelect.appendChild(option);
        });
        
        departmentSelect.onchange = function() {
            updateCourtNumbers(this.value);
        };
    } else if (selectedFileType === 'icra') {
        // İcra Daireleri (1-30 arası)
        const option = document.createElement('option');
        option.value = 'İcra Dairesi';
        option.textContent = 'İcra Dairesi';
        departmentSelect.appendChild(option);
        
        courtNumberContainer.style.display = 'none'; // İcra için farklı numaralandırma
        
        departmentSelect.onchange = function() {
            // İcra Dairesi seçildiğinde özel işlem
            if (this.value === 'İcra Dairesi') {
                updateIcraDaireleri();
            } else {
                courtNumberContainer.style.display = 'none';
            }
        };
    } else {
        // Hiçbir özel türe uymayan diğer durumlar için orijinal birim listesini geri yükle
        originalDepartmentOptions.forEach(originalOption => {
            departmentSelect.appendChild(originalOption.cloneNode(true));
        });
        
        // Birim değişince mahkeme numaralarını güncelle
        departmentSelect.onchange = function() {
            updateCourtNumbers(this.value);
        };
    }

    // Eğer seçilen dosya türü courthouse/city için disable gerektiriyorsa değerleri temizle
    if (disableCourthouseAndCity) {
        courthouseSelect.value = '';
        citySelect.value = '';
        courtNumberContainer.style.display = 'none'; // Mahkeme seçimini gizle
    }

    // Şehir seçiliyse adliye listesini güncelle
    if (!disableCourthouseAndCity && citySelect.value) {
        updateCourthouses();
    } else if (!disableCourthouseAndCity && !citySelect.value) {
        courthouseSelect.innerHTML = '<option value="">Önce Şehir Seçiniz</option>';
    }
    
    // Mevcut birim değerine göre mahkeme numaralarını güncelle
    if (departmentSelect.value) {
        if (selectedFileType === 'icra' && departmentSelect.value === 'İcra Dairesi') {
            updateIcraDaireleri();
        } else {
            updateCourtNumbers(departmentSelect.value);
        }
    } else {
        courtNumberContainer.style.display = 'none';
    }
}

// İcra dairelerini güncelle (1-30 arası numara seçimi)
function updateIcraDaireleri() {
    const courtNumberContainer = document.getElementById('court-number-container');
    const courtNumberSelect = document.getElementById('court-number');
    
    if (!courtNumberContainer || !courtNumberSelect) {
        console.error('Court number elementleri bulunamadı');
        return;
    }
    
    // İcra daireleri listesini temizle
    courtNumberSelect.innerHTML = '<option value="">Seçiniz</option>';
    
    // İcra dairelerini ekle (1-30)
    for (let i = 1; i <= 30; i++) {
        const option = document.createElement('option');
        option.value = `${i}. İcra Dairesi`;
        option.textContent = `${i}. İcra Dairesi`;
        courtNumberSelect.appendChild(option);
    }
    
    courtNumberContainer.style.display = 'flex';
}

// Mahkeme numaralarını güncelle
function updateCourtNumbers(department) {
    const courtNumberContainer = document.getElementById('court-number-container');
    const courtNumberSelect = document.getElementById('court-number');
    
    if (!courtNumberContainer || !courtNumberSelect) {
        console.error('Court number elementleri bulunamadı');
        return;
    }
    
    // İcra dairesi veya seçim boşsa mahkeme numarasını gizle
    if (!department || department === '' || department.includes('İcra Dairesi')) {
        courtNumberContainer.style.display = 'none';
        return;
    }
    
    // Mahkeme numaralarını temizle
    courtNumberSelect.innerHTML = '<option value="">Seçiniz</option>';
    
    // Seçili mahkeme adı ekle
    const baseOption = document.createElement('option');
    baseOption.value = department;
    baseOption.textContent = department;
    courtNumberSelect.appendChild(baseOption);
    
    // Adliye ve şehre göre mahkeme sayısını belirle
    const citySelect = document.getElementById('city');
    const courthouseSelect = document.getElementById('courthouse');
    
    if (!citySelect || !courthouseSelect) {
        console.error('City veya courthouse select elementleri bulunamadı');
        return;
    }
    
    const selectedCity = citySelect.value;
    const selectedCourthouse = courthouseSelect.value;
    
    // Varsayılan olarak 30 mahkeme, İstanbul için daha fazla
    let maxCourtNumber = 30;
    
    // İstanbul ve belirli adliyeler için daha fazla mahkeme
    if (selectedCity === 'İstanbul') {
        if (selectedCourthouse.includes('Anadolu') || selectedCourthouse.includes('Çağlayan')) {
            if (department === 'Asliye Hukuk Mahkemesi' || 
                department === 'Asliye Ceza Mahkemesi' || 
                department === 'İş Mahkemesi') {
                maxCourtNumber = 50;
            } else if (department === 'Ağır Ceza Mahkemesi') {
                maxCourtNumber = 15;
            }
        } else if (selectedCourthouse.includes('Bakırköy')) {
            maxCourtNumber = 40;
        }
    } else if (selectedCity === 'Ankara' || selectedCity === 'İzmir') {
        maxCourtNumber = 40;
    }
    
    // Numaralı mahkemeleri ekle
    for (let i = 1; i <= maxCourtNumber; i++) {
        const option = document.createElement('option');
        option.value = `${i}. ${department}`;
        option.textContent = `${i}. ${department}`;
        courtNumberSelect.appendChild(option);
    }
    
    courtNumberContainer.style.display = 'flex';
}

async function submitForm(event) {
    event.preventDefault();
    const form = document.getElementById('addCaseForm');
    const formData = new FormData(form);
    const data = {};
    let isValid = true;

    formData.forEach((value, key) => {
        const element = form.elements[key];
        if (element && !element.disabled) {
            if (element.required && !value) {
                showFlashMessage(`Lütfen tüm zorunlu alanları doldurun: ${element.labels[0]?.textContent || key}`, 'error');
                isValid = false;
            }
            data[key] = value;
        }
    });

    if (!isValid) {
        return;
    }

    // Backend'e JSON gönder
    try {
        const response = await fetch('{{ url_for("dosya_ekle") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        });
        const result = await response.json();

        if (result.success) {
            showFlashMessage('Dosya başarıyla eklendi.', 'success');
            form.reset(); // Formu sıfırla
            handleFileTypeChange(); // Alanları başlangıç durumuna getir
            // Dosya sorgulama sayfasına yönlendir ve detayı göster
            if (result.new_case_id) {
                window.location.href = `{{ url_for("dosya_sorgula") }}?show_details=${result.new_case_id}`;
            } else {
                window.location.href = '{{ url_for("dosya_sorgula") }}'; // ID yoksa sadece sayfaya yönlendir
            }
        } else {
            showFlashMessage('Hata: ' + (result.message || 'Bilinmeyen bir hata oluştu'), 'error');
        }
    } catch (error) {
        console.error('Form gönderme hatası:', error);
        showFlashMessage('Bir hata oluştu. Lütfen tekrar deneyin.', 'error');
    }
}

// Flash mesaj gösterme fonksiyonu
function showFlashMessage(message, category) {
    const flashContainer = document.getElementById('flash-messages') || document.body;
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${category}`;
    alertDiv.textContent = message;
    alertDiv.style.position = 'fixed';
    alertDiv.style.top = '80px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '1050';
    alertDiv.style.padding = '10px 20px';
    alertDiv.style.borderRadius = '5px';
    alertDiv.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';

    flashContainer.appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.style.transition = 'opacity 0.5s ease';
        alertDiv.style.opacity = '0';
        setTimeout(() => alertDiv.remove(), 500);
    }, 5000);
}
</script>
{% endblock %}