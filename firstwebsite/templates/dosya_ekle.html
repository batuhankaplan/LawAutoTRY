{% extends "layout.html" %}

{% block title %}Dosya Ekle{% endblock %}

{% block content %}
<header>
    <div class="header-left">
        <h1>Dosya Ekle</h1>
        <button id="uyapSyncBtn" class="btn" style="margin-left: 15px;">
            <i class="fas fa-sync-alt"></i> UYAP'tan Dosyaları Çek
        </button>
    </div>
</header>

<div class="inbox">
    <form method="POST" class="search-form" onsubmit="return submitForm(event)">
        <div class="form-column">
            <div class="input-group">
                <label for="file-type">Dosya Türü</label>
                <select id="file-type" name="file-type" onchange="updateDepartments()">
                    <option value="">Seçiniz</option>
                    <option value="ceza">Ceza</option>
                    <option value="hukuk">Hukuk</option>
                    <option value="icra">İcra</option>
                    <option value="savcilik">Savcılık</option>
                    <option value="aihm">AİHM</option>
                    <option value="aym">AYM</option>
                </select>
            </div>

            <div class="input-group">
                <label for="courthouse">Adliye</label>
                <select id="courthouse" name="courthouse">
                    <option value="">Seçiniz</option>
                </select>
            </div>

            <div class="input-group">
                <label for="department">Birim</label>
                <select id="department" name="department">
                    <option value="">Seçiniz</option>
                </select>
            </div>

            <div class="input-group" id="court-number-container" style="display: none;">
                <label for="court-number">Mahkeme</label>
                <select id="court-number" name="court-number">
                    <option value="">Seçiniz</option>
                </select>
            </div>

            <div class="input-group">
                <label for="year">Yıl</label>
                <input type="number" id="year" name="year" required>
            </div>
            
            <div class="input-group">
                <label for="case-number">Esas No</label>
                <input type="text" id="case-number" name="case-number" required>
            </div>
            
            <div class="input-group">
                <label for="client-name">Müvekkil Adı</label>
                <input type="text" id="client-name" name="client-name" required>
            </div>

            <div class="input-group">
                <label for="phone-number">Telefon Numarası</label>
                <input type="tel" id="phone-number" name="phone-number" pattern="[0-9]{10,11}" placeholder="5XX XXX XX XX">
            </div>

            <div class="input-group">
                <label for="open-date">Açılış Tarihi</label>
                <input type="date" id="open-date" name="open-date" required value="{{ today_date }}">
            </div>
        </div>

        <div class="search-button-container">
            <button type="submit" class="btn">Ekle</button>
        </div>
    </form>
</div>

<!-- UYAP Senkronizasyon Modal -->
<div class="modal" id="uyapSyncModal" tabindex="-1" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h5>UYAP Senkronizasyonu</h5>
            <span class="close">&times;</span>
        </div>
        <div class="modal-body">
            <p>UYAP'a giriş yapmanız ve e-imzanızı kullanmanız gerekecektir. Bu işlem birkaç dakika sürebilir.</p>
            <div class="progress" style="display: none;">
                <div class="progress-bar"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary close-modal">İptal</button>
            <button type="button" class="btn" id="startSync">Senkronizasyonu Başlat</button>
        </div>
    </div>
</div>

<style>
.inbox {
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 25px;
}

.search-form {
    width: 100%;
}

.form-column {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 90%;
}

.input-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.input-group label {
    font-weight: 500;
    color: #2c3e50;
    font-size: 0.9rem;
    margin-bottom: -2px;
}

.input-group input,
.input-group select {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    font-size: 0.9rem;
    color: #2c3e50;
    background: white;
    height: 32px;
}

.input-group input:focus,
.input-group select:focus {
    border-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
}

.search-button-container {
    display: flex;
    justify-content: flex-end;
    padding-top: 15px;
    margin-top: 0;
    border-top: 1px solid #dee2e6;
}

.btn {
    padding: 6px 20px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    height: 32px;
}

.btn:hover {
    background: var(--hover-color);
}

/* Modal Stilleri */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    position: relative;
    background-color: #fefefe;
    margin: 15% auto;
    padding: 0;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.modal-header {
    padding: 15px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 15px;
}

.modal-footer {
    padding: 15px;
    border-top: 1px solid #dee2e6;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: black;
}

.progress {
    width: 100%;
    height: 20px;
    background-color: #f0f0f0;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 10px;
}

.progress-bar {
    width: 100%;
    height: 100%;
    background-color: var(--primary-color);
    animation: progress-animation 2s linear infinite;
}

@keyframes progress-animation {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.btn-secondary {
    background-color: #6c757d;
}

.btn-secondary:hover {
    background-color: #5a6268;
}
</style>

<script>
// Adliye ve birim listelerini tanımla
const courthouses = [
    "İstanbul Adliyesi (Çağlayan)",
    "İstanbul Anadolu Adliyesi (Kartal)",
    "Bakırköy Adliyesi",
    "Büyükçekmece Adliyesi",
    "Gaziosmanpaşa Adliyesi",
    "Küçükçekmece Adliyesi",
    "Silivri Adliyesi",
    "Çatalca Adliyesi",
    "Üsküdar Adliyesi",
    "Adalar Adliyesi",
    "Sarıyer Adliyesi"
];

const departments = {
    hukuk: [
        "Asliye Hukuk Mahkemesi",
        "Sulh Hukuk Mahkemesi",
        "Aile Mahkemesi",
        "İş Mahkemesi",
        "Tüketici Mahkemesi",
        "Kadastro Mahkemesi",
        "Ticaret Mahkemesi",
        "Fikri ve Sınai Haklar Hukuk Mahkemesi",
        "İcra Hukuk Mahkemesi"
    ],
    ceza: [
        "Asliye Ceza Mahkemesi",
        "Ağır Ceza Mahkemesi",
        "Sulh Ceza Hakimliği",
        "Çocuk Mahkemesi",
        "Çocuk Ağır Ceza Mahkemesi",
        "İcra Ceza Mahkemesi",
        "Fikri ve Sınai Haklar Ceza Mahkemesi"
    ],
    icra: Array.from({length: 30}, (_, i) => `${i + 1}. İcra Dairesi`)
};

// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', function() {
    populateCourthouses();
    
    // Dosya türü değiştiğinde birimleri güncelle
    document.getElementById('file-type').addEventListener('change', updateDepartments);
    
    // Modal işlemleri
    const modal = document.getElementById('uyapSyncModal');
    const btn = document.getElementById('uyapSyncBtn');
    const closeBtn = document.querySelector('.close');
    const closeModalBtn = document.querySelector('.close-modal');
    const startSyncBtn = document.getElementById('startSync');
    const progress = document.querySelector('.progress');
    
    btn.onclick = function() {
        modal.style.display = "block";
    }
    
    closeBtn.onclick = closeModalBtn.onclick = function() {
        modal.style.display = "none";
        progress.style.display = "none";
    }
    
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
            progress.style.display = "none";
        }
    }
    
    startSyncBtn.onclick = function() {
        progress.style.display = "block";
        startSyncBtn.disabled = true;
        closeModalBtn.disabled = true;
        
        fetch('/uyap_sync', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                alert('Hata: ' + data.message);
            }
        })
        .catch(error => {
            alert('Bir hata oluştu: ' + error);
        })
        .finally(() => {
            progress.style.display = "none";
            startSyncBtn.disabled = false;
            closeModalBtn.disabled = false;
        });
    }
});

// Adliye listesini doldur
function populateCourthouses() {
    const select = document.getElementById('courthouse');
    select.innerHTML = '<option value="">Seçiniz</option>';
    courthouses.forEach(courthouse => {
        select.innerHTML += `<option value="${courthouse}">${courthouse}</option>`;
    });
}

// Dosya türüne göre birimleri güncelle
function updateDepartments() {
    const fileType = document.getElementById('file-type').value;
    const departmentSelect = document.getElementById('department');
    const courtNumberContainer = document.getElementById('court-number-container');
    
    departmentSelect.innerHTML = '<option value="">Seçiniz</option>';
    
    if (fileType && departments[fileType]) {
        departments[fileType].forEach(dept => {
            departmentSelect.innerHTML += `<option value="${dept}">${dept}</option>`;
        });
    }

    // Birim değiştiğinde mahkeme seçeneğini güncelle
    departmentSelect.onchange = function() {
        updateCourtNumbers(this.value);
    };
}

// Mahkeme numaralarını güncelle
function updateCourtNumbers(department) {
    const courtNumberContainer = document.getElementById('court-number-container');
    const courtNumberSelect = document.getElementById('court-number');
    
    // İcra dairesi kontrolü
    if (!department || department === '' || department.includes('İcra Dairesi')) {
        courtNumberContainer.style.display = 'none';
        return;
    }

    courtNumberSelect.innerHTML = `
        <option value="">Seçiniz</option>
        <option value="${department}">${department}</option>
        ${Array.from({length: 50}, (_, i) => i + 1).map(num => 
            `<option value="${num}.${department}">${num}.${department}</option>`
        ).join('')}
    `;
    
    courtNumberContainer.style.display = 'block';
}

// Form gönderimi için yeni fonksiyon
function submitForm(event) {
    event.preventDefault();
    
    const formData = {
        'file-type': document.getElementById('file-type').value,
        'courthouse': document.getElementById('courthouse').value,
        'department': document.getElementById('court-number')?.value || document.getElementById('department').value,
        'year': document.getElementById('year').value,
        'case-number': document.getElementById('case-number').value,
        'client-name': document.getElementById('client-name').value,
        'phone-number': document.getElementById('phone-number').value,
        'open-date': document.getElementById('open-date').value
    };

    // Tüm alanların dolu olduğunu kontrol et
    for (let key in formData) {
        if (!formData[key]) {
            alert('Lütfen tüm alanları doldurunuz.');
            return false;
        }
    }

    // Form verilerini POST isteği ile gönder
    fetch('/dosya_ekle', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        if (response.ok) {
            window.location.href = '/dosya_sorgula';
        } else {
            return response.json().then(data => {
                throw new Error(data.message || 'Bir hata oluştu');
            });
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('Dosya eklenirken bir hata oluştu: ' + error.message);
    });

    return false;
}
</script>
{% endblock %}