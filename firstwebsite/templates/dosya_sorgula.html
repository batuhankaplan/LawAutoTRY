{% extends "layout.html" %}

{% block title %}Dosya Sorgula{% endblock %}

{% block content %}
<header>
    <div class="header-left">
        <h1>Dosya Sorgula</h1>
    </div>
</header>

<div class="inbox">
    <form method="POST" class="search-form">
        <div class="form-columns">
            <!-- Sol Sütun -->
            <div class="form-column">
                <div class="input-group">
                    <label for="file-type">Dosya Türü</label>
                    <select id="file-type" name="file-type" onchange="handleFileTypeChange()">
                        <option value="">Tümü</option>
                        <option value="hukuk">Hukuk</option>
                        <option value="ceza">Ceza</option>
                        <option value="icra">İcra</option>
                        <option value="savcilik">Savcılık</option>
                        <option value="ARABULUCULUK">Arabuluculuk</option>
                        <option value="AİHM">AİHM</option>
                        <option value="AYM">AYM</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="city">Şehir</label>
                    <select id="city" name="city" onchange="updateCourthouses()">
                        <option value="">Tümü</option>
                        {% for city_name in cities %}
                            <option value="{{ city_name }}">{{ city_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="courthouse">Adliye</label>
                    <select id="courthouse" name="courthouse">
                        <option value="">Tümü</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="department">Mahkeme</label>
                    <select id="department" name="department" onchange="updateCourtNumbers(this.value)">
                        <option value="">Tümü</option>
                    </select>
                </div>

                <div class="input-group" id="court-number-container">
                    <label for="court-number">Numaralı Mahkeme</label>
                    <select id="court-number" name="court-number">
                        <option value="">Tümü</option>
                    </select>
                </div>
            </div>
            
            <!-- Sağ Sütun -->
            <div class="form-column">
                <div class="form-row">
                    <div class="input-group">
                        <label for="year">Yıl</label>
                        <input type="number" id="year" name="year">
                    </div>
                    <div class="input-group">
                        <label for="case-number">Esas No</label>
                        <input type="text" id="case-number" name="case-number">
                    </div>
                </div>
                <div class="input-group">
                    <label for="client-name">Müvekkil Adı</label>
                    <input type="text" id="client-name" name="client-name">
                </div>
                <div class="input-group">
                    <label for="status">Dosya Durumu</label>
                    <select id="status" name="status">
                        <option value="">Tümü</option>
                        <option value="Aktif">Aktif</option>
                        <option value="Kapalı">Kapalı</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="search-button-container">
            <button type="submit" class="btn">Ara</button>
        </div>
    </form>
</div>

<table class="data-table">
    <thead>
        <tr>
            <th>Dosya Türü</th>
            <th>Yıl</th>
            <th>Esas No</th>
            <th>Müvekkil Adı</th>
            <th>Durum</th>
            <th>İşlemler</th>
        </tr>
    </thead>
    <tbody>
        {% for case_file in case_files %}
        <tr data-case-id="{{ case_file.id }}">
            <td class="case-type">
                <div class="file-type-details">
                    <div class="main-type">{{ case_file.file_type|title }}</div>
                    <div class="sub-details">
                        <small>{{ case_file.courthouse }}</small>
                        <small>{{ case_file.department }}</small>
                    </div>
                </div>
            </td>
            <td>{{ case_file.year }}</td>
            <td class="case-number">{{ case_file.case_number }}</td>
            <td class="client-name">{{ case_file.client_name }}</td>
            <td>
                <span class="case-status status-text {% if case_file.status == 'Aktif' %}status-active{% else %}status-closed{% endif %}">
                    {{ case_file.status }}
                </span>
            </td>
            <td>
                <button class="action-btn view-btn" onclick="showDetails('{{ case_file.id }}')" title="Dosya Detayları">
                    <i class="material-icons">visibility</i>
                </button>
                <span style="color: #dee2e6; margin: 0 8px;">|</span>
                <button class="action-btn delete-btn" onclick="deleteCase('{{ case_file.id }}')" title="Dosyayı Sil">
                    <i class="material-icons">delete</i>
                </button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- Dosya Detay Modalı -->
<div id="fileDetailModal" class="file-detail-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Dosya Detayları</h2>
            <button class="close-btn" onclick="closeDetailModal()">
                <i class="material-icons">close</i>
            </button>
        </div>
        
        <div class="modal-body">
            <!-- Temel Bilgiler -->
            <div class="detail-section basic-info">
                <div class="info-row">
                    <div class="info-group">
                        <label>DOSYA TÜRÜ</label>
                        <span id="detailFileType"></span>
                    </div>
                    <div class="info-group">
                        <label>ADLİYE</label>
                        <span id="detailCourthouse"></span>
                    </div>
                    <div class="info-group">
                        <label>MAHKEME</label>
                        <span id="detailDepartment"></span>
                    </div>
                    <div class="info-group">
                        <label>DOSYA NUMARASI</label>
                        <span id="detailCaseNumber"></span>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-group">
                        <label>MÜVEKKİL</label>
                        <span id="detailClientName"></span>
                    </div>
                    <div class="info-group">
                        <label>TELEFON</label>
                        <span id="detailPhoneNumber"></span>
                    </div>
                    <div class="info-group">
                        <label>DURUM</label>
                        <span id="detailStatus"></span>
                    </div>
                    <div class="info-group">
                        <label>AÇILIŞ TARİHİ</label>
                        <span id="detailOpenDate"></span>
                    </div>
                </div>
                <div class="info-row">
                    <div class="info-group">
                        <label>SONRAKİ DURUŞMA</label>
                        <div class="hearing-info">
                            <span id="detailNextHearing"></span>
                            <span class="hearing-separator">-</span>
                            <span id="detailHearingTime"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dosya Açıklaması -->
            <div class="detail-section">
                <div class="section-header">
                    <h3>Dosya Açıklaması</h3>
                    <button class="btn edit-btn" onclick="editDescription()" title="Açıklama Düzenle">
                        <i class="material-icons">edit</i>
                    </button>
                </div>
                <div class="description-container">
                    <div id="descriptionDisplay">
                        <p id="detailDescription">Açıklama bulunmuyor.</p>
                    </div>
                    <div id="descriptionEdit" style="display: none;">
                        <textarea id="editDescriptionText" rows="4" class="description-textarea"></textarea>
                        <div class="description-actions">
                            <button class="btn secondary" onclick="cancelEditDescription()">İptal</button>
                            <button class="btn primary" onclick="saveDescription()">Kaydet</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Masraflar -->
            <div class="detail-section">
                <div class="section-header">
                    <h3>Masraflar</h3>
                    <button class="btn primary" onclick="showExpenseModal()">
                        <i class="material-icons">add</i> Masraf Ekle
                    </button>
                </div>
                <div id="editExpensesList" class="expenses-list"></div>
            </div>

            <!-- Belgeler -->
            <div class="detail-section">
                <div class="section-header">
                    <h3>Belgeler</h3>
                    <button class="btn primary" onclick="showUploadModal()">
                        <i class="material-icons">upload</i> Belge Yükle
                    </button>
                </div>
                <div id="documentsList" class="documents-list"></div>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn secondary" onclick="closeDetailModal()">Kapat</button>
            <button class="btn primary" onclick="editCase(currentCaseId)">Düzenle</button>
        </div>
    </div>
</div>

<style>
/* Modal ana stilleri */
.file-detail-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    justify-content: center;
    align-items: center;
    padding: 20px;
}

.modal-content {
    background: white;
    width: 95%;
    max-width: 1200px;
    max-height: 90vh;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.modal-header {
    padding: 20px 25px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    border-radius: 12px 12px 0 0;
}

.modal-header h2 {
    margin: 0;
    font-size: 1.4rem;
    color: #2c3e50;
    font-weight: 600;
}

.modal-body {
    flex: 1;
    overflow-y: auto;
    padding: 25px;
}

/* Temel bilgiler bölümü */
.basic-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 25px;
    border: 1px solid #e9ecef;
}

.info-row {
    display: flex;
    gap: 20px;
    margin-bottom: 15px;
}

.info-row:last-child {
    margin-bottom: 0;
}

.info-group {
    flex: 1;
    min-width: 0;
}

.info-group label {
    display: block;
    font-size: 0.8rem;
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.info-group span {
    display: block;
    font-size: 1rem;
    color: #2c3e50;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Duruşma bilgileri için özel stiller */
.hearing-info {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 4px 0;
}

.hearing-info span {
    color: #2c3e50;
    font-weight: normal;
}

.hearing-separator {
    color: #6c757d !important;
    font-weight: normal !important;
}

/* Durum için özel stiller */
.file-status {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 500;
}

.file-status.active {
    background-color: #e8f5e9;
    color: #2e7d32;
}

.file-status.closed {
    background-color: #ffebee;
    color: #c62828;
}

/* Bölüm başlıkları */
.detail-section {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 25px;
    border: 1px solid #e9ecef;
}

.detail-section h3 {
    font-size: 1.1rem;
    color: #2c3e50;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 1px solid #e9ecef;
    font-weight: 600;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

/* Butonlar */
.btn {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn.primary {
    background: #1a237e;
    color: white;
}

.btn.primary:hover {
    background: #0d1b6e;
}

.btn.secondary {
    background: #e9ecef;
    color: #2c3e50;
}

.btn.secondary:hover {
    background: #dee2e6;
}

/* Modal footer */
.modal-footer {
    padding: 20px 25px;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 15px;
    background: #f8f9fa;
    border-radius: 0 0 12px 12px;
}

/* Butonlar için yeni renk */
:root {
    --primary-blue: #2196F3;  /* Daha soft bir mavi */
    --primary-hover: #1976D2;
    --light-blue-bg: #E3F2FD;
}

/* Düzenleme modalı için stiller */
#editModal .modal-content {
    background: white;
    width: 95%;
    max-width: 1200px;
    max-height: 90vh;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

#editModal .modal-body {
    padding: 25px;
}

#editModal .detail-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 25px;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 25px;
    border: 1px solid #e9ecef;
}

#editModal .detail-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

#editModal .detail-group label {
    font-size: 0.8rem;
    font-weight: 600;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

#editModal .detail-group input,
#editModal .detail-group select,
#editModal .detail-group textarea {
    padding: 8px 12px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    font-size: 0.95rem;
    color: #2c3e50;
    background: white;
}

#editModal .detail-group input:focus,
#editModal .detail-group select:focus,
#editModal .detail-group textarea:focus {
    border-color: var(--primary-blue);
    outline: none;
    box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
}

#editModal .detail-section {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 25px;
    border: 1px solid #e9ecef;
}

#editModal .detail-section h3 {
    font-size: 1.1rem;
    color: #2c3e50;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e9ecef;
    font-weight: 600;
}

#editModal textarea {
    width: 100%;
    min-height: 100px;
    resize: vertical;
}

/* Butonları güncelle */
.btn.primary {
    background: var(--primary-blue) !important;
    color: white !important;
}

.btn.primary:hover {
    background: var(--primary-hover) !important;
}

/* Duruşma tarihi ve saati için özel stil */
.hearing-datetime {
    display: flex;
    gap: 10px;
}

.hearing-datetime input[type="date"] {
    flex: 2;
}

.hearing-datetime input[type="time"] {
    flex: 1;
}

/* Aktif/Kapalı durumu için badge stilleri */
.status-badge {
    padding: 4px 12px;
    border-radius: 4px;
    font-weight: 500;
    font-size: 0.9rem;
}

.status-badge.active {
    background: #E8F5E9;
    color: #2E7D32;
}

.status-badge.closed {
    background: #FFEBEE;
    color: #C62828;
}

/* Modal header ve footer */
.modal-header, .modal-footer {
    background: #f8f9fa;
    padding: 20px 25px;
}

.modal-header {
    border-radius: 12px 12px 0 0;
}

.modal-footer {
    border-radius: 0 0 12px 12px;
}

/* Masraflar bölümü stilleri */
.expenses-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.expense-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
}

.expense-info {
    display: grid;
    grid-template-columns: repeat(4, auto);
    gap: 20px;
    align-items: center;
}

.expense-type {
    font-weight: 500;
    color: #2c3e50;
}

.expense-amount {
    color: #2196F3;
    font-weight: 600;
}

.expense-date {
    color: #6c757d;
    font-size: 0.9rem;
}

.expense-description {
    color: #495057;
    font-size: 0.9rem;
}

/* Belge listesi stilleri */
.documents-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.document-item {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    overflow: hidden;
}

.document-type-header {
    background: #e3f2fd;
    color: #1976d2;
    padding: 8px 15px;
    font-weight: 500;
    font-size: 0.9rem;
}

.document-content {
    padding: 15px;
}

.document-main {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.document-info {
    display: flex;
    align-items: center;
    gap: 15px;
}

.document-info i {
    color: #2196F3;
    font-size: 24px;
}

.document-name {
    font-weight: 500;
    color: #2c3e50;
}

.document-date {
    color: #6c757d;
    font-size: 0.9rem;
}

.document-actions {
    display: flex;
    gap: 8px;
}

.document-actions .btn {
    padding: 6px;
}

.document-actions .btn i {
    font-size: 20px;
}

/* Açıklama bölümü stilleri */
.description-container {
    position: relative;
}

.edit-btn {
    background: none;
    border: none;
    padding: 4px;
    color: #757575;
    transition: all 0.2s ease;
}

.edit-btn:hover {
    color: var(--primary-blue);
}

.edit-btn i {
    font-size: 20px;
}

.description-textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    font-size: 0.95rem;
    color: #2c3e50;
    resize: vertical;
    min-height: 100px;
    margin-bottom: 10px;
}

.description-textarea:focus {
    border-color: var(--primary-blue);
    outline: none;
    box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
}

.description-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 10px;
}

#detailDescription {
    margin: 0;
    padding: 12px;
    background: #f8f9fa;
    border-radius: 6px;
    min-height: 100px;
}

.action-btn {
    background: none;
    border: none;
    padding: 6px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.action-btn i {
    font-size: 20px;
}

.view-btn {
    color: #2196F3;
}

.view-btn:hover {
    color: #1976D2;
}

.delete-btn {
    color: #757575;
}

.delete-btn:hover {
    color: #dc3545;
}

/* Masraf ekleme modalı içeriğini güncelle */
.modal-content expense-modal {
    max-width: 800px;
}

.expense-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
    margin-bottom: 20px;
}

.expense-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.expense-group.full-width {
    grid-column: 1 / -1;
}

.expense-type-wrapper {
    position: relative;
}

.amount-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.currency-symbol {
    position: absolute;
    right: 10px;
    color: #666;
}

.status-toggle {
    position: relative;
    width: 100%;
}

.toggle-input {
    display: none;
}

.toggle-label {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 5px 10px;
    background: #f1f1f1;
    border-radius: 20px;
    cursor: pointer;
    position: relative;
    transition: all 0.3s ease;
}

.toggle-label::before {
    content: '';
    position: absolute;
    width: 50%;
    height: 85%;
    border-radius: 15px;
    background: white;
    left: 3px;
    transition: all 0.3s ease;
}

.toggle-input:checked + .toggle-label::before {
    left: calc(50% - 3px);
}

.toggle-input:checked + .toggle-label {
    background: var(--success-color);
    color: white;
}

.toggle-text-off,
.toggle-text-on {
    position: relative;
    z-index: 1;
    font-size: 0.9rem;
    padding: 0 5px;
}

.toggle-input:checked + .toggle-label .toggle-text-off {
    color: rgba(255,255,255,0.5);
}

.toggle-input:not(:checked) + .toggle-label .toggle-text-on {
    color: rgba(0,0,0,0.5);
}

.preview-modal-content {
    width: 95vw;
    height: 95vh;
    max-width: none;
}

.preview-modal-body {
    padding: 0;
    height: calc(95vh - 120px);
    display: flex;
    justify-content: center;
    align-items: center;
    background: #f5f5f5;
}

.document-preview-container {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: auto;
}

.document-preview-container iframe {
    width: 100%;
    height: 100%;
    border: none;
}

.document-preview-container img {
    max-width: none;
    max-height: none;
    object-fit: contain;
}

.expense-status {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 500;
    margin-right: 10px;
}

.status-paid {
    color: #2e7d32;
}

.status-unpaid {
    color: #c62828;
}

.expense-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.expense-actions .btn {
    padding: 4px;
    min-width: auto;
}

.expense-actions .btn i {
    font-size: 18px;
}

.document-details {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.document-original-name {
    font-size: 0.8rem;
    color: #666;
}

.document-name {
    font-weight: 500;
    color: #2c3e50;
}

.document-date {
    font-size: 0.85rem;
    color: #666;
}

/* İşlem butonları için stil güncellemesi */
.actions {
    display: flex;
    gap: 8px;
    justify-content: center;
    align-items: center;
}

.action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 6px;
    border: none;
    background: none;
    cursor: pointer;
    transition: all 0.2s ease;
}

/* Ayırıcı çizgiyi kaldır */
.actions span {
    display: none;
}
</style>

<script>
let currentCaseId = null;
let currentExpenses = [];

// Backend'den gelen tüm adliye verisi
const allCourthousesData = JSON.parse('{{ all_courthouses | safe }}');

// Orijinal Birim seçenekleri
const originalDepartments = [
    'Asliye Hukuk Mahkemesi', 'Sulh Hukuk Mahkemesi', 'İş Mahkemesi', 
    'Aile Mahkemesi', 'Ticaret Mahkemesi', 'İcra Hukuk Mahkemesi', 
    'Tüketici Mahkemesi', 'Fikri ve Sınai Haklar Mahkemesi',
    'Asliye Ceza Mahkemesi', 'Ağır Ceza Mahkemesi', 'Sulh Ceza Hakimliği', 
    'İcra Dairesi'
];

// İstanbul'a özel adliyeler
const istanbulSpecificCourthouses = [
    "İstanbul Anadolu Adliyesi (Kartal)",
    "İstanbul Adliyesi (Çağlayan)",
    "Bakırköy Adliyesi",
    "Büyükçekmece Adliyesi",
    "Gaziosmanpaşa Adliyesi",
    "Küçükçekmece Adliyesi",
    "Silivri Adliyesi",
    "Çatalca Adliyesi",
    "Üsküdar Adliyesi",
    "Adalar Adliyesi",
    "Sarıyer Adliyesi"
];

document.addEventListener('DOMContentLoaded', function() {
    // Sayfa yüklendiğinde başlangıç durumunu ayarla
    populateDepartments();
    handleFileTypeChange();
    
    // Eğer şehir seçiliyse adliye listesini güncelle
    const citySelect = document.getElementById('city');
    if (citySelect && citySelect.value) {
        updateCourthouses();
    }
    
    // URL'den show_details parametresini al
    const urlParams = new URLSearchParams(window.location.search);
    const showDetailsId = urlParams.get('show_details');
    
    // Eğer show_details parametresi varsa, dosya detaylarını göster
    if (showDetailsId) {
        showDetails(showDetailsId);
    }
});

function updateCourthouses() {
    const citySelect = document.getElementById('city');
    const courthouseSelect = document.getElementById('courthouse');
    const selectedCity = citySelect.value;
    
    // Adliye listesini temizle, "Tümü" seçeneğini koru
    courthouseSelect.innerHTML = '<option value="">Tümü</option>';
    
    // Eğer İstanbul seçiliyse, özel İstanbul adliyelerini ekle
    if (selectedCity === 'İstanbul') {
        istanbulSpecificCourthouses.forEach(courthouse => {
            const option = document.createElement('option');
            option.value = courthouse;
            option.textContent = courthouse;
            courthouseSelect.appendChild(option);
        });
    }
    
    // Seçili şehir için adliyeleri ekle (eğer İstanbul değilse veya İstanbul'a ek adliyeler varsa)
    if (selectedCity && allCourthousesData[selectedCity]) {
        allCourthousesData[selectedCity].forEach(courthouse => {
            const option = document.createElement('option');
            option.value = courthouse;
            option.textContent = courthouse;
            courthouseSelect.appendChild(option);
        });
    }
}

function handleFileTypeChange() {
    const fileTypeSelect = document.getElementById('file-type');
    const selectedFileType = fileTypeSelect.value.toLowerCase();
    
    // Mahkeme listesini temizle ve yeniden doldur
    populateDepartments(selectedFileType);
    
    // Dosya türlerine göre alanları devre dışı bırak/etkinleştir
    const citySelect = document.getElementById('city');
    const courthouseSelect = document.getElementById('courthouse');
    const departmentSelect = document.getElementById('department');
    const courtNumberContainer = document.getElementById('court-number-container');
    
    // "Tümü" seçeneği için hepsini etkinleştir
    if (!selectedFileType) {
        citySelect.disabled = false;
        courthouseSelect.disabled = false;
        departmentSelect.disabled = false;
        return;
    }
    
    // ARABULUCULUK, AİHM ve AYM için şehir ve adliye devre dışı
    const disableCourthouseAndCity = ['arabuluculuk', 'aihm', 'aym'].includes(selectedFileType);
    // Savcılık için sadece mahkeme devre dışı
    const disableDepartment = ['arabuluculuk', 'aihm', 'aym', 'savcilik'].includes(selectedFileType);
    
    citySelect.disabled = disableCourthouseAndCity;
    courthouseSelect.disabled = disableCourthouseAndCity;
    departmentSelect.disabled = disableDepartment;
    
    // Alanlar devre dışı bırakıldıysa, değerlerini temizle
    if (disableCourthouseAndCity) {
        citySelect.value = '';
        courthouseSelect.innerHTML = '<option value="">Tümü</option>';
    }
    
    if (disableDepartment) {
        departmentSelect.value = '';
        courtNumberContainer.style.display = 'none';
    }
    
    // Şehir seçiliyse adliye listesini güncelle
    if (!disableCourthouseAndCity && citySelect.value) {
        updateCourthouses();
    }
    
    // Birim seçimi değiştiyse mahkeme numaralarını güncelle
    if (departmentSelect.value) {
        if (selectedFileType === 'icra' && departmentSelect.value === 'İcra Dairesi') {
            updateIcraDaireleri();
        } else {
            updateCourtNumbers(departmentSelect.value);
        }
    } else {
        courtNumberContainer.style.display = 'none';
    }
}

function populateDepartments(fileType) {
    const departmentSelect = document.getElementById('department');
    
    // Listeyi temizle, "Tümü" seçeneğini koru
    departmentSelect.innerHTML = '<option value="">Tümü</option>';
    
    // Dosya türüne göre mahkemeleri ekle
    if (fileType === 'hukuk') {
        // Hukuk mahkemeleri
        const hukukMahkemeleri = [
            'Asliye Hukuk Mahkemesi',
            'Sulh Hukuk Mahkemesi',
            'İş Mahkemesi',
            'Aile Mahkemesi',
            'Ticaret Mahkemesi',
            'İcra Hukuk Mahkemesi',
            'Tüketici Mahkemesi',
            'Fikri ve Sınai Haklar Mahkemesi'
        ];
        
        hukukMahkemeleri.forEach(mahkeme => {
            const option = document.createElement('option');
            option.value = mahkeme;
            option.textContent = mahkeme;
            departmentSelect.appendChild(option);
        });
    } else if (fileType === 'ceza') {
        // Ceza mahkemeleri
        const cezaMahkemeleri = [
            'Asliye Ceza Mahkemesi',
            'Ağır Ceza Mahkemesi',
            'Sulh Ceza Hakimliği'
        ];
        
        cezaMahkemeleri.forEach(mahkeme => {
            const option = document.createElement('option');
            option.value = mahkeme;
            option.textContent = mahkeme;
            departmentSelect.appendChild(option);
        });
    } else if (fileType === 'icra') {
        // İcra Dairesi
        const option = document.createElement('option');
        option.value = 'İcra Dairesi';
        option.textContent = 'İcra Dairesi';
        departmentSelect.appendChild(option);
        
        // İcra Dairesi seçilirse numaralandırma değişir
        departmentSelect.onchange = function() {
            if (this.value === 'İcra Dairesi') {
                updateIcraDaireleri();
            } else {
                document.getElementById('court-number-container').style.display = 'none';
            }
        };
    } else if (!fileType || fileType === '') {
        // Hiçbir filtre seçilmediğinde tüm mahkemeleri göster
        originalDepartments.forEach(dept => {
            const option = document.createElement('option');
            option.value = dept;
            option.textContent = dept;
            departmentSelect.appendChild(option);
        });
    }
    
    // Mahkeme seçildiğinde numaralı mahkemeyi güncelle
    departmentSelect.onchange = function() {
        const fileType = document.getElementById('file-type').value.toLowerCase();
        if (fileType === 'icra' && this.value === 'İcra Dairesi') {
            updateIcraDaireleri();
        } else {
            updateCourtNumbers(this.value);
        }
    };
}

// İcra dairelerini güncelle (1-30 arası)
function updateIcraDaireleri() {
    const courtNumberContainer = document.getElementById('court-number-container');
    const courtNumberSelect = document.getElementById('court-number');
    
    // İcra daireleri listesini temizle
    courtNumberSelect.innerHTML = '<option value="">Tümü</option>';
    
    // İcra dairelerini ekle (1-30)
    for (let i = 1; i <= 30; i++) {
        const option = document.createElement('option');
        option.value = `${i}. İcra Dairesi`;
        option.textContent = `${i}. İcra Dairesi`;
        courtNumberSelect.appendChild(option);
    }
    
    courtNumberContainer.style.display = 'flex';
}

function updateCourtNumbers(department) {
    const courtNumberContainer = document.getElementById('court-number-container');
    const courtNumberSelect = document.getElementById('court-number');
    
    // Mahkeme numaralarını temizle
    courtNumberSelect.innerHTML = '<option value="">Tümü</option>';
    
    // İcra Dairesi zaten numaralı olduğu için dışarıda bırak
    if (!department || department === '' || department.includes('İcra Dairesi')) {
        courtNumberContainer.style.display = 'none';
        return;
    }
    
    // Adliye ve şehre göre mahkeme sayısını belirle
    const citySelect = document.getElementById('city');
    const courthouseSelect = document.getElementById('courthouse');
    const selectedCity = citySelect.value;
    const selectedCourthouse = courthouseSelect.value;
    
    // Varsayılan olarak her mahkemeden 30 tane
    let maxCourtNumber = 30;
    
    // İstanbul ve belirli adliyeler için daha fazla mahkeme
    if (selectedCity === 'İstanbul') {
        if (selectedCourthouse.includes('Anadolu') || selectedCourthouse.includes('Çağlayan')) {
            if (department === 'Asliye Hukuk Mahkemesi' || 
                department === 'Asliye Ceza Mahkemesi' || 
                department === 'İş Mahkemesi') {
                maxCourtNumber = 50;
            } else if (department === 'Ağır Ceza Mahkemesi') {
                maxCourtNumber = 15;
            }
        } else if (selectedCourthouse.includes('Bakırköy')) {
            maxCourtNumber = 40;
        }
    } else if (selectedCity === 'Ankara' || selectedCity === 'İzmir') {
        maxCourtNumber = 40;
    }
    
    // Birim adını ekle
    const baseOption = document.createElement('option');
    baseOption.value = department;
    baseOption.textContent = department;
    courtNumberSelect.appendChild(baseOption);
    
    // Numaralı mahkemeleri ekle
    for (let i = 1; i <= maxCourtNumber; i++) {
        const option = document.createElement('option');
        option.value = `${i}. ${department}`;
        option.textContent = `${i}. ${department}`;
        courtNumberSelect.appendChild(option);
    }
    
    courtNumberContainer.style.display = 'flex';
}

// Diğer fonksiyonlar...

function showDetails(caseId) {
    currentCaseId = caseId;
    const modal = document.getElementById('fileDetailModal');
    
    fetch(`/case_details/${caseId}`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Sunucu yanıtı:', data);
                alert('Dosya detayları yüklenirken bir hata oluştu.');
                return;
            }

            // Temel bilgileri doldur
            document.getElementById('detailFileType').textContent = capitalizeFileType(data.file_type);
            document.getElementById('detailCourthouse').textContent = data.courthouse || '-';
            document.getElementById('detailDepartment').textContent = data.department || '-';
            document.getElementById('detailCaseNumber').textContent = data.case_number || '-';
            document.getElementById('detailClientName').textContent = data.client_name || '-';
            document.getElementById('detailPhoneNumber').textContent = data.phone_number || '-';
            
            // Durum bilgisini doldur
            const statusElement = document.getElementById('detailStatus');
            statusElement.textContent = data.status || 'Aktif';
            statusElement.className = 'file-status ' + (data.status === 'Aktif' ? 'active' : 'closed');
            
            // Tarih bilgilerini doldur
            document.getElementById('detailOpenDate').textContent = data.open_date || '-';
            document.getElementById('detailNextHearing').textContent = data.next_hearing || '-';
            document.getElementById('detailHearingTime').textContent = data.hearing_time || '-';
            document.getElementById('detailDescription').textContent = data.description || 'Açıklama bulunmuyor.';

            // Masrafları göster
            if (data.expenses && Array.isArray(data.expenses)) {
                currentExpenses = data.expenses;
                const expensesList = document.getElementById('editExpensesList');
                expensesList.innerHTML = data.expenses.map(expense => `
                    <div class="expense-item">
                        <div class="expense-info">
                            <div class="expense-type">${expense.expense_type}</div>
                            <div class="expense-amount">₺${expense.amount}</div>
                            <div class="expense-date">${expense.date}</div>
                            <div class="expense-description">${expense.description || ''}</div>
                        </div>
                        <div class="expense-actions">
                            <div class="expense-status ${expense.is_paid ? 'status-paid' : 'status-unpaid'}">
                                ${expense.is_paid ? 'Ödendi' : 'Ödenmedi'}
                            </div>
                            <button type="button" class="btn small" onclick="editExpense(${expense.id})">
                                <i class="material-icons">edit</i>
                            </button>
                            <button type="button" class="btn small danger" onclick="deleteExpense(${expense.id})">
                                <i class="material-icons">delete</i>
                            </button>
                        </div>
                    </div>
                `).join('') || '<p>Henüz masraf kaydı bulunmuyor.</p>';
            }

            // Belgeleri göster
            const documentsList = document.getElementById('documentsList');
            if (documentsList && data.documents) {
                documentsList.innerHTML = data.documents.map(doc => {
                    // Dosya adı ve uzantıyı ayır
                    const fileNameParts = doc.filename ? doc.filename.split('.') : ['', ''];
                    const fileName = fileNameParts.slice(0, -1).join('.');
                    const fileExt = fileNameParts[fileNameParts.length - 1];
                    
                    // Orijinal dosya adını al
                    const originalName = doc.filepath ? doc.filepath.split('_').slice(2).join('_') : '';
                    
                    return `
                        <div class="document-item">
                            <div class="document-type-header">
                                ${doc.document_type}
                            </div>
                            <div class="document-content">
                                <div class="document-main">
                                    <div class="document-info">
                                        <i class="material-icons">${getFileIcon(doc.filename || '')}</i>
                                        <div class="document-details">
                                            <span class="document-name">${fileName}</span>
                                            <span class="document-original-name">${originalName}</span>
                                            <span class="document-date">${doc.upload_date}</span>
                                        </div>
                                    </div>
                                    <div class="document-actions">
                                        <button class="btn small" onclick="previewDocument(${doc.id}, '${doc.filename || ''}')" title="Önizle">
                                            <i class="material-icons">visibility</i>
                                        </button>
                                        <button class="btn small" onclick="downloadDocument(${doc.id})" title="İndir">
                                            <i class="material-icons">download</i>
                                        </button>
                                        <button class="btn danger small" onclick="deleteDocument(${doc.id})" title="Sil">
                                            <i class="material-icons">delete</i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('') || '<p>Henüz belge yüklenmemiş.</p>';
            }

            // Modalı göster
            modal.style.display = 'flex';
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Dosya detayları yüklenirken bir hata oluştu: ' + error.message);
        });
}

// Dosya türünü büyük harfe çevir
function capitalizeFileType(fileType) {
    return fileType.charAt(0).toUpperCase() + fileType.slice(1);
}

// Dosya uzantısına göre ikon seç
function getFileIcon(filename) {
    if (!filename) return 'insert_drive_file';
    
    const ext = filename.split('.').pop().toLowerCase();
    switch (ext) {
        case 'pdf': return 'picture_as_pdf';
        case 'doc':
        case 'docx': return 'description';
        case 'jpg':
        case 'jpeg':
        case 'png':
        case 'tiff':
        case 'tif': return 'image';
        case 'txt': return 'article';
        case 'xls':
        case 'xlsx': return 'table_chart';
        case 'zip':
        case 'rar': return 'folder_zip';
        default: return 'insert_drive_file';
    }
}

// Modal kapatma fonksiyonu
function closeDetailModal() {
    const modal = document.getElementById('fileDetailModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Düzenle butonu için fonksiyon
function editCase(caseId) {
    const modal = document.getElementById('fileDetailModal');
    modal.style.display = 'none';
    
    fetch(`/case_details/${caseId}`)
        .then(response => response.json())
        .then(data => {
            // Tarihi YYYY-MM-DD formatına çevir
            const openDate = data.open_date ? data.open_date.split('.').reverse().join('-') : '';
            const nextHearing = data.next_hearing ? data.next_hearing.split('.').reverse().join('-') : '';

            // Şehir ve adliye bilgilerini belirle
            let city = '';
            // Adliye bilgisi varsa hangi şehre ait olduğunu bul
            if (data.courthouse) {
                // İstanbul adliyeleri
                if (istanbulSpecificCourthouses.includes(data.courthouse)) {
                    city = 'İstanbul';
                } else {
                    // Diğer şehirlerde arama yap
                    for (const [cityName, courthouses] of Object.entries(allCourthousesData)) {
                        if (courthouses.includes(data.courthouse)) {
                            city = cityName;
                            break;
                        }
                    }
                }
            }

            const editHtml = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Dosya Düzenle</h2>
                        <button class="close-btn" onclick="closeEditModal()">
                            <i class="material-icons">close</i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="editForm">
                            <div class="detail-grid">
                                <div class="detail-group">
                                    <label>Dosya Türü</label>
                                    <select id="editFileType" disabled>
                                        <option value="hukuk" ${data.file_type === 'hukuk' ? 'selected' : ''}>Hukuk</option>
                                        <option value="ceza" ${data.file_type === 'ceza' ? 'selected' : ''}>Ceza</option>
                                        <option value="icra" ${data.file_type === 'icra' ? 'selected' : ''}>İcra</option>
                                        <option value="savcilik" ${data.file_type === 'savcilik' ? 'selected' : ''}>Savcılık</option>
                                        <option value="ARABULUCULUK" ${data.file_type === 'ARABULUCULUK' ? 'selected' : ''}>Arabuluculuk</option>
                                        <option value="AİHM" ${data.file_type === 'AİHM' ? 'selected' : ''}>AİHM</option>
                                        <option value="AYM" ${data.file_type === 'AYM' ? 'selected' : ''}>AYM</option>
                                    </select>
                                </div>
                                <div class="detail-group">
                                    <label>Şehir</label>
                                    <select id="editCity" disabled>
                                        <option value="">Seçiniz</option>
                                        ${Object.keys(allCourthousesData).map(cityName => 
                                            `<option value="${cityName}" ${city === cityName ? 'selected' : ''}>${cityName}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div class="detail-group">
                                    <label>Adliye</label>
                                    <select id="editCourthouse" disabled>
                                        <option value="">Seçiniz</option>
                                        ${city === 'İstanbul' ? 
                                            istanbulSpecificCourthouses.map(courthouse => 
                                                `<option value="${courthouse}" ${data.courthouse === courthouse ? 'selected' : ''}>${courthouse}</option>`
                                            ).join('') : 
                                            (city && allCourthousesData[city] ? 
                                                allCourthousesData[city].map(courthouse => 
                                                    `<option value="${courthouse}" ${data.courthouse === courthouse ? 'selected' : ''}>${courthouse}</option>`
                                                ).join('') : '')
                                        }
                                    </select>
                                </div>
                                <div class="detail-group">
                                    <label>Mahkeme</label>
                                    <select id="editDepartment" disabled>
                                        <option value="">Seçiniz</option>
                                        ${originalDepartments.map(dept => 
                                            `<option value="${dept}" ${data.department === dept ? 'selected' : ''}>${dept}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            <div class="detail-grid">
                                <div class="detail-group">
                                    <label>Müvekkil Adı</label>
                                    <input type="text" id="editClientName" value="${data.client_name || ''}">
                                </div>
                                <div class="detail-group">
                                    <label>Telefon</label>
                                    <input type="text" id="editPhoneNumber" value="${data.phone_number || ''}">
                                </div>
                                <div class="detail-group">
                                    <label>Dosya Durumu</label>
                                    <select id="editStatus">
                                        <option value="Aktif" ${data.status === 'Aktif' ? 'selected' : ''}>Aktif</option>
                                        <option value="Kapalı" ${data.status === 'Kapalı' ? 'selected' : ''}>Kapalı</option>
                                    </select>
                                </div>
                                <div class="detail-group">
                                    <label>Açılış Tarihi</label>
                                    <input type="date" id="editOpenDate" value="${openDate}" disabled>
                                </div>
                                <div class="detail-group">
                                    <label>Sonraki Duruşma (Opsiyonel)</label>
                                    <div class="hearing-datetime">
                                        <input type="date" id="editNextHearing" value="${nextHearing}">
                                        <input type="time" id="editHearingTime" value="${data.hearing_time || '09:00'}">
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn secondary" onclick="closeEditModal()">İptal</button>
                        <button class="btn primary" onclick="saveChanges(${caseId})">Kaydet</button>
                    </div>
                </div>
            `;
            
            const editModal = document.createElement('div');
            editModal.id = 'editModal';
            editModal.className = 'file-detail-modal';
            editModal.innerHTML = editHtml;
            document.body.appendChild(editModal);
            editModal.style.display = 'flex';
        });
}

// Düzenleme modalında birim seçeneklerini güncelle
function updateEditDepartments() {
    const fileType = document.getElementById('editFileType').value;
    const departmentSelect = document.getElementById('editDepartment');
    const courtNumberContainer = document.getElementById('editCourtNumberContainer');
    
    departmentSelect.innerHTML = '<option value="">Seçiniz</option>';
    
    // Dosya türüne göre birimleri ekle
    if (fileType === 'icra') {
        // İcra dosyaları için sadece icra daireleri
        for (let i = 1; i <= 30; i++) {
            const option = document.createElement('option');
            option.value = `${i}. İcra Dairesi`;
            option.textContent = `${i}. İcra Dairesi`;
            departmentSelect.appendChild(option);
        }
        departmentSelect.disabled = false;
    } else if (fileType && fileType !== 'savcilik' && fileType !== 'ARABULUCULUK' && fileType !== 'AİHM' && fileType !== 'AYM') {
        // Diğer dosya türleri için standart birimleri ekle
        originalDepartments.forEach(dept => {
            if (dept !== 'İcra Dairesi') {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                departmentSelect.appendChild(option);
            }
        });
        departmentSelect.disabled = false;
    } else {
        departmentSelect.disabled = true;
    }

    if (courtNumberContainer) {
        courtNumberContainer.style.display = 'none';
    }
}

// Düzenleme modalında mahkeme numaralarını güncelle
function updateEditCourtNumbers() {
    const department = document.getElementById('editDepartment').value;
    const courtNumberContainer = document.getElementById('editCourtNumberContainer');
    
    if (!department || department === '' || department.includes('İcra Dairesi')) {
        courtNumberContainer.style.display = 'none';
        return;
    }

    const courtNumberSelect = document.getElementById('editCourtNumber');
    courtNumberSelect.innerHTML = '<option value="">Seçiniz</option>';
    
    // Adliye ve şehre göre mahkeme sayısını belirle
    const citySelect = document.getElementById('editCity');
    const courthouseSelect = document.getElementById('editCourthouse');
    const selectedCity = citySelect.value;
    const selectedCourthouse = courthouseSelect.value;
    
    // Varsayılan olarak 30 mahkeme, İstanbul için daha fazla
    let maxCourtNumber = 30;
    
    // İstanbul ve belirli adliyeler için daha fazla mahkeme
    if (selectedCity === 'İstanbul') {
        if (selectedCourthouse.includes('Anadolu') || selectedCourthouse.includes('Çağlayan')) {
            if (department === 'Asliye Hukuk Mahkemesi' || 
                department === 'Asliye Ceza Mahkemesi' || 
                department === 'İş Mahkemesi') {
                maxCourtNumber = 50;
            } else if (department === 'Ağır Ceza Mahkemesi') {
                maxCourtNumber = 15;
            }
        } else if (selectedCourthouse.includes('Bakırköy')) {
            maxCourtNumber = 40;
        }
    } else if (selectedCity === 'Ankara' || selectedCity === 'İzmir') {
        maxCourtNumber = 40;
    }
    
    // Seçili mahkeme adı ekle
    const baseOption = document.createElement('option');
    baseOption.value = department;
    baseOption.textContent = department;
    courtNumberSelect.appendChild(baseOption);
    
    // Numaralı mahkemeleri ekle
    for (let i = 1; i <= maxCourtNumber; i++) {
        const option = document.createElement('option');
        option.value = `${i}. ${department}`;
        option.textContent = `${i}. ${department}`;
        courtNumberSelect.appendChild(option);
    }
    
    courtNumberContainer.style.display = 'block';
}

// Değişiklikleri kaydet
function saveChanges(caseId) {
    const data = {
        file_type: document.getElementById('editFileType').value,
        city: document.getElementById('editCity').value,
        courthouse: document.getElementById('editCourthouse').value,
        department: document.getElementById('editDepartment').value,
        client_name: document.getElementById('editClientName').value,
        phone_number: document.getElementById('editPhoneNumber').value,
        status: document.getElementById('editStatus').value,
        open_date: document.getElementById('editOpenDate').value,
        next_hearing: document.getElementById('editNextHearing').value || null,
        hearing_time: document.getElementById('editHearingTime').value || null
    };

    // Sadece müvekkil adı kontrolü yap
    if (!data.client_name) {
        alert('Lütfen müvekkil adını giriniz.');
        return;
    }

    fetch(`/edit_case/${caseId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Takvim senkronizasyonu için dosya durumunu da gönder
            syncHearingToCalendar(caseId, data.next_hearing, data.hearing_time, data.status);
            
            closeEditModal();
            showDetails(caseId);
        } else {
            throw new Error(result.message || 'Güncelleme sırasında bir hata oluştu');
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('Güncelleme sırasında bir hata oluştu: ' + error.message);
    });
}

// Masraf ekle modalını güncelle
function showExpenseModal() {
    const expenseHtml = `
        <div class="modal-content expense-modal">
            <div class="modal-header">
                <h2>Masraf Ekle</h2>
                <button class="close-btn" onclick="closeExpenseModal()">
                    <i class="material-icons">close</i>
                </button>
            </div>
            <div class="modal-body">
                <form id="expenseForm" class="expense-form">
                    <div class="expense-grid">
                        <div class="expense-group">
                            <label>Masraf Türü</label>
                            <div class="expense-type-wrapper">
                                <select id="expenseType" onchange="handleExpenseTypeChange()" required>
                                    <option value="">Seçiniz</option>
                                    ${expenseTypes.map(type => 
                                        `<option value="${type}">${type}</option>`
                                    ).join('')}
                                </select>
                                <input type="text" id="otherExpenseType" 
                                       class="other-expense-input"
                                       placeholder="Masraf türünü yazınız" 
                                       style="display: none;">
                            </div>
                        </div>
                        
                        <div class="expense-group">
                            <label>Tutar</label>
                            <div class="amount-wrapper">
                                <input type="number" id="expenseAmount" step="0.01" required>
                                <span class="currency-symbol">₺</span>
                            </div>
                        </div>
                        
                        <div class="expense-group">
                            <label>Tarih</label>
                            <input type="date" id="expenseDate" required 
                                   value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        
                        <div class="expense-group">
                            <label>Ödeme Durumu</label>
                            <div class="status-toggle">
                                <input type="checkbox" id="expenseStatus" class="toggle-input">
                                <label for="expenseStatus" class="toggle-label">
                                    <span class="toggle-text-off">Ödenmedi</span>
                                    <span class="toggle-text-on">Ödendi</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="expense-group full-width">
                        <label>Açıklama</label>
                        <textarea id="expenseDescription" rows="3" 
                                  placeholder="Masraf ile ilgili açıklama ekleyin..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeExpenseModal()">İptal</button>
                <button class="btn primary" onclick="saveExpense()">Kaydet</button>
            </div>
        </div>
    `;
    
    const expenseModal = document.createElement('div');
    expenseModal.id = 'expenseModal';
    expenseModal.className = 'file-detail-modal';
    expenseModal.innerHTML = expenseHtml;
    document.body.appendChild(expenseModal);
    expenseModal.style.display = 'flex';
}

// Diğer seçeneği için input alanını göster/gizle
function handleExpenseTypeChange() {
    const expenseType = document.getElementById('expenseType');
    const otherExpenseType = document.getElementById('otherExpenseType');
    
    if (expenseType.value === 'Diğer') {
        otherExpenseType.style.display = 'block';
        otherExpenseType.required = true;
    } else {
        otherExpenseType.style.display = 'none';
        otherExpenseType.required = false;
    }
}

// Masraf kaydetme fonksiyonunu güncelle
function saveExpense() {
    const expenseType = document.getElementById('expenseType');
    const otherExpenseType = document.getElementById('otherExpenseType');
    const amount = document.getElementById('expenseAmount');
    const date = document.getElementById('expenseDate');
    const status = document.getElementById('expenseStatus');
    const description = document.getElementById('expenseDescription');

    // Form validasyonu
    if (!expenseType.value) {
        alert('Lütfen masraf türünü seçiniz.');
        return;
    }
    if (expenseType.value === 'Diğer' && !otherExpenseType.value) {
        alert('Lütfen masraf türünü yazınız.');
        return;
    }
    if (!amount.value || amount.value <= 0) {
        alert('Lütfen geçerli bir tutar giriniz.');
        return;
    }
    if (!date.value) {
        alert('Lütfen tarih seçiniz.');
        return;
    }

    const data = {
        expense_type: expenseType.value === 'Diğer' ? otherExpenseType.value : expenseType.value,
        amount: parseFloat(amount.value),
        date: date.value,
        is_paid: status.checked,
        description: description.value || ''
    };

    fetch(`/add_expense/${currentCaseId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeExpenseModal();
            showDetails(currentCaseId);
        } else {
            throw new Error(result.message || 'Masraf eklenirken bir hata oluştu');
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('Masraf eklenirken bir hata oluştu: ' + error.message);
    });
}

// Belge yükle butonu için fonksiyon
function showUploadModal() {
    const uploadHtml = `
        <div class="modal-content">
            <div class="modal-header">
                <h2>Belge Yükle</h2>
                <button class="close-btn" onclick="closeUploadModal()">
                    <i class="material-icons">close</i>
                </button>
            </div>
            <div class="modal-body">
                <form id="uploadForm">
                    <div class="detail-group">
                        <label>Belge Türü</label>
                        <select id="documentType" required>
                            <option value="">Seçiniz</option>
                            ${documentTypes.map(type => 
                                `<option value="${type}">${type}</option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="detail-group">
                        <label>Belge</label>
                        <input type="file" id="documentFile" required>
                    </div>
                    <div class="detail-group">
                        <label>Belge Adı (Opsiyonel)</label>
                        <input type="text" id="documentName" placeholder="Belgeye özel bir isim verin">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeUploadModal()">İptal</button>
                <button class="btn primary" onclick="uploadDocument()">Yükle</button>
            </div>
        </div>
    `;
    
    const uploadModal = document.createElement('div');
    uploadModal.id = 'uploadModal';
    uploadModal.className = 'file-detail-modal';
    uploadModal.innerHTML = uploadHtml;
    document.body.appendChild(uploadModal);
    uploadModal.style.display = 'flex';
}

// Belge yükleme fonksiyonunu güncelle
function uploadDocument() {
    const documentType = document.getElementById('documentType');
    const fileInput = document.getElementById('documentFile');
    const documentName = document.getElementById('documentName');
    
    if (!documentType.value) {
        alert('Lütfen belge türünü seçiniz.');
        return;
    }
    
    if (!fileInput.files.length) {
        alert('Lütfen bir belge seçiniz.');
        return;
    }

    const formData = new FormData();
    formData.append('document', fileInput.files[0]);
    formData.append('document_type', documentType.value);
    if (documentName.value) {
        formData.append('document_name', documentName.value);
    }

    fetch(`/upload_document/${currentCaseId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeUploadModal();
            showDetails(currentCaseId);
        } else {
            throw new Error(result.message || 'Belge yüklenirken bir hata oluştu');
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('Belge yüklenirken bir hata oluştu: ' + error.message);
    });
}

// Belge önizleme fonksiyonu
function previewDocument(docId, filename) {
    // Orijinal dosya uzantısını bul
    let ext = '';
    // Dosya adında nokta varsa son noktadan sonrasını al
    if (filename.includes('.')) {
        ext = filename.split('.').pop().toLowerCase();
    } else {
        // Eğer özel isim verilmiş ve uzantı yoksa, sunucudan dosya bilgisini al
        fetch(`/get_document_info/${docId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.original_filename) {
                    ext = data.original_filename.split('.').pop().toLowerCase();
                    showPreviewModal(docId, filename, ext);
                } else {
                    alert('Dosya türü belirlenemedi.');
                }
            })
            .catch(error => {
                console.error('Hata:', error);
                alert('Dosya bilgisi alınırken bir hata oluştu.');
            });
        return;
    }
    
    showPreviewModal(docId, filename, ext);
}

// Önizleme modalını güncelle
function showPreviewModal(docId, filename, ext) {
    const previewHtml = `
        <div class="modal-content preview-modal-content">
            <div class="modal-header">
                <h2>${filename}</h2>
                <button class="close-btn" onclick="closePreviewModal()">
                    <i class="material-icons">close</i>
                </button>
            </div>
            <div class="modal-body preview-modal-body">
                <div class="document-preview-container">
                    ${ext === 'pdf' ? 
                        `<iframe id="previewFrame" src="/preview_document/${docId}" frameborder="0"></iframe>` :
                        `<img src="/preview_document/${docId}" alt="Belge önizleme">`
                    }
                </div>
            </div>
        </div>
    `;
    
    const previewModal = document.createElement('div');
    previewModal.id = 'previewModal';
    previewModal.className = 'file-detail-modal';
    previewModal.innerHTML = previewHtml;
    document.body.appendChild(previewModal);
    previewModal.style.display = 'flex';
}

function closePreviewModal() {
    const modal = document.getElementById('previewModal');
    if (modal) {
        modal.remove();
    }
}

// Belge indirme fonksiyonu
function downloadDocument(docId) {
    const link = document.createElement('a');
    link.href = `/download_document/${docId}`;
    link.target = '_blank';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Belge silme fonksiyonu
function deleteDocument(docId) {
    if (confirm('Bu belgeyi silmek istediğinizden emin misiniz?')) {
        fetch(`/delete_document/${docId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Sunucu hatası');
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                showDetails(currentCaseId); // Belge listesini güncelle
            } else {
                throw new Error(result.message || 'Belge silinirken bir hata oluştu');
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Belge silinirken bir hata oluştu: ' + error.message);
        });
    }
}

// Modal kapatma fonksiyonları
function closeEditModal() {
    const modal = document.getElementById('editModal');
    if (modal) {
        modal.remove();
    }
}

function closeExpenseModal() {
    const modal = document.getElementById('expenseModal');
    if (modal) {
        modal.remove();
    }
}

function closeUploadModal() {
    const modal = document.getElementById('uploadModal');
    if (modal) {
        modal.remove();
    }
}

// Masraf silme fonksiyonu
function deleteExpense(expenseId) {
    if (confirm('Bu masrafı silmek istediğinizden emin misiniz?')) {
        fetch(`/delete_expense/${expenseId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Masraf listesini güncelle
                showDetails(currentCaseId);
            } else {
                throw new Error(result.message || 'Masraf silinirken bir hata oluştu');
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Masraf silinirken bir hata oluştu: ' + error.message);
        });
    }
}

// Açıklama düzenleme fonksiyonlarını ekle
function editDescription() {
    const displayDiv = document.getElementById('descriptionDisplay');
    const editDiv = document.getElementById('descriptionEdit');
    const textarea = document.getElementById('editDescriptionText');
    const currentText = document.getElementById('detailDescription').textContent;
    
    textarea.value = currentText === 'Açıklama bulunmuyor.' ? '' : currentText;
    displayDiv.style.display = 'none';
    editDiv.style.display = 'block';
    textarea.focus();
}

function cancelEditDescription() {
    const displayDiv = document.getElementById('descriptionDisplay');
    const editDiv = document.getElementById('descriptionEdit');
    
    displayDiv.style.display = 'block';
    editDiv.style.display = 'none';
}

function saveDescription() {
    const newDescription = document.getElementById('editDescriptionText').value;
    
    fetch(`/update_description/${currentCaseId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            description: newDescription
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            document.getElementById('detailDescription').textContent = 
                newDescription || 'Açıklama bulunmuyor.';
            cancelEditDescription();
        } else {
            throw new Error(result.message || 'Açıklama güncellenirken bir hata oluştu');
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('Açıklama güncellenirken bir hata oluştu: ' + error.message);
    });
}

// Duruşma bilgilerini takvime senkronize et
function syncHearingToCalendar(caseId, hearingDate, hearingTime, status) {
    fetch('/sync_hearing_to_calendar', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            case_id: caseId,
            hearing_date: hearingDate,
            hearing_time: hearingTime || '09:00',
            status: status
        })
    })
    .then(response => response.json())
    .then(result => {
        if (!result.success) {
            throw new Error(result.message || 'Takvim senkronizasyonu başarısız');
        }
    })
    .catch(error => {
        console.error('Takvim senkronizasyonu hatası:', error);
        alert('Duruşma bilgileri güncellenirken bir hata oluştu: ' + error.message);
    });
}

// Dosya silme fonksiyonu
function deleteCase(caseId) {
    if (confirm('Bu dosyayı silmek istediğinizden emin misiniz?')) {
        fetch(`/delete_case/${caseId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                // Tablodan ilgili satırı kaldır
                const row = document.querySelector(`tr[data-case-id="${caseId}"]`);
                if (row) {
                    row.remove();
                }
            } else {
                throw new Error(result.message || 'Dosya silinirken bir hata oluştu');
            }
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('Dosya silinirken bir hata oluştu: ' + error.message);
        });
    }
}

// Masraf düzenleme fonksiyonunu ekle
function editExpense(expenseId) {
    const expense = currentExpenses.find(e => e.id === expenseId);
    if (!expense) return;

    // Tarihi YYYY-MM-DD formatına çevir
    const formattedDate = expense.date.split('.').reverse().join('-');

    const expenseHtml = `
        <div class="modal-content expense-modal">
            <div class="modal-header">
                <h2>Masraf Düzenle</h2>
                <button class="close-btn" onclick="closeExpenseModal()">
                    <i class="material-icons">close</i>
                </button>
            </div>
            <div class="modal-body">
                <form id="expenseForm" class="expense-form">
                    <div class="expense-grid">
                        <div class="expense-group">
                            <label>Masraf Türü</label>
                            <div class="expense-type-wrapper">
                                <select id="expenseType" onchange="handleExpenseTypeChange()" required>
                                    <option value="">Seçiniz</option>
                                    ${expenseTypes.map(type => 
                                        `<option value="${type}" ${expense.expense_type === type ? 'selected' : ''}>${type}</option>`
                                    ).join('')}
                                </select>
                                <input type="text" id="otherExpenseType" 
                                       class="other-expense-input"
                                       placeholder="Masraf türünü yazınız" 
                                       style="display: none;"
                                       value="${expense.expense_type}">
                            </div>
                        </div>
                        
                        <div class="expense-group">
                            <label>Tutar</label>
                            <div class="amount-wrapper">
                                <input type="number" id="expenseAmount" step="0.01" required value="${expense.amount}">
                                <span class="currency-symbol">₺</span>
                            </div>
                        </div>
                        
                        <div class="expense-group">
                            <label>Tarih</label>
                            <input type="date" id="expenseDate" required value="${formattedDate}">
                        </div>
                        
                        <div class="expense-group">
                            <label>Ödeme Durumu</label>
                            <div class="status-toggle">
                                <input type="checkbox" id="expenseStatus" class="toggle-input" ${expense.is_paid ? 'checked' : ''}>
                                <label for="expenseStatus" class="toggle-label">
                                    <span class="toggle-text-off">Ödenmedi</span>
                                    <span class="toggle-text-on">Ödendi</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="expense-group full-width">
                        <label>Açıklama</label>
                        <textarea id="expenseDescription" rows="3" 
                                  placeholder="Masraf ile ilgili açıklama ekleyin...">${expense.description || ''}</textarea>
                    </div>
                    <input type="hidden" id="expenseId" value="${expense.id}">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" onclick="closeExpenseModal()">İptal</button>
                <button class="btn primary" onclick="updateExpense()">Güncelle</button>
            </div>
        </div>
    `;
    
    const expenseModal = document.createElement('div');
    expenseModal.id = 'expenseModal';
    expenseModal.className = 'file-detail-modal';
    expenseModal.innerHTML = expenseHtml;
    document.body.appendChild(expenseModal);
    expenseModal.style.display = 'flex';
}

// Masraf güncelleme fonksiyonu
function updateExpense() {
    const expenseId = document.getElementById('expenseId').value;
    const data = {
        expense_type: document.getElementById('expenseType').value === 'Diğer' ? 
                     document.getElementById('otherExpenseType').value : 
                     document.getElementById('expenseType').value,
        amount: parseFloat(document.getElementById('expenseAmount').value),
        date: document.getElementById('expenseDate').value,
        is_paid: document.getElementById('expenseStatus').checked,
        description: document.getElementById('expenseDescription').value || ''
    };

    fetch(`/update_expense/${expenseId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeExpenseModal();
            showDetails(currentCaseId);
        } else {
            throw new Error(result.message || 'Masraf güncellenirken bir hata oluştu');
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('Masraf güncellenirken bir hata oluştu: ' + error.message);
    });
}
</script>
{% endblock %}