{% extends "layout.html" %}

{% block title %}İşçi Görüşme Formu{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Sol taraf - Kayıtlı Formlar -->
    <div class="saved-forms-section">
        <div class="section-header">
            <h2><i class="material-icons">folder</i> Kayıtlı Formlar</h2>
            <button class="new-form-btn" onclick="showNewForm()">
                <i class="material-icons">add</i>
                Yeni Form
            </button>
        </div>
        <div class="forms-list" id="formsList">
            <!-- Kayıtlı formlar buraya dinamik olarak eklenecek -->
        </div>
    </div>

    <!-- Sağ taraf - Form -->
    <div class="form-section">
        <form id="workerInterviewForm" class="interview-form">
            <div class="form-header">
                <h1>İŞÇİ GÖRÜŞME TUTANAĞI</h1>
                <div class="form-actions">
                    <button type="button" class="action-btn save-btn" onclick="saveForm()">
                        <i class="material-icons">save</i>
                        Kaydet
                    </button>
                    <button type="button" class="action-btn print-btn" onclick="printForm()">
                        <i class="material-icons">print</i>
                        Yazdır
                    </button>
                    <button type="button" class="action-btn download-btn" onclick="downloadPDF()">
                        <i class="material-icons">download</i>
                        PDF İndir
                    </button>
                </div>
            </div>

            <!-- Madde 1 -->
            <div class="form-group">
                <h3>MADDE 1: KİŞİSEL BİLGİLER</h3>
                <div class="input-grid">
                    <div class="input-item">
                        <label for="fullName">İsim Soyisim</label>
                        <input type="text" id="fullName" name="fullName" required>
                    </div>
                    <div class="input-item">
                        <label for="tcNo">T.C. Kimlik No</label>
                        <input type="text" id="tcNo" name="tcNo" maxlength="11" required>
                    </div>
                    <div class="input-item">
                        <label for="phone">Telefon</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                    <div class="input-item full-width">
                        <label for="address">Adres</label>
                        <textarea id="address" name="address" required></textarea>
                    </div>
                </div>
            </div>

            <!-- Madde 2 -->
            <div class="form-group">
                <h3>MADDE 2: İŞE GİRİŞ BİLGİLERİ</h3>
                <div class="input-grid">
                    <div class="input-item">
                        <label for="startDate">İşe Giriş Tarihi</label>
                        <input type="date" id="startDate" name="startDate" required>
                    </div>
                    <div class="input-item">
                        <label for="insuranceDate">Sigorta Başlangıç Tarihi</label>
                        <input type="date" id="insuranceDate" name="insuranceDate" required>
                    </div>
                </div>
            </div>

            <!-- Madde 3 -->
            <div class="form-group">
                <h3>MADDE 3: İŞTEN AYRILMA BİLGİLERİ</h3>
                <div class="input-grid">
                    <div class="input-item">
                        <label for="endDate">İşten Ayrılma Tarihi</label>
                        <input type="date" id="endDate" name="endDate" required>
                    </div>
                    <div class="input-item full-width">
                        <label for="endReason">Ayrılma Sebebi</label>
                        <textarea id="endReason" name="endReason" required></textarea>
                    </div>
                </div>
            </div>

            <!-- Madde 4 -->
            <div class="form-group">
                <h3>MADDE 4: İŞYERİ BİLGİLERİ</h3>
                <div class="input-grid">
                    <div class="input-item">
                        <label for="companyName">İşyeri Adı/Unvanı</label>
                        <input type="text" id="companyName" name="companyName" required>
                    </div>
                    <div class="input-item">
                        <label for="businessType">Faaliyet Konusu</label>
                        <input type="text" id="businessType" name="businessType" required>
                    </div>
                    <div class="input-item full-width">
                        <label for="companyAddress">İşyeri Adresi</label>
                        <textarea id="companyAddress" name="companyAddress" required></textarea>
                    </div>
                </div>
            </div>

            <!-- Madde 5 -->
            <div class="form-group">
                <h3>MADDE 5: GÖREV BİLGİLERİ</h3>
                <div class="input-grid">
                    <div class="input-item">
                        <label for="position">Görev/Pozisyon</label>
                        <input type="text" id="position" name="position" required>
                    </div>
                </div>
            </div>

            <!-- Madde 6 -->
            <div class="form-group">
                <h3>MADDE 6: ÇALIŞMA DÜZEN</h3>
                <div class="input-grid">
                    <div class="input-item">
                        <label for="workHours">Çalışma Saatleri</label>
                        <input type="text" id="workHours" name="workHours" required>
                    </div>
                    <div class="input-item">
                        <label for="overtime">Fazla Mesai Bilgisi</label>
                        <textarea id="overtime" name="overtime"></textarea>
                    </div>
                </div>
            </div>

            <!-- Madde 7 -->
            <div class="form-group">
                <h3>MADDE 7: ÜCRET VE YARDIMLAR</h3>
                <div class="input-grid">
                    <div class="input-item">
                        <label for="salary">Ücret</label>
                        <input type="number" id="salary" name="salary" required>
                    </div>
                    <div class="input-item">
                        <label for="transportation">Yol Ücreti</label>
                        <input type="number" id="transportation" name="transportation">
                    </div>
                    <div class="input-item">
                        <label for="food">Yemek Ücreti</label>
                        <input type="number" id="food" name="food">
                    </div>
                    <div class="input-item">
                        <label for="benefits">Sosyal Yardımlar</label>
                        <textarea id="benefits" name="benefits"></textarea>
                    </div>
                </div>
            </div>

            <!-- Madde 8 -->
            <div class="form-group">
                <h3>MADDE 8: TATİL BİLGİLERİ</h3>
                <div class="input-grid">
                    <div class="input-item">
                        <label for="weeklyHoliday">Hafta Tatili</label>
                        <input type="text" id="weeklyHoliday" name="weeklyHoliday" required>
                    </div>
                    <div class="input-item">
                        <label for="holidays">Dini/Resmi Bayram Tatilleri</label>
                        <textarea id="holidays" name="holidays"></textarea>
                    </div>
                </div>
            </div>

            <!-- Madde 9 -->
            <div class="form-group">
                <h3>MADDE 9: İZİN VE ALACAK BİLGİLERİ</h3>
                <div class="input-grid">
                    <div class="input-item">
                        <label for="annualLeave">Yıllık Ücretli İzin Alacağı</label>
                        <textarea id="annualLeave" name="annualLeave"></textarea>
                    </div>
                    <div class="input-item">
                        <label for="unpaidSalary">Maaş Alacağı</label>
                        <textarea id="unpaidSalary" name="unpaidSalary"></textarea>
                    </div>
                </div>
            </div>

            <!-- Madde 10 -->
            <div class="form-group">
                <h3>MADDE 10: TANIKLAR</h3>
                <div class="witness-container" id="witnessContainer">
                    <div class="witness-row">
                        <div class="witness-input">
                            <label for="witness1">Tanık</label>
                            <input type="text" id="witness1" name="witness1">
                        </div>
                        <button type="button" class="add-witness-btn" onclick="addWitness()">
                            <i class="material-icons">add</i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- İmza Bölümü -->
            <div class="signature-section">
                <div class="signature-text">
                    <p>OKUDUM</p>
                    <p>BEYANLARIM DOĞRULTUSUNDA HAZIRLANMIŞTIR</p>
                    <p class="signature-line">İMZA</p>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
.page-container {
    display: flex;
    gap: 2rem;
    padding: 2rem;
    background: #f8f9fa;
    min-height: calc(100vh - 100px);
}

/* Sol Bölüm - Kayıtlı Formlar */
.saved-forms-section {
    flex: 1;
    max-width: 300px;
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.section-header h2 {
    font-size: 1.2rem;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin: 0;
}

.new-form-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgb(45,49,60);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.new-form-btn:hover {
    background: rgba(45,49,60,0.9);
    transform: translateY(-2px);
}

.forms-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

/* Sağ Bölüm - Form */
.form-section {
    flex: 3;
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
}

.form-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #eee;
}

.form-header h1 {
    font-size: 1.5rem;
    color: #2c3e50;
    margin: 0;
}

.form-actions {
    display: flex;
    gap: 1rem;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
}

.save-btn {
    background: rgb(45,49,60);
    color: white;
}

.print-btn {
    background: #6c757d;
    color: white;
}

.download-btn {
    background: #4CAF50;
    color: white;
}

.download-btn:hover {
    background: #45a049;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Form Grupları */
.form-group {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #eee;
}

.form-group h3 {
    font-size: 1.2rem;
    color: #2c3e50;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #eee;
}

.input-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

.input-item {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
}

.input-item.full-width {
    grid-column: 1 / -1;
}

.input-item label {
    font-size: 1rem;
    color: #495057;
    font-weight: 500;
}

.input-item input,
.input-item textarea {
    padding: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.input-item input:focus,
.input-item textarea:focus {
    border-color: rgb(45,49,60);
    box-shadow: 0 0 0 2px rgba(45,49,60,0.1);
    outline: none;
}

.input-item textarea {
    min-height: 100px;
    resize: vertical;
}

/* İmza Bölümü */
.signature-section {
    margin-top: 3rem;
    text-align: right;
    padding-right: 2rem;
}

.signature-text {
    display: inline-block;
    text-align: center;
}

.signature-text p {
    margin: 0.5rem 0;
    font-weight: 500;
    color: #2c3e50;
}

.signature-line {
    margin-top: 4rem !important;
    position: relative;
}

/* Responsive Tasarım */
@media (max-width: 1200px) {
    .page-container {
        flex-direction: column;
    }
    
    .saved-forms-section {
        max-width: none;
    }
    
    .input-grid {
        grid-template-columns: 1fr;
    }
}

@media print {
    @page {
        size: A4;
        margin: 1cm;
    }

    body * {
        visibility: hidden;
    }

    .form-section, .form-section * {
        visibility: visible;
    }

    .form-section {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        padding: 1cm !important;
        margin: 0 !important;
        background: none !important;
        box-shadow: none !important;
    }

    .form-actions, .add-witness-btn, .remove-witness-btn {
        display: none !important;
    }

    input, textarea {
        border: none !important;
        padding: 0 !important;
        font-size: 11pt !important;
        color: black !important;
        background: none !important;
    }

    input[type="text"], input[type="tel"], input[type="date"], textarea {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
    }

    .input-item {
        margin-bottom: 0.5cm !important;
    }

    .input-item label {
        display: block !important;
        font-weight: bold !important;
        color: black !important;
        margin-bottom: 0.2cm !important;
    }

    /* Boş alanları göster */
    .input-item:has(input:placeholder-shown),
    .input-item:has(textarea:placeholder-shown) {
        display: block !important;
    }

    .signature-section {
        margin-top: 2cm !important;
        text-align: right !important;
    }

    .signature-text p {
        margin: 0.2cm 0 !important;
        font-size: 11pt !important;
        color: black !important;
    }
}

/* Tanıklar bölümü için yeni stiller */
.witness-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.witness-row {
    display: flex;
    align-items: flex-end;
    gap: 1rem;
}

.witness-input {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.add-witness-btn {
    background: rgb(45,49,60);
    color: white;
    border: none;
    border-radius: 6px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.add-witness-btn:hover {
    background: rgba(45,49,60,0.9);
    transform: translateY(-2px);
}

.remove-witness-btn {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 6px;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.remove-witness-btn:hover {
    background: #c82333;
    transform: translateY(-2px);
}
</style>

<script>
// Form kaydetme fonksiyonu
function saveForm() {
    const formData = new FormData(document.getElementById('workerInterviewForm'));
    const data = Object.fromEntries(formData.entries());
    
    fetch('/save_worker_interview', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Form başarıyla kaydedildi!');
            loadSavedForms();
        } else {
            alert('Form kaydedilirken bir hata oluştu!');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Bir hata oluştu!');
    });
}

// Yazdırma fonksiyonu
function printForm() {
    // Yazdırma öncesi form verilerinin dolu olduğundan emin olun
    const form = document.getElementById('workerInterviewForm');
    const requiredFields = form.querySelectorAll('[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value) {
            isValid = false;
            field.style.borderColor = 'red';
        }
    });
    
    if (!isValid) {
        alert('Lütfen tüm zorunlu alanları doldurun.');
        return;
    }
    
    window.print();
}

// Yeni form gösterme fonksiyonu
function showNewForm() {
    document.getElementById('workerInterviewForm').reset();
    // Form ID'sini temizle
    document.getElementById('workerInterviewForm').removeAttribute('data-form-id');
}

// Kayıtlı formları yükleme fonksiyonu
function loadSavedForms() {
    fetch('/get_worker_interviews')
        .then(response => response.json())
        .then(data => {
            const formsList = document.getElementById('formsList');
            formsList.innerHTML = '';
            
            data.forms.forEach(form => {
                const formItem = document.createElement('div');
                formItem.className = 'saved-form-item';
                formItem.innerHTML = `
                    <div class="form-info">
                        <h3>${form.fullName}</h3>
                        <p>${new Date(form.startDate).toLocaleDateString('tr-TR')}</p>
                    </div>
                    <div class="form-actions">
                        <button onclick="editForm(${form.id})" class="edit-btn">
                            <i class="material-icons">edit</i>
                        </button>
                        <button onclick="deleteForm(${form.id})" class="delete-btn">
                            <i class="material-icons">delete</i>
                        </button>
                    </div>
                `;
                formsList.appendChild(formItem);
            });
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Formlar yüklenirken bir hata oluştu!');
        });
}

// Form düzenleme fonksiyonu
function editForm(formId) {
    fetch(`/get_worker_interview/${formId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const form = document.getElementById('workerInterviewForm');
                form.setAttribute('data-form-id', formId);
                
                // Form alanlarını doldur
                Object.keys(data.form).forEach(key => {
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.value = data.form[key];
                    }
                });
            } else {
                alert('Form yüklenirken bir hata oluştu!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Bir hata oluştu!');
        });
}

// Form silme fonksiyonu
function deleteForm(formId) {
    if (confirm('Bu formu silmek istediğinize emin misiniz?')) {
        fetch(`/delete_worker_interview/${formId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Form başarıyla silindi!');
                loadSavedForms();
            } else {
                alert('Form silinirken bir hata oluştu!');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Bir hata oluştu!');
        });
    }
}

// Sayfa yüklendiğinde kayıtlı formları yükle
document.addEventListener('DOMContentLoaded', loadSavedForms);

// PDF indirme fonksiyonu
function downloadPDF() {
    const formData = new FormData(document.getElementById('workerInterviewForm'));
    const data = Object.fromEntries(formData.entries());
    
    fetch('/generate_worker_interview_pdf', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.blob())
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `isci_gorusme_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('PDF oluşturulurken bir hata oluştu!');
    });
}

let witnessCount = 1;

function addWitness() {
    witnessCount++;
    const container = document.getElementById('witnessContainer');
    const newRow = document.createElement('div');
    newRow.className = 'witness-row';
    newRow.innerHTML = `
        <div class="witness-input">
            <label for="witness${witnessCount}">Tanık</label>
            <input type="text" id="witness${witnessCount}" name="witness${witnessCount}">
        </div>
        <button type="button" class="remove-witness-btn" onclick="removeWitness(this)">
            <i class="material-icons">remove</i>
        </button>
    `;
    container.appendChild(newRow);
}

function removeWitness(button) {
    button.closest('.witness-row').remove();
}
</script>
{% endblock %} 