{% extends "layout.html" %}

{% block title %}Örnek Dilekçeler{% endblock %}

{% block head %}
{{ super() }}
<style>
/* Örnek Dilekçeler Sayfası Özel Stilleri */
.ornek-dilekceler-container {
    /* Bu sayfaya özel stil ayarları buraya eklenebilir */
}

/* Sıralanabilir tablo stilleri */
.sortable:hover {
    background-color: #e9ecef !important;
}

.sortable .sort-icon {
    transition: transform 0.2s ease;
    color: #6c757d;
}

.sortable.asc .sort-icon {
    transform: rotate(180deg);
    color: #2d313c;
}

.sortable.desc .sort-icon {
    transform: rotate(0deg);
    color: #2d313c;
}

/* Toast stilleri sayfaya özel */
.ornek-dilekceler-container .toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 1070;
}

/* TAM EKRAN MODAL - ZORLA UYGULANAN CSS - EN ÜST ÖNCELIK */
div.file-detail-modal,
#previewModal,
.file-detail-modal,
div[id="previewModal"],
div[class*="file-detail-modal"] {
    position: fixed !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100vw !important;
    height: 100vh !important;
    max-width: 100vw !important;
    max-height: 100vh !important;
    background: rgba(0, 0, 0, 0.9) !important;
    z-index: 999999 !important;
    display: none !important;
    justify-content: center !important;
    align-items: center !important;
    overflow: hidden !important;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    outline: none !important;
    box-shadow: none !important;
    border-radius: 0 !important;
    transform: none !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Modal görünür olduğunda */
div.file-detail-modal[style*="flex"],
#previewModal[style*="flex"],
.file-detail-modal[style*="flex"],
div[id="previewModal"][style*="flex"],
div[class*="file-detail-modal"][style*="flex"] {
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Modal içerik */
div.preview-modal-content,
.preview-modal-content,
#previewModal .preview-modal-content {
    width: calc(100vw - 40px) !important;
    height: calc(100vh - 40px) !important;
    max-width: calc(100vw - 40px) !important;
    max-height: calc(100vh - 40px) !important;
    background: white !important;
    display: flex !important;
    flex-direction: column !important;
    position: relative !important;
    border-radius: 8px !important;
    margin: 20px !important;
    padding: 0 !important;
    overflow: hidden !important;
    border: none !important;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
    left: auto !important;
    top: auto !important;
    right: auto !important;
    bottom: auto !important;
    transform: none !important;
    visibility: visible !important;
    opacity: 1 !important;
}

/* Modal header */
.preview-modal-content .modal-header {
    background: #f8f9fa !important;
    border-bottom: 1px solid #dee2e6 !important;
    padding: 15px 20px !important;
    display: flex !important;
    justify-content: space-between !important;
    align-items: center !important;
    flex-shrink: 0 !important;
    height: 60px !important;
    margin: 0 !important;
    border-radius: 8px 8px 0 0 !important;
    position: relative !important;
    width: 100% !important;
    box-sizing: border-box !important;
}

/* Modal title */
.preview-modal-content .modal-header h2 {
    margin: 0 !important;
    font-size: 1.25rem !important;
    font-weight: 500 !important;
    color: #212529 !important;
    display: flex !important;
    align-items: center !important;
    flex: 1 !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
}

/* Close button */
.preview-modal-content .close-btn {
    background: none !important;
    border: none !important;
    font-size: 1.5rem !important;
    color: #6c757d !important;
    cursor: pointer !important;
    padding: 8px !important;
    border-radius: 4px !important;
    transition: all 0.2s !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    margin: 0 !important;
    width: 40px !important;
    height: 40px !important;
    flex-shrink: 0 !important;
}

.preview-modal-content .close-btn:hover {
    background: rgba(0, 0, 0, 0.1) !important;
    color: #495057 !important;
}

/* Modal body */
.preview-modal-body {
    flex: 1 !important;
    display: flex !important;
    flex-direction: column !important;
    overflow: hidden !important;
    background: #fff !important;
    margin: 0 !important;
    padding: 0 !important;
    height: calc(100% - 60px) !important;
    position: relative !important;
    width: 100% !important;
    box-sizing: border-box !important;
}

/* Document container */
.document-preview-container {
    flex: 1 !important;
    overflow: auto !important;
    background: white !important;
    position: relative !important;
    width: 100% !important;
    height: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
    box-sizing: border-box !important;
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
}

/* Iframe ve img stilleri */
.document-preview-container iframe {
    width: 100% !important;
    height: 100% !important;
    border: none !important;
    margin: 0 !important;
    padding: 0 !important;
    background: white !important;
    display: block !important;
}

.document-preview-container img {
    max-width: 100% !important;
    max-height: 100% !important;
    object-fit: contain !important;
    margin: 0 auto !important;
    display: block !important;
    background: white !important;
}

/* Bootstrap modal override - tüm bootstrap modallarını etkisiz hale getir */
.modal.fade,
.modal.show,
.modal-backdrop {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
}

/* Bootstrap conflicts temizleme */
.modal-dialog,
.modal-content {
    position: static !important;
    transform: none !important;
    width: auto !important;
    max-width: none !important;
    height: auto !important;
    max-height: none !important;
    margin: 0 !important;
    padding: 0 !important;
    border: none !important;
    border-radius: 0 !important;
    box-shadow: none !important;
}

/* Yükleme ve hata durumları */
.preview-loading, .preview-error {
    display: flex !important;
    flex-direction: column !important;
    align-items: center !important;
    justify-content: center !important;
    padding: 40px !important;
    text-align: center !important;
    height: 100% !important;
    background: white !important;
    color: #333 !important;
}

.preview-loading .spinner {
    border: 4px solid #f3f3f3 !important;
    border-top: 4px solid #007bff !important;
    border-radius: 50% !important;
    width: 50px !important;
    height: 50px !important;
    animation: spin 1s linear infinite !important;
    margin-bottom: 20px !important;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Material Icons düzeltmeleri */
.material-icons {
    font-family: 'Material Icons' !important;
    font-weight: normal !important;
    font-style: normal !important;
    font-size: 24px !important;
    line-height: 1 !important;
    letter-spacing: normal !important;
    text-transform: none !important;
    display: inline-block !important;
    white-space: nowrap !important;
    word-wrap: normal !important;
    direction: ltr !important;
    -webkit-font-smoothing: antialiased !important;
    vertical-align: middle !important;
}

/* Error button */
.preview-error .btn {
    background: #007bff !important;
    color: white !important;
    border: none !important;
    padding: 10px 20px !important;
    border-radius: 4px !important;
    cursor: pointer !important;
    font-size: 14px !important;
    text-decoration: none !important;
    display: inline-flex !important;
    align-items: center !important;
    gap: 8px !important;
    margin-top: 15px !important;
}

.preview-error .btn:hover {
    background: #0056b3 !important;
}

/* Z-index override - en üste çık */
div.file-detail-modal,
#previewModal,
.file-detail-modal {
    z-index: 2147483647 !important; /* Maximum z-index */
}

/* Body scroll engellemesi modal açıkken */
body.modal-open {
    overflow: hidden !important;
    padding-right: 0 !important;
}

/* Responsive ayarları */
@media (max-width: 768px) {
    div.preview-modal-content,
    .preview-modal-content {
        width: calc(100vw - 20px) !important;
        height: calc(100vh - 20px) !important;
        margin: 10px !important;
    }
    
    .preview-modal-content .modal-header {
        padding: 10px 15px !important;
        height: 50px !important;
    }
    
    .preview-modal-content .modal-header h2 {
        font-size: 1.1rem !important;
    }
    
    .preview-modal-body {
        height: calc(100% - 50px) !important;
    }
}

/* Tüm diğer modal library çakışmalarını önle */
[class*="modal"],
[id*="modal"],
.fade,
.show {
    z-index: auto !important;
}

div.file-detail-modal[style*="flex"],
#previewModal[style*="flex"] {
    z-index: 2147483647 !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 ornek-dilekceler-container">
    <div class="row mb-4">
        <div class="col-12">
            <div class="bg-light p-4 rounded shadow-sm">
                <h1 class="display-5 mb-2"><i class="material-icons align-middle me-2" style="font-size: 36px;">description</i>Örnek Dilekçeler</h1>
                <p class="text-muted lead">Bu sayfada örnek dilekçeleri yönetebilirsiniz. Kategori ekleyebilir, dilekçe yükleyebilir, mevcut dilekçeleri listeleyebilir, düzenleyebilir, indirebilir, önizleyebilir ve silebilirsiniz.</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Kategori Yönetimi -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light">
                    <h2 class="h5 mb-0 text-primary"><i class="material-icons align-middle me-2">category</i>Kategori Yönetimi</h2>
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="text" id="yeniKategoriAdi" class="form-control form-control-lg" placeholder="Yeni Kategori Adı" style="min-width: 200px;">
                        <button class="btn btn-outline-primary btn-lg" type="button" onclick="kategoriEkle()">
                            <i class="material-icons align-middle">add</i> Ekle
                        </button>
                    </div>
                    <h3 class="h5 mt-4 mb-3">Mevcut Kategoriler</h3>
                    <div id="kategoriListesi" class="row row-cols-1 row-cols-md-3 g-2">
                        <!-- Kategoriler buraya dinamik olarak eklenecek -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Dilekçe Yükleme -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-light">
                    <h2 class="h5 mb-0 text-success"><i class="material-icons align-middle me-2">upload_file</i>Dilekçe Yükle</h2>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="dilekceDosyasi" class="form-label fw-bold">Dilekçe Dosyası Seçin</label>
                            <input class="form-control form-control-lg" type="file" id="dilekceDosyasi" style="min-width: 300px;">
                        <div class="form-text text-muted">Kabul edilen formatlar: DOC, DOCX, PDF, TXT</div>
                    </div>
                    <div class="mb-3">
                        <label for="dilekceKategorisi" class="form-label fw-bold">Kategori Seçin</label>
                        <select id="dilekceKategorisi" class="form-select form-select-lg" style="min-width: 300px; width: 100%;">
                            <!-- Kategoriler buraya dinamik olarak eklenecek -->
                            <option selected value="">Kategori Seçiniz...</option>
                        </select>
                    </div>
                    <div class="d-grid">
                        <button class="btn btn-outline-success btn-lg" onclick="dilekceYukle()">
                            <i class="material-icons align-middle me-2">cloud_upload</i>Yükle
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dilekçe Listesi -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm" style="border: none !important;">
                <div class="card-header bg-light" style="border-bottom: none !important;">
                    <h2 class="h5 mb-0" style="color: #2d313c;"><i class="material-icons align-middle me-2">list</i>Dilekçeler</h2>
                </div>
                <div class="card-body" style="border-top: none !important;">
                    <div class="mb-3">
                        <label for="listelenecekKategori" class="form-label fw-bold">Listelenecek Kategoriyi Seçin:</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light">
                                <i class="material-icons">filter_list</i>
                            </span>
                            <select id="listelenecekKategori" class="form-select form-select-lg" onchange="dilekceleriListele(this.value)" style="min-width: 300px; width: 100%;">
                                <option selected value="">Tüm Kategoriler</option>
                                <!-- Kategoriler buraya dinamik olarak eklenecek -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover table-striped align-middle" id="dilekceTablosu">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col" class="fw-bold sortable" onclick="sortTable(0)" style="cursor: pointer; user-select: none;">
                                        Dilekçe Adı <i class="material-icons sort-icon" style="font-size: 16px; vertical-align: middle;">unfold_more</i>
                                    </th>
                                    <th scope="col" class="fw-bold sortable" onclick="sortTable(1)" style="cursor: pointer; user-select: none;">
                                        Kategori <i class="material-icons sort-icon" style="font-size: 16px; vertical-align: middle;">unfold_more</i>
                                    </th>
                                    <th scope="col" class="fw-bold sortable" onclick="sortTable(2)" style="cursor: pointer; user-select: none;">
                                        Yüklenme Tarihi <i class="material-icons sort-icon" style="font-size: 16px; vertical-align: middle;">unfold_more</i>
                                    </th>
                                    <th scope="col" class="fw-bold text-center">İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="dilekceTablosuBody">
                                <!-- Dilekçeler buraya dinamik olarak eklenecek -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modallar (Örnek) -->

<!-- Silme Onay Modalı -->
<div class="modal fade" id="silOnayModal" tabindex="-1" aria-labelledby="silOnayModalLabel" aria-hidden="true" style="z-index: 1080;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title text-danger" id="silOnayModalLabel"><i class="material-icons align-middle me-2">warning</i>Silme Onayı</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Bu öğeyi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.
        <input type="hidden" id="silinecekOgeId">
        <input type="hidden" id="silinecekOgeTuru">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
        <button type="button" class="btn btn-outline-danger" onclick="onaylaSil()">
            <i class="material-icons align-middle me-1">delete</i>Sil
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // const csrfToken = "{{ csrf_token() }}"; // Bu satırı kaldırıyoruz, global CSRF_TOKEN kullanılacak.

    // Global değişkenler
    let dosyaOnizlemeModal;

    // Kategori Fonksiyonları
    async function kategoriEkle() {
        const yeniKategoriAdi = document.getElementById('yeniKategoriAdi').value;
        if (!yeniKategoriAdi.trim()) {
            alert('Kategori adı boş olamaz.');
            return;
        }
        
        try {
            const response = await fetch('/api/dilekce_kategorileri', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN // Global CSRF_TOKEN'ı kullan
                },
                body: JSON.stringify({ ad: yeniKategoriAdi.trim() })
            });
            const result = await response.json();
            if (result.success) {
                document.getElementById('yeniKategoriAdi').value = '';
                // Başarı bildirimi göster
                showToast('Başarılı', 'Kategori başarıyla eklendi.', 'success');
                kategorileriListele();
            } else {
                // Hata bildirimi göster
                showToast('Hata', 'Kategori eklenirken hata: ' + result.message, 'error');
            }
        } catch (error) {
            console.error('Kategori ekleme hatası:', error);
            // Hata bildirimi göster
            showToast('Hata', 'Kategori eklenirken bir ağ hatası oluştu.', 'error');
        }
    }

    async function kategorileriListele() {
        console.log('Kategoriler listeleniyor...');
        try {
            const response = await fetch('/api/dilekce_kategorileri');
            const result = await response.json();

            if (!result.success) {
                showToast('Hata', 'Kategoriler getirilirken hata: ' + result.message, 'error');
                return;
            }
            const kategoriler = result.kategoriler || [];

            const kategoriListesiDiv = document.getElementById('kategoriListesi');
            const dilekceKategorisiSelect = document.getElementById('dilekceKategorisi');
            const listelenecekKategoriSelect = document.getElementById('listelenecekKategori');

            kategoriListesiDiv.innerHTML = ''; 
            dilekceKategorisiSelect.innerHTML = '<option selected value="">Kategori Seçiniz...</option>'; 
            listelenecekKategoriSelect.innerHTML = '<option selected value="">Tüm Kategoriler</option>';

            if (kategoriler.length === 0) {
                const div = document.createElement('div');
                div.className = 'col-12 text-center text-muted';
                div.innerHTML = '<i class="material-icons">info</i> Henüz kategori eklenmemiş.';
                kategoriListesiDiv.appendChild(div);
            } else {
                kategoriler.forEach(kat => {
                    const div = document.createElement('div');
                    div.className = 'col';
                    const card = document.createElement('div');
                    card.className = 'card border-0 shadow-sm h-100';
                    
                    const cardBody = document.createElement('div');
                    cardBody.className = 'd-flex justify-content-between align-items-center p-2';
                    cardBody.innerHTML = `<span><i class="material-icons align-middle me-2 text-secondary">folder</i>${kat.ad}</span>`;
                    
                    const silButton = document.createElement('button');
                    silButton.className = 'btn btn-sm btn-outline-secondary';
                    silButton.innerHTML = '<i class="material-icons">delete</i>';
                    silButton.onclick = () => kategoriSil(kat.id, kat.ad);
                    cardBody.appendChild(silButton);
                    card.appendChild(cardBody);
                    div.appendChild(card);
                    kategoriListesiDiv.appendChild(div);

                    const optionDilekce = document.createElement('option');
                    optionDilekce.value = kat.id;
                    optionDilekce.textContent = kat.ad;
                    dilekceKategorisiSelect.appendChild(optionDilekce);

                    const optionListele = document.createElement('option');
                    optionListele.value = kat.id;
                    optionListele.textContent = kat.ad;
                    listelenecekKategoriSelect.appendChild(optionListele.cloneNode(true));
                });
            }
            console.log('Kategoriler yüklendi.');
        } catch (error) {
            console.error('Kategorileri listeleme hatası:', error);
            showToast('Hata', 'Kategoriler getirilirken bir ağ hatası oluştu.', 'error');
        }
    }

    function kategoriSil(kategoriId, kategoriAdi) {
        const silOnayModalEl = document.getElementById('silOnayModal');
        const silOnayModal = bootstrap.Modal.getInstance(silOnayModalEl) || new bootstrap.Modal(silOnayModalEl);
        document.getElementById('silinecekOgeId').value = kategoriId;
        document.getElementById('silinecekOgeTuru').value = 'kategori';
        const modalBody = silOnayModalEl.querySelector('.modal-body');
        if (modalBody) {
            // Mevcut metin düğümünü veya ilk çocuğu güncelle
            let textNode = modalBody.firstChild;
            while(textNode && textNode.nodeType !== Node.TEXT_NODE) {
                textNode = textNode.firstChild; // Daha derine inebilir
            }
            if (textNode) {
                 textNode.textContent = `"${kategoriAdi}" kategorisini silmek istediğinizden emin misiniz? Bu işlem geri alınamaz. `;
            } else {
                // Fallback eğer metin düğümü bulunamazsa
                modalBody.insertBefore(document.createTextNode(`"${kategoriAdi}" kategorisini silmek istediğinizden emin misiniz? Bu işlem geri alınamaz. `), modalBody.firstChild);
            }
        }
        silOnayModal.show();
    }

    // Dilekçe Fonksiyonları
    async function dilekceYukle() {
        const dosyaInput = document.getElementById('dilekceDosyasi');
        const kategoriSelect = document.getElementById('dilekceKategorisi');
        const dilekceAdiInput = document.getElementById('yeniDilekceAdi'); // Opsiyonel dilekce adı için
        const dosya = dosyaInput.files[0];
        const kategoriId = kategoriSelect.value;
        const dilekceAdi = dilekceAdiInput ? dilekceAdiInput.value.trim() : '';


        if (!dosya) {
            showToast('Uyarı', 'Lütfen bir dosya seçin.', 'warning');
            return;
        }
        if (!kategoriId || kategoriId === '') { // Kategori seçili olmalı
            showToast('Uyarı', 'Lütfen bir kategori seçin.', 'warning');
            return;
        }

        // Yükleme başladı bildirimi
        showToast('Bilgi', 'Dilekçe yükleniyor...', 'info');

        const formData = new FormData();
        formData.append('dilekceDosyasi', dosya);
        formData.append('kategoriId', kategoriId);
        if (dilekceAdi) { // Sadece doluysa gönder
            formData.append('dilekceAdi', dilekceAdi);
        }

        console.log('Dilekçe yükleniyor...');
        try {
            const response = await fetch('/api/ornek_dilekceler', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': CSRF_TOKEN 
                },
                body: formData
            });
            const result = await response.json();
            if (result.success) {
                showToast('Başarılı', 'Dilekçe başarıyla yüklendi.', 'success');
                dilekceleriListele(kategoriId); // Yükleme sonrası listeyi güncelle
                dosyaInput.value = ''; 
                kategoriSelect.value = ''; 
                if(dilekceAdiInput) dilekceAdiInput.value = '';
            } else {
                showToast('Hata', 'Dilekçe yüklenirken hata: ' + result.message, 'error');
            }
        } catch (error) {
            console.error('Dilekçe yükleme hatası:', error);
            showToast('Hata', 'Dilekçe yüklenirken bir ağ hatası oluştu.', 'error');
        }
    }

    async function dilekceleriListele(kategoriId = null) {
        console.log('Dilekçeler listeleniyor, Kategori ID:', kategoriId || 'Tümü');
        let url = '/api/ornek_dilekceler';
        if (kategoriId && kategoriId !== '') {
            url += `?kategoriId=${kategoriId}`;
        }

        // Yükleniyor göster
        const tabloBody = document.getElementById('dilekceTablosuBody');
        tabloBody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Yükleniyor...</span>
                    </div>
                    <p class="mt-2 text-muted">Dilekçeler yükleniyor...</p>
                </td>
            </tr>
        `;

        try {
            const response = await fetch(url);
            const result = await response.json();

            if (!result.success) {
                showToast('Hata', 'Dilekçeler getirilirken hata: ' + result.message, 'error');
                return;
            }
            const dilekceler = result.dilekceler || [];
            tabloBody.innerHTML = '';

            if (dilekceler.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 4;
                td.className = 'text-center py-4 text-muted';
                td.innerHTML = kategoriId ? 
                    '<i class="material-icons" style="font-size: 48px;">folder_open</i><p>Bu kategoride henüz dilekçe bulunmamaktadır.</p>' : 
                    '<i class="material-icons" style="font-size: 48px;">inbox</i><p>Henüz hiç dilekçe yüklenmemiş.</p>';
                tr.appendChild(td);
                tabloBody.appendChild(tr);
                return;
            }

            dilekceler.forEach(dilekce => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="material-icons text-muted me-2">description</i>
                            <div>${dilekce.ad}</div>
                        </div>
                    </td>
                    <td>
                        <span class="badge bg-secondary">${dilekce.kategori}</span>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="material-icons text-muted me-2">calendar_today</i>
                            <div>${dilekce.tarih}</div>
                        </div>
                    </td>
                    <td>
                        <div class="d-flex justify-content-center">
                            <button class="btn btn-sm btn-outline-secondary mx-1" onclick="window.onizlemeDilekce('${dilekce.id}', '${dilekce.ad}')">
                                <i class="material-icons">visibility</i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary mx-1" onclick="indirDilekce('${dilekce.id}')">
                                <i class="material-icons">download</i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary mx-1" onclick="dilekceDuzenleAd('${dilekce.id}', '${dilekce.ad}')">
                                <i class="material-icons">edit</i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary mx-1" onclick="silDilekce('${dilekce.id}')">
                                <i class="material-icons">delete</i>
                            </button>
                        </div>
                    </td>
                `;
                tabloBody.appendChild(tr);
            });
            console.log('Dilekçeler yüklendi.');
        } catch (error) {
            console.error('Dilekçeleri listeleme hatası:', error);
            showToast('Hata', 'Dilekçeler getirilirken bir ağ hatası oluştu.', 'error');
            
            // Hata durumunda mesaj göster
            tabloBody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-4">
                        <i class="material-icons text-danger" style="font-size: 48px;">error</i>
                        <p class="text-danger">Dilekçeler yüklenirken bir hata oluştu.</p>
                        <button class="btn btn-sm btn-outline-primary mt-2" onclick="dilekceleriListele('${kategoriId}')">
                            <i class="material-icons align-middle me-1">refresh</i> Yeniden Dene
                        </button>
                    </td>
                </tr>
            `;
        }
    }

    // Bu fonksiyon artık kullanılmıyor - window.onizlemeDilekce kullanılıyor

    // Eski fonksiyonlar kaldırıldı - artık window.onizlemeDilekce kullanılıyor

    function dilekceIndir(dilekceId) {
        console.log('İndirilecek dilekçe ID:', dilekceId);
        
        // İndirme başladı bildirimi
        showToast('Bilgi', 'Dilekçe indiriliyor...', 'info');
        
        // İndirme bağlantısı
        window.location.href = `/api/ornek_dilekceler/${dilekceId}/indir`;
    }

    async function dilekceDuzenleAd(dilekceId, mevcutAd) {
        console.log('Düzenlenecek dilekçe ID:', dilekceId);
        
        // Daha modern bir şekilde ad düzenleme - prompt yerine custom modal kullanılabilir
        // Şimdilik prompt ile devam edelim
        const yeniAd = prompt(`"${mevcutAd}" için yeni bir ad girin (uzantıyı koruyun veya dosya adınızdan emin olun):`, mevcutAd);
        
        if (yeniAd && yeniAd.trim() !== mevcutAd.trim()) {
            // Güncelleme başladı bildirimi
            showToast('Bilgi', 'Dilekçe adı güncelleniyor...', 'info');
            
            try {
                const response = await fetch(`/api/ornek_dilekceler/${dilekceId}/duzenle_ad`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': CSRF_TOKEN
                    },
                    body: JSON.stringify({ yeni_ad: yeniAd.trim() })
                });
                const result = await response.json();
                if (result.success) {
                    showToast('Başarılı', 'Dilekçe adı başarıyla güncellendi.', 'success');
                    dilekceleriListele(document.getElementById('listelenecekKategori').value);
                } else {
                    showToast('Hata', 'Dilekçe adı güncellenirken hata: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Dilekçe adı güncelleme hatası:', error);
                showToast('Hata', 'Dilekçe adı güncellenirken bir ağ hatası oluştu.', 'error');
            }
        }
    }

    function dilekceSil(dilekceId, dilekceAdi) {
        const silOnayModalEl = document.getElementById('silOnayModal');
        const silOnayModal = bootstrap.Modal.getInstance(silOnayModalEl) || new bootstrap.Modal(silOnayModalEl);
        document.getElementById('silinecekOgeId').value = dilekceId;
        document.getElementById('silinecekOgeTuru').value = 'dilekce';
        const modalBody = silOnayModalEl.querySelector('.modal-body');
        if (modalBody) {
             let textNode = modalBody.firstChild;
            while(textNode && textNode.nodeType !== Node.TEXT_NODE && textNode.firstChild) { // Sadece ilk text node'u değil, iç içe elementlerdeki ilk text node'u bul
                textNode = textNode.firstChild;
            }
            if (textNode && textNode.nodeType === Node.TEXT_NODE) { // Emin olalım ki bir text node
                 textNode.textContent = `"${dilekceAdi}" adlı dilekçeyi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz. `;
            } else {
                // Fallback eğer metin düğümü bulunamazsa veya yanlış türdeyse
                const p = modalBody.querySelector('p'); // Ya da daha spesifik bir selektör
                if(p) p.textContent = `"${dilekceAdi}" adlı dilekçeyi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz. `;
                else modalBody.insertBefore(document.createTextNode(`"${dilekceAdi}" adlı dilekçeyi silmek istediğinizden emin misiniz? Bu işlem geri alınamaz. `), modalBody.firstChild);
            }
        }
        silOnayModal.show();
    }

    async function onaylaSil() {
        const id = document.getElementById('silinecekOgeId').value;
        const tur = document.getElementById('silinecekOgeTuru').value;
        const silOnayModalEl = document.getElementById('silOnayModal');
        const silOnayModal = bootstrap.Modal.getInstance(silOnayModalEl);

        // İşlem başladı bildirimi
        showToast('Bilgi', `${tur.charAt(0).toUpperCase() + tur.slice(1)} siliniyor...`, 'info');
        
        if (tur === 'kategori') {
            console.log('Kategori silinecek, ID:', id);
            try {
                const response = await fetch(`/api/dilekce_kategorileri/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': CSRF_TOKEN 
                    }
                });
                const result = await response.json();
                if (result.success) {
                    showToast('Başarılı', 'Kategori başarıyla silindi.', 'success');
                    kategorileriListele(); 
                    dilekceleriListele(); 
                } else {
                    showToast('Hata', 'Kategori silinirken hata: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Kategori silme hatası:', error);
                showToast('Hata', 'Kategori silinirken bir ağ hatası oluştu.', 'error');
            }
        } else if (tur === 'dilekce') {
            console.log('Dilekçe silinecek, ID:', id);
            try {
                const response = await fetch(`/api/ornek_dilekceler/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': CSRF_TOKEN
                    }
                });
                const result = await response.json();
                if (result.success) {
                    showToast('Başarılı', 'Dilekçe başarıyla silindi.', 'success');
                    dilekceleriListele(document.getElementById('listelenecekKategori').value); 
                } else {
                    showToast('Hata', 'Dilekçe silinirken hata: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Dilekçe silme hatası:', error);
                showToast('Hata', 'Dilekçe silinirken bir ağ hatası oluştu.', 'error');
            }
        }
        silOnayModal.hide();
    }

    // Toast Bildirimi Gösterme Fonksiyonu
    function showToast(title, message, type = 'info') {
        // Eğer toast container yoksa oluştur
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(toastContainer);
        }
        
        // Toast elementini oluştur
        const toastId = 'toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header ${type === 'success' ? 'bg-light text-success' : type === 'error' ? 'bg-light text-danger' : 'bg-light text-info'}">
                    <strong class="me-auto">${title}</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            </div>
        `;
        
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
        
        // Toast kapandıktan sonra DOM'dan kaldır
        toastElement.addEventListener('hidden.bs.toast', function () {
            toastElement.remove();
        });
    }

    // DOSYA ÖNİZLEME - GELİŞTİRİLMİŞ VERSİYON
    window.onizlemeDilekce = function(dilekceId, dosyaAdi) {
        console.log('🚀 Dilekçe önizleme başlatılıyor:', dilekceId, dosyaAdi);
        console.log('🔧 onizlemeDilekce fonksiyonu çağrıldı!');
        
        // Body scroll engelle
        document.body.classList.add('modal-open');
        
        // Dosya uzantısını belirle
        let ext = '';
        if (dosyaAdi && dosyaAdi.includes('.')) {
            ext = dosyaAdi.split('.').pop().toLowerCase();
        }
        console.log('📁 Tespit edilen dosya uzantısı:', ext);
        
        try {
            showPreviewModal(dilekceId, dosyaAdi, ext);
        } catch (error) {
            console.error('❌ Modal gösterme hatası:', error);
            document.body.classList.remove('modal-open');
            alert('Modal açılırken hata oluştu: ' + error.message);
        }
    };

    // Önizleme modalını göster - Geliştirilmiş versiyon
    function showPreviewModal(dilekceId, filename, ext) {
        console.log('📋 Modal oluşturuluyor:', filename, ext);
        console.log('🔧 showPreviewModal fonksiyonu çağrıldı!');
        
        // Önceki modalları temizle
        const existingModals = document.querySelectorAll('.file-detail-modal, #previewModal, [id*="modal"], [class*="modal"]');
        existingModals.forEach(modal => {
            if (modal.classList.contains('file-detail-modal') || modal.id === 'previewModal') {
                modal.remove();
                console.log('🗑️ Önceki modal kaldırıldı:', modal.id || modal.className);
            }
        });
        
        // Modal wrapper oluştur
        const previewModal = document.createElement('div');
        previewModal.id = 'previewModal';
        previewModal.className = 'file-detail-modal';
        previewModal.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background: rgba(0, 0, 0, 0.9) !important;
            z-index: 2147483647 !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            margin: 0 !important;
            padding: 0 !important;
        `;
        
        // Modal content oluştur
        const modalContentElement = document.createElement('div');
        modalContentElement.className = 'preview-modal-content';
        modalContentElement.style.cssText = `
            width: calc(100vw - 40px) !important;
            height: calc(100vh - 40px) !important;
            background: white !important;
            border-radius: 8px !important;
            display: flex !important;
            flex-direction: column !important;
            overflow: hidden !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
            margin: 20px !important;
        `;
        
        console.log('✅ Modal content elementi oluşturuldu');

        const previewHtml = `
            <div class="modal-header" style="background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; height: 60px; border-radius: 8px 8px 0 0;">
                <h2 style="margin: 0; font-size: 1.25rem; color: #212529; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">📋 ${filename || 'Bilinmeyen Dosya'}</h2>
                <button class="close-btn" onclick="closePreviewModal()" style="background: none; border: none; font-size: 1.5rem; color: #6c757d; cursor: pointer; padding: 8px; border-radius: 4px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                    <i class="material-icons">close</i>
                </button>
            </div>
            <div class="preview-modal-body" style="flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #fff; height: calc(100% - 60px);">
                <div class="document-preview-container" id="previewContainer-${dilekceId}" style="flex: 1; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: white; overflow: auto;">
                    <div style="text-align: center; padding: 40px;">
                        <div style="border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                        <p style="color: #666; font-size: 16px;">Dosya yükleniyor...</p>
                        <style>
                            @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
                        </style>
                    </div>
                </div>
            </div>
        `;
        modalContentElement.innerHTML = previewHtml;
        previewModal.appendChild(modalContentElement);
        
        // Event listener'lar ekle
        previewModal.addEventListener('click', function(e) {
            if (e.target === previewModal) {
                closePreviewModal();
            }
        });
        
        // Close button event listener
        const closeBtn = modalContentElement.querySelector('.close-btn');
        if (closeBtn) {
            closeBtn.addEventListener('click', closePreviewModal);
        }
        
        // DOM'a ekle
        document.body.appendChild(previewModal);
        
        console.log('✅ Modal DOM\'a eklendi ve görünür yapıldı');
        console.log('📱 Modal elementi:', previewModal);

        const previewContainer = document.getElementById(`previewContainer-${dilekceId}`);

        function showError(message) {
            previewContainer.style.cssText = 'flex: 1; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: white;';
            previewContainer.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="material-icons" style="font-size: 48px; color: #999;">error_outline</i>
                    <p style="margin-top: 15px; font-size: 1.1rem; color: #555;">${message}</p>
                    <p style="margin-top: 10px; font-size: 0.9rem; color: #777;">Belgeyi görüntülemek için lütfen indirin.</p>
                    <button class="btn" onclick="indirDilekce(${dilekceId})" style="margin-top: 20px; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                        <i class="material-icons" style="font-size: 18px;">download</i> İndir
                    </button>
                </div>
            `;
        }

        // Dosya türüne göre önizleme - geliştirilmiş
        setTimeout(() => {
            console.log('📥 Dosya türü işleniyor:', ext);
            
            if (ext === 'pdf' || ext === 'txt') {
                const previewUrl = `/api/ornek_dilekceler/${dilekceId}/onizle`;
                previewContainer.style.cssText = 'flex: 1; width: 100%; height: 100%; background: #f5f5f5; overflow: hidden;';
                previewContainer.innerHTML = `<iframe src="${previewUrl}" frameborder="0" style="width: 100%; height: 100%; border: none; background: white;"></iframe>`;
                console.log('📄 PDF/TXT iframe yüklendi:', previewUrl);
            } else if (['png', 'jpg', 'jpeg', 'gif', 'bmp', 'webp'].includes(ext)) {
                const previewUrl = `/api/ornek_dilekceler/${dilekceId}/onizle`;
                previewContainer.style.cssText = 'flex: 1; width: 100%; height: 100%; background: #f5f5f5; display: flex; justify-content: center; align-items: center; overflow: auto;';
                previewContainer.innerHTML = `<img src="${previewUrl}" alt="Dilekçe önizleme" style="max-width: 100%; max-height: 100%; object-fit: contain; background: white;">`;
                console.log('🖼️ Resim yüklendi:', previewUrl);
            } else if (ext === 'docx' || ext === 'doc') {
                // DOCX/DOC dosyaları için HTML önizleme
                console.log('📃 DOCX/DOC dosyası tespit edildi, HTML önizleme yapılacak:', dilekceId);
                
                const previewUrl = `/api/ornek_dilekceler/${dilekceId}/onizle`;
                previewContainer.style.cssText = 'flex: 1; width: 100%; height: 100%; background: #f5f5f5; overflow: hidden;';
                previewContainer.innerHTML = `<iframe src="${previewUrl}" frameborder="0" style="width: 100%; height: 100%; border: none; background: white;"></iframe>`;
                
                console.log('📃 DOCX/DOC iframe yüklendi:', previewUrl);
            } else if (ext === 'udf') {
                // UDF dosyasını doğrudan uygulama içinde görüntüle
                const previewUrl = `/direct_view_udf_dilekce/${dilekceId}`;
                previewContainer.style.cssText = 'flex: 1; width: 100%; height: 100%; background: #f5f5f5; overflow: hidden;';
                previewContainer.innerHTML = `<iframe src="${previewUrl}" frameborder="0" style="width: 100%; height: 100%; border: none; background: white;"></iframe>`;
                console.log('🔤 UDF iframe yüklendi:', previewUrl);
            } else {
                showError(`${ext ? ext.toUpperCase() : 'Bu'} dosya türü için önizleme desteklenmiyor.`);
            }
        }, 300);
    }

    // Modal kapatma fonksiyonu - geliştirilmiş
    function closePreviewModal() {
        console.log('🗑️ Modal kapatma işlemi başlatıldı');
        
        // Body scroll'u tekrar aç
        document.body.classList.remove('modal-open');
        
        // Tüm modalları temizle
        const modals = document.querySelectorAll('.file-detail-modal, #previewModal, [class*="file-detail-modal"], [id*="previewModal"]');
        modals.forEach(modal => {
            try {
                modal.remove();
                console.log('🗑️ Modal kaldırıldı:', modal.id || modal.className);
            } catch (error) {
                console.error('Modal kaldırma hatası:', error);
            }
        });
        
        console.log('✅ Tüm modallar temizlendi');
    }

    // ESC tuşu ve diğer event listener'lar
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const activeModal = document.querySelector('.file-detail-modal, #previewModal');
            if (activeModal) {
                closePreviewModal();
            }
        }
    });

    // Sayfa yeniden yüklendiğinde modal cleanup
    window.addEventListener('beforeunload', function() {
        document.body.classList.remove('modal-open');
    });

    // Dilekçe indirme fonksiyonu
    window.indirDilekce = function(dilekceId) {
        console.log('Dilekçe indiriliyor:', dilekceId);
        
        try {
            const link = document.createElement('a');
            link.href = `/api/ornek_dilekceler/${dilekceId}/indir`;
            link.download = '';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Başarılı', 'Dosya indirme başlatıldı', 'success');
        } catch (error) {
            console.error('İndirme hatası:', error);
            showToast('Hata', 'Dosya indirilemedi', 'error');
        }
    };



    // Dilekçe silme fonksiyonu
    window.silDilekce = function(dilekceId) {
        console.log('Dilekçe siliniyor:', dilekceId);
        
        if (!confirm('Bu dilekçeyi silmek istediğinizden emin misiniz?')) {
            return;
        }
        
        try {
            fetch(`/api/ornek_dilekceler/${dilekceId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Başarılı', 'Dilekçe başarıyla silindi', 'success');
                    // Sayfayı yenile
                    window.location.reload();
                } else {
                    showToast('Hata', data.message || 'Dilekçe silinemedi', 'error');
                }
            })
            .catch(error => {
                console.error('Silme hatası:', error);
                showToast('Hata', 'Silme işlemi sırasında hata oluştu', 'error');
            });
        } catch (error) {
            console.error('Silme işlemi hatası:', error);
            showToast('Hata', 'İşlem sırasında bir hata oluştu', 'error');
        }
    };

    // Tablo sıralama fonksiyonu
    let sortDirection = {}; // Her sütun için sıralama yönünü takip et

    function sortTable(columnIndex) {
        const table = document.getElementById('dilekceTablosu');
        const tbody = document.getElementById('dilekceTablosuBody');
        const rows = Array.from(tbody.rows);
        
        // Boş tablo kontrolü
        if (rows.length === 0 || (rows.length === 1 && rows[0].cells[0].colSpan > 1)) {
            return;
        }
        
        // Sıralama yönünü belirle
        const currentDirection = sortDirection[columnIndex] || 'none';
        let newDirection;
        
        if (currentDirection === 'none' || currentDirection === 'desc') {
            newDirection = 'asc';
        } else {
            newDirection = 'desc';
        }
        
        sortDirection[columnIndex] = newDirection;
        
        // Tüm başlık sınıflarını temizle
        const headers = table.querySelectorAll('.sortable');
        headers.forEach(header => {
            header.classList.remove('asc', 'desc');
            const icon = header.querySelector('.sort-icon');
            if (icon) {
                icon.textContent = 'unfold_more';
            }
        });
        
        // Aktif başlığı işaretle
        const activeHeader = headers[columnIndex];
        activeHeader.classList.add(newDirection);
        const activeIcon = activeHeader.querySelector('.sort-icon');
        if (activeIcon) {
            activeIcon.textContent = newDirection === 'asc' ? 'keyboard_arrow_up' : 'keyboard_arrow_down';
        }
        
        // Satırları sırala
        rows.sort((a, b) => {
            let aVal, bVal;
            
            if (columnIndex === 0) { // Dilekçe Adı
                aVal = a.cells[0].querySelector('div:last-child').textContent.trim().toLowerCase();
                bVal = b.cells[0].querySelector('div:last-child').textContent.trim().toLowerCase();
            } else if (columnIndex === 1) { // Kategori
                aVal = a.cells[1].querySelector('.badge').textContent.trim().toLowerCase();
                bVal = b.cells[1].querySelector('.badge').textContent.trim().toLowerCase();
            } else if (columnIndex === 2) { // Yüklenme Tarihi
                aVal = a.cells[2].querySelector('div:last-child').textContent.trim();
                bVal = b.cells[2].querySelector('div:last-child').textContent.trim();
                
                // Tarihi çevir (dd.mm.yyyy formatından Date objesine)
                const parseDate = (dateStr) => {
                    const parts = dateStr.split('.');
                    if (parts.length === 3) {
                        return new Date(parts[2], parts[1] - 1, parts[0]);
                    }
                    return new Date(dateStr);
                };
                
                aVal = parseDate(aVal);
                bVal = parseDate(bVal);
            }
            
            if (columnIndex === 2) { // Tarih karşılaştırması
                if (newDirection === 'asc') {
                    return aVal - bVal;
                } else {
                    return bVal - aVal;
                }
            } else { // String karşılaştırması
                if (newDirection === 'asc') {
                    return aVal.localeCompare(bVal, 'tr');
                } else {
                    return bVal.localeCompare(aVal, 'tr');
                }
            }
        });
        
        // Sıralanmış satırları tabloya geri ekle
        rows.forEach(row => tbody.appendChild(row));
    }

    // Sayfa yüklendiğinde ilk listelemeleri yap
    document.addEventListener('DOMContentLoaded', function () {
        console.log('🚀 Örnek dilekçeler sayfası yüklendi');
        
        console.log('📋 Kategoriler ve dilekçeler yükleniyor...');
        kategorileriListele();
        dilekceleriListele(); // Başlangıçta tüm dilekçeleri listele
        
        // Enter tuşuna basıldığında kategori ekleme işlemini gerçekleştir
        document.getElementById('yeniKategoriAdi').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                kategoriEkle();
            }
        });

        // Sık kullanılan seçim kutularına daha iyi bir genişlik sağla
        const genisElementler = document.querySelectorAll('#dilekceKategorisi, #listelenecekKategori');
        genisElementler.forEach(element => {
            element.style.minWidth = '100%';
        });
    });
</script>
{% endblock %} 