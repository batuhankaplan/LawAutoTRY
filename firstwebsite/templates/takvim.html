{% extends "layout.html" %}

{% block title %}Takvim{% endblock %}

{% block content %}
<div class="page-container">
    <div class="calendar-wrapper">
        <!-- Takvim Başlığı -->
        <div class="calendar-header">
            <div class="calendar-nav">
                <button id="prevMonth" class="nav-btn">
                    <i class="material-icons">chevron_left</i>
                </button>
                <div class="current-month">
                    <h2 id="currentMonth"></h2>
                    <span id="currentYear"></span>
                </div>
                <button id="nextMonth" class="nav-btn">
                    <i class="material-icons">chevron_right</i>
                </button>
            </div>
            <div class="calendar-tools">
                <button id="todayBtn" class="tool-btn">
                    <i class="material-icons">today</i>
                    <span>Bugün</span>
                </button>
                <button id="addEventBtn" class="tool-btn primary">
                    <i class="material-icons">add</i>
                    <span>Yeni Etkinlik</span>
                </button>
            </div>
        </div>

        <!-- Takvim Grid -->
        <div class="calendar-container">
            <div class="weekdays">
                <div>Pazartesi</div>
                <div>Salı</div>
                <div>Çarşamba</div>
                <div>Perşembe</div>
                <div>Cuma</div>
                <div>Cumartesi</div>
                <div>Pazar</div>
            </div>
            <div id="calendar-grid"></div>
        </div>
    </div>
</div>

<!-- Etkinlik Modalı -->
<div id="eventModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Yeni Etkinlik</h3>
            <button class="close-btn">
                <i class="material-icons">close</i>
            </button>
        </div>
        <form id="eventForm" data-event-id="">
            <div class="modal-body">
                <div class="form-group">
                    <label>Etkinlik Türü</label>
                    <div class="select-wrapper">
                        <select id="eventType" required>
                            <option value="durusma">Duruşma</option>
                            <option value="e-durusma">E-Duruşma</option>
                            <option value="tahliye">Tahliye</option>
                            <option value="is">Yapılacak İş</option>
                            <option value="randevu">Randevu</option>
                            <option value="diger">Diğer</option>
                        </select>
                        
                    </div>
                </div>
                <div class="form-group">
                    <label>Saat</label>
                    <div class="input-wrapper">
                        <input type="time" id="eventTime" required>
                        <i class="material-icons">schedule</i>
                    </div>
                </div>
                <div class="form-group">
                    <label>Başlık</label>
                    <div class="input-wrapper">
                        <input type="text" id="eventTitle" required placeholder="Etkinlik başlığı">
                        <i class="material-icons">title</i>
                    </div>
                </div>
                <div class="form-group">
                    <label>Açıklama</label>
                    <div class="input-wrapper">
                        <textarea id="eventDescription" rows="3" placeholder="Etkinlik detayları"></textarea>
                        <i class="material-icons">description</i>
                    </div>
                </div>
                <input type="hidden" id="selectedDate">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn secondary" id="cancelBtn">
                    <i class="material-icons">close</i>
                    İptal
                </button>
                <button type="submit" class="btn primary">
                    <i class="material-icons">save</i>
                    Kaydet
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Etkinlik Detay Modalı - HTML kısmına ekleyin -->
<div id="eventDetailModal" class="modal">
    <div class="modal-content detail-modal">
        <div class="modal-header">
            <div class="event-type-badge" id="detailEventType"></div>
            <button class="close-btn" id="closeDetailModal">
                <i class="material-icons">close</i>
            </button>
        </div>
        <div class="modal-body">
            <div class="event-detail-content">
                <h3 id="detailTitle"></h3>
                <div class="event-meta">
                    <div class="meta-item">
                        <i class="material-icons">event</i>
                        <span id="detailDate"></span>
                    </div>
                    <div class="meta-item">
                        <i class="material-icons">schedule</i>
                        <span id="detailTime"></span>
                    </div>
                </div>
                <div class="event-description">
                    <p id="detailDescription"></p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn secondary" id="editDetailBtn">
                <i class="material-icons">edit</i>
                Düzenle
            </button>
            <button class="btn danger" id="deleteDetailBtn">
                <i class="material-icons">delete</i>
                Sil
            </button>
        </div>
    </div>
</div>

<style>
.page-container {
    padding: 1rem;
    height: calc(100vh - 2rem);
    display: flex;
    justify-content: center;
    align-items: center;
    box-sizing: border-box;
}

.calendar-wrapper {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    width: 90%;
    height: 90%;
    margin: 0 auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
    min-height: 600px;
}

.calendar-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    margin-top: 0.5rem;
    overflow: auto;
    min-height: 0;
}

#calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, minmax(120px, 1fr));
    grid-template-rows: repeat(6, minmax(100px, 1fr));
    gap: 1px;
    background: #e0e0e0;
    border: 1px solid #e0e0e0;
    min-width: min-content;
}

.calendar-day {
    position: relative;
    background: white;
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    min-height: 100px;
    min-width: 120px;
}

.weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #f5f5f5;
    padding: 0.5rem 0;
    font-weight: 600;
    font-size: 0.9rem;
    text-align: center;
}

.calendar-header {
    background: #f8f9fa;
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.calendar-nav {
    display: flex;
    align-items: center;
    gap: 20px;
}

.current-month {
    text-align: center;
}

.current-month h2 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 600;
    color: #2c3e50;
}

.current-month span {
    color: #95a5a6;
    font-size: 1.1rem;
}

.nav-btn, .tool-btn {
    background: none;
    border: none;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #2c3e50;
    transition: all 0.2s ease;
}

.nav-btn:hover {
    background: #e9ecef;
}

.tool-btn {
    padding: 8px 16px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
}

.tool-btn:hover {
    background: #e9ecef;
    border-color: #ced4da;
}

.tool-btn.primary {
    background: var(--primary-color);
    color: white;
    border: none;
}

.tool-btn.primary:hover {
    background: var(--hover-color);
}

.tool-btn.today-active {
    background: #e3f2fd;
    color: var(--primary-color);
    border-color: var(--primary-color);
}

.calendar-tools {
    display: flex;
    gap: 10px;
}

.calendar-day {
    min-height: 150px;
    padding: 10px;
    background: white;
}

.calendar-day:hover {
    border-color: var(--primary-color);
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

.calendar-day.today {
    background-color: #e3f2fd !important;
    color: #1976d2 !important;
    font-weight: bold;
}

.calendar-day.today .day-number {
    color: #1976d2 !important;
}

.calendar-day.other-month {
    background: #f8f9fa;
    border-color: #f1f3f5;
}

.day-number {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 5px;
    flex-shrink: 0;
}

.add-event-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    border: none;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s ease;
}

.calendar-day:hover .add-event-btn {
    display: flex;
}

.add-event-btn:hover {
    background: var(--hover-color);
    transform: scale(1.1);
}

.event-list {
    flex: 1;
    overflow-y: auto;
    margin-top: 4px;
    display: flex;
    flex-direction: column;
    gap: 2px;
    padding-right: 4px;
}

.event {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    box-sizing: border-box;
}

.event-item {
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.7rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
}

.event-item:hover {
    filter: brightness(1.1);
}

.event-durusma { background: #e74c3c; }
.event-e-durusma { background: #FF9800; }
.event-tahliye { background: #3498db; }
.event-is { background: #2ecc71; }
.event-randevu { background: #9b59b6; }
.event-diger { background: #f1c40f; }

/* Modal Stilleri */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 10px;
    padding: 20px;
    position: relative;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
}

/* Modal başlık */
.modal-header {
    padding: 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    color: #333;
    font-size: 1.5rem;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.4;
}

/* Form grupları */
.modal-body {
    margin: 20px 0;
    overflow-y: auto;
    max-height: calc(80vh - 140px);
}

.form-group {
    margin-bottom: 20px;
    width: 100%;
    box-sizing: border-box;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #2c3e50;
    font-weight: 500;
    font-size: 0.9rem;
}

/* Input ve Select wrapper */
.input-wrapper, .select-wrapper {
    position: relative;
    width: 100%;
    box-sizing: border-box;
}

.input-wrapper input,
.input-wrapper textarea,
.select-wrapper select {
    width: 100%;
    padding: 10px 12px;
    padding-right: 40px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    font-size: 0.95rem;
    color: #2c3e50;
    background: white;
    transition: border-color 0.2s;
    box-sizing: border-box;
}

.input-wrapper input:focus,
.input-wrapper textarea:focus,
.select-wrapper select:focus {
    outline: none;
    border-color: var(--primary-color);
}

/* İkonlar */
.input-wrapper i,
.select-wrapper i {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #95a5a6;
    pointer-events: none;
}

.input-wrapper textarea {
    min-height: 100px;
    resize: vertical;
    width: 100%;
    box-sizing: border-box;
}

.input-wrapper textarea + i {
    top: 24px;
    transform: none;
}

/* Chrome'un varsayılan saat ikonunu gizle */
input[type="time"]::-webkit-calendar-picker-indicator {
    display: none;
}

/* Modal footer */
.modal-footer {
    padding: 15px 20px;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* Butonlar */
.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.btn.primary {
    background: var(--primary-color);
    color: white;
}

.btn.primary:hover {
    background: var(--hover-color);
}

.btn.secondary {
    background: #e9ecef;
    color: #2c3e50;
}

.btn.secondary:hover {
    background: #dee2e6;
}

/* Responsive düzenlemeler */
@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        margin: 10px;
    }
    
    .modal-body {
        padding: 15px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
}

.event-actions {
    display: none;
    gap: 4px;
}

.event-item:hover .event-actions {
    display: flex;
}

.event-action-btn {
    padding: 2px;
    background: rgba(255,255,255,0.2);
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.event-action-btn:hover {
    background: rgba(255,255,255,0.3);
}

@media (max-width: 768px) {
    .calendar-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .calendar-tools {
        width: 100%;
        justify-content: center;
    }
    
    .weekdays div {
        font-size: 0.9rem;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .modal-content {
        width: 95%;
        margin: 10px;
    }
    
    .modal-body {
        padding: 15px;
    }
    
    .calendar-day {
        padding: 5px;
    }
    
    .event-item {
        font-size: 0.7rem;
    }
}

/* Detay modalı için stiller */
.detail-modal {
    max-width: 450px;
}

.event-type-badge {
    padding: 6px 12px;
    border-radius: 20px;
    color: white;
    font-size: 0.9rem;
    font-weight: 500;
}

.event-type-badge.durusma { background: #e74c3c; }
.event-type-badge.e-durusma { background: #FF9800; }
.event-type-badge.tahliye { background: #3498db; }
.event-type-badge.is { background: #2ecc71; }
.event-type-badge.randevu { background: #9b59b6; }
.event-type-badge.diger { background: #f1c40f; }

.event-detail-content {
    padding: 10px 0;
}

.event-detail-content h3 {
    margin: 0 0 15px 0;
    font-size: 1.4rem;
    color: #333;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.4;
}

.event-meta {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #666;
}

.meta-item i {
    font-size: 20px;
}

.event-description {
    margin-top: 15px;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
    max-width: 100%;
}

.event-detail-description {
    margin-top: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
    max-width: 100%;
}

.btn.danger {
    background: #e74c3c;
    color: white;
}

.btn.danger:hover {
    background: #c0392b;
}

/* Event item'a tıklama olayı ekleyin */
.event-item {
    cursor: pointer;
}

/* Chrome'un kendi saat ikonunu gizle */
input[type="time"]::-webkit-calendar-picker-indicator {
    display: none;
}

/* Kaydırma çubuğu stilleri */
.event-list::-webkit-scrollbar {
    width: 4px;
}

.event-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px;
}

.event-list::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 2px;
}

.event-list::-webkit-scrollbar-thumb:hover {
    background: #999;
}

.weekend {
    background-color: #faf6f3;
}

.weekend.holiday {
    background-color: #ffebee !important;
}

.weekend .day-number {
    color: #8b7355;
}

.holiday {
    background-color: #ffebee;
    position: relative;
}

.holiday-name {
    font-size: 0.7rem;
    color: #e53935;
    margin-top: 2px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.holiday .day-number {
    color: #e53935;
}

.weekend .day-number {
    color: #495057;
}

/* Hafta sonu ve bugün çakıştığında bugünün stilini koruyalım */
.calendar-day.weekend.today {
    background-color: #e3f2fd !important;
}

.calendar-day.weekend.today .day-number {
    color: #1976d2 !important;
}

/* Tatil günleri için stil */
.holiday {
    background-color: #ffebee;
    position: relative;
}

/* Tatil günü bugüne denk geldiğinde de bugünün stilini koruyalım */
.calendar-day.holiday.today {
    background-color: #e3f2fd !important;
}

.calendar-day.holiday.today .day-number {
    color: #1976d2 !important;
}

/* Adli tatil günleri için stil */
.calendar-day.adli-tatil {
    background-color: rgba(76, 175, 80, 0.1);
}

.calendar-day.adli-tatil .day-number {
    color: #4CAF50;
}

.calendar-day.adli-tatil .holiday-name {
    color: #4CAF50;
    font-size: 0.7rem;
}

.event-title {
    font-weight: 500;
    margin: 5px 0;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}

#detailTitle {
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.4;
    margin-bottom: 15px;
    font-size: 1.5rem;
    color: #333;
}

.calendar-day .event {
    background: #f8f9fa;
    border-radius: 4px;
    padding: 4px 8px;
    margin-bottom: 4px;
    font-size: 0.85rem;
    cursor: pointer;
    border-left: 3px solid;
}

.calendar-day .event-title {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    display: block;
}

@media (max-height: 800px) {
    .calendar-wrapper {
        height: 95%;
        padding: 0.75rem;
    }
    
    .calendar-day {
        min-height: 80px;
    }
    
    #calendar-grid {
        grid-template-rows: repeat(6, minmax(80px, 1fr));
    }
}

@media (max-width: 1024px) {
    .calendar-wrapper {
        width: 95%;
    }
    
    #calendar-grid {
        grid-template-columns: repeat(7, minmax(100px, 1fr));
    }
    
    .calendar-day {
        min-width: 100px;
    }
}

/* Scrollbar stilleri */
.calendar-container::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

.calendar-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.calendar-container::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.calendar-container::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentDate = new Date();
    const events = {{ events|tojson|safe }};
    
    const months = [
        'Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
        'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'
    ];

    const holidays = {
        '2024-01-01': 'Yılbaşı',
        '2024-04-10': 'Ramazan Bayramı',
        '2024-04-11': 'Ramazan Bayramı',
        '2024-04-12': 'Ramazan Bayramı',
        '2024-04-23': 'Ulusal Egemenlik ve Çocuk Bayramı',
        '2024-05-01': 'Emek ve Dayanışma Günü',
        '2024-05-19': 'Atatürkü Anma, Gençlik ve Spor Bayramı',
        '2024-06-15': 'Kurban Bayramı Arefesi',
        '2024-06-16': 'Kurban Bayramı',
        '2024-06-17': 'Kurban Bayramı',
        '2024-06-18': 'Kurban Bayramı',
        '2024-06-19': 'Kurban Bayramı',
        '2024-07-15': 'Demokrasi ve Milli Birlik Günü',
        '2024-08-30': 'Zafer Bayramı',
        '2024-10-29': 'Cumhuriyet Bayramı',
        '2025-01-01': 'Yılbaşı',
        '2025-03-31': 'Ramazan Bayramı',
        '2025-04-01': 'Ramazan Bayramı',
        '2025-04-02': 'Ramazan Bayramı',
        '2025-04-23': 'Ulusal Egemenlik ve Çocuk Bayramı',
        '2025-05-01': 'Emek ve Dayanışma Günü',
        '2025-05-19': 'Atatürkü Anma, Gençlik ve Spor Bayramı',
        '2025-06-06': 'Kurban Bayramı Arefesi',
        '2025-06-07': 'Kurban Bayramı',
        '2025-06-08': 'Kurban Bayramı',
        '2025-06-09': 'Kurban Bayramı',
        '2025-06-10': 'Kurban Bayramı',
        '2025-07-15': 'Demokrasi ve Milli Birlik Günü',
        '2025-08-30': 'Zafer Bayramı',
        '2025-10-29': 'Cumhuriyet Bayramı'
    };

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        document.getElementById('currentMonth').textContent = `${months[month]} ${year}`;
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        
        let startDay = firstDay.getDay();
        if (startDay === 0) startDay = 7;
        startDay--;
        
        const calendar = document.getElementById('calendar-grid');
        calendar.innerHTML = '';
        
        // Önceki ayın günleri
        for (let i = 0; i < startDay; i++) {
            calendar.appendChild(createDayElement(null, true));
        }
        
        // Bu ayın günleri
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const date = new Date(year, month, day);
            calendar.appendChild(createDayElement(date));
        }
    }

    function isAdliTatil(date) {
        const month = date.getMonth();
        const day = date.getDate();
        return (month === 6 && day >= 20) || month === 7; // Temmuz 20'den sonra veya tüm Ağustos ayı
    }

    function createDayElement(date, isOtherMonth = false) {
        const div = document.createElement('div');
        div.className = 'calendar-day' + (isOtherMonth ? ' other-month' : '');
        
        if (!isOtherMonth) {
            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = date.getDate();
            div.appendChild(dayNumber);
            
            // Hafta sonu kontrolü
            const dayOfWeek = date.getDay();
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                div.classList.add('weekend');
            }
            
            // Resmi tatil kontrolü
            const dateStr = date.toLocaleDateString('en-CA');
            if (holidays[dateStr]) {
                div.classList.add('holiday');
                const holidayName = document.createElement('div');
                holidayName.className = 'holiday-name';
                holidayName.textContent = holidays[dateStr];
                div.appendChild(holidayName);
            }
            
            // Adli tatil kontrolü
            if (isAdliTatil(date)) {
                div.classList.add('adli-tatil');
                if (!holidays[dateStr]) { // Eğer resmi tatil değilse adli tatil yazısını göster
                    const adliTatilText = document.createElement('div');
                    adliTatilText.className = 'holiday-name';
                    adliTatilText.textContent = 'Adli Tatil';
                    div.appendChild(adliTatilText);
                }
            }
            
            // Bugünün tarihi kontrolü
            if (date.toDateString() === new Date().toDateString()) {
                div.classList.add('today');
            }
            
            // Etkinlikleri göster
            const dayEvents = events.filter(e => e.date === dateStr);
            
            if (dayEvents.length > 0) {
                const eventList = document.createElement('div');
                eventList.className = 'event-list';
                
                dayEvents.forEach(event => {
                    const eventItem = document.createElement('div');
                    eventItem.className = `event-item event-${event.event_type}`;
                    
                    const eventContent = document.createElement('span');
                    eventContent.className = 'event-title';
                    eventContent.textContent = `${event.time} ${event.title}`;
                    
                    eventItem.onclick = (e) => {
                        e.stopPropagation();
                        showEventDetail(event);
                    };
                    
                    eventItem.appendChild(eventContent);
                    eventList.appendChild(eventItem);
                });
                
                div.appendChild(eventList);
            }
            
            div.onclick = () => showModal(date);
        }
        
        return div;
    }

    function showModal(date) {
        const modal = document.getElementById('eventModal');
        document.getElementById('selectedDate').value = date.toLocaleDateString('en-CA');
        modal.style.display = 'flex';
    }

    // Modal kapatma
    document.querySelector('.close-btn').onclick = function() {
        document.getElementById('eventModal').style.display = 'none';
    }

    document.getElementById('cancelBtn').onclick = function() {
        document.getElementById('eventModal').style.display = 'none';
    }

    // Form gönderme
    document.getElementById('eventForm').onsubmit = function(e) {
        e.preventDefault();
        
        const eventData = {
            title: document.getElementById('eventTitle').value,
            date: document.getElementById('selectedDate').value,
            time: document.getElementById('eventTime').value,
            event_type: document.getElementById('eventType').value,
            description: document.getElementById('eventDescription').value,
            id: document.getElementById('eventForm').getAttribute('data-event-id') // Etkinlik ID'sini ekle
        };

        const endpoint = eventData.id ? `/update_event/${eventData.id}` : '/add_event';
        const method = eventData.id ? 'PUT' : 'POST';

        fetch(endpoint, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(eventData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    };

    // Bugün butonu için geliştirilen fonksiyon
    function updateTodayButton() {
        const todayBtn = document.getElementById('todayBtn');
        const today = new Date();
        const isCurrentMonth = today.getMonth() === currentDate.getMonth() && 
                              today.getFullYear() === currentDate.getFullYear();
        
        if (isCurrentMonth) {
            todayBtn.classList.add('today-active');
        } else {
            todayBtn.classList.remove('today-active');
        }
    }

    // Bugün butonu
    document.getElementById('todayBtn').onclick = function() {
        currentDate = new Date();
        renderCalendar();
        updateTodayButton();
        
        // Bugünün hücresine scroll
        const today = document.querySelector('.calendar-day.today');
        if (today) {
            today.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    };

    // Ay değiştirme fonksiyonlarını güncelle
    document.getElementById('prevMonth').onclick = function() {
        currentDate.setMonth(currentDate.getMonth() - 1);
        renderCalendar();
        updateTodayButton();
    };

    document.getElementById('nextMonth').onclick = function() {
        currentDate.setMonth(currentDate.getMonth() + 1);
        renderCalendar();
        updateTodayButton();
    };

    // İlk yüklemede bugün butonunu güncelle
    renderCalendar();
    updateTodayButton();

    // Yeni etkinlik butonu için event listener
    document.getElementById('addEventBtn').onclick = function() {
        const modal = document.getElementById('eventModal');
        const form = document.getElementById('eventForm');
        
        // Form'u sıfırla
        form.reset();
        document.getElementById('modalTitle').textContent = 'Yeni Etkinlik';
        // Etkinlik ID'sini temizle
        form.removeAttribute('data-event-id');
        
        const today = new Date();
        document.getElementById('selectedDate').value = today.toLocaleDateString('en-CA');
        
        modal.style.display = 'flex';
    };

    // Etkinlik düzenleme fonksiyonu
    function editEvent(event) {
        const modal = document.getElementById('eventModal');
        const form = document.getElementById('eventForm');
        
        document.getElementById('modalTitle').textContent = 'Etkinlik Düzenle';
        document.getElementById('selectedDate').value = event.date;
        document.getElementById('eventType').value = event.event_type;
        document.getElementById('eventTime').value = event.time;
        document.getElementById('eventTitle').value = event.title;
        document.getElementById('eventDescription').value = event.description;
        
        // Etkinlik ID'sini form'a ekle
        form.setAttribute('data-event-id', event.id);
        
        modal.style.display = 'flex';
    }

    // Etkinlik silme fonksiyonu
    function deleteEvent(eventId) {
        if (confirm('Bu etkinliği silmek istediğinizden emin misiniz?')) {
            fetch(`/delete_event/${eventId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        }
    }

    // Yeni fonksiyonları ekleyin
    function showEventDetail(event) {
        const modal = document.getElementById('eventDetailModal');
        const badge = document.getElementById('detailEventType');
        
        // Etkinlik türü badge'ini ayarla
        badge.className = `event-type-badge ${event.event_type}`;
        badge.textContent = getEventTypeName(event.event_type);
        
        // Detayları doldur
        document.getElementById('detailTitle').textContent = event.title;
        document.getElementById('detailDate').textContent = formatDate(event.date);
        document.getElementById('detailTime').textContent = event.time;
        document.getElementById('detailDescription').textContent = event.description || 'Açıklama bulunmuyor';
        
        // Düzenle ve Sil butonları için event listener'ları ekle
        document.getElementById('editDetailBtn').onclick = () => {
            modal.style.display = 'none';
            editEvent(event);
        };
        
        document.getElementById('deleteDetailBtn').onclick = () => {
            if (confirm('Bu etkinliği silmek istediğinizden emin misiniz?')) {
                deleteEvent(event.id);
            }
        };
        
        // Modalı göster
        modal.style.display = 'flex';
    }

    // Kapatma butonu için event listener
    document.getElementById('closeDetailModal').onclick = function() {
        document.getElementById('eventDetailModal').style.display = 'none';
    };

    // Modal kapatma işlemlerini güncelle
    document.querySelector('.close-btn').onclick = function() {
        const modal = document.getElementById('eventModal');
        const form = document.getElementById('eventForm');
        
        form.reset();
        form.removeAttribute('data-event-id');
        modal.style.display = 'none';
    }

    document.getElementById('cancelBtn').onclick = function() {
        const modal = document.getElementById('eventModal');
        const form = document.getElementById('eventForm');
        
        form.reset();
        form.removeAttribute('data-event-id');
        modal.style.display = 'none';
    }

    // Etkinlik türü adını döndüren yardımcı fonksiyon
    function getEventTypeName(type) {
        const types = {
            'durusma': 'Duruşma',
            'e-durusma': 'E-Duruşma',
            'tahliye': 'Tahliye',
            'is': 'Yapılacak İş',
            'randevu': 'Randevu',
            'diger': 'Diğer'
        };
        return types[type] || type;
    }

    // Tarih formatlama fonksiyonu
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('tr-TR', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
    }
});
</script>
{% endblock %} 