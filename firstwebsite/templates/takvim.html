{% extends "layout.html" %}

{% block title %}Takvim{% endblock %}

{% block content %}
<div class="page-container">
    <div class="calendar-wrapper">
        <!-- Takvim Başlığı -->
        <div class="calendar-header">
            <div class="calendar-nav">
                <button id="prevMonth" class="nav-btn">
                    <i class="material-icons">chevron_left</i>
                </button>
                <div class="current-month">
                    <h2 id="currentMonth"></h2>
                    <span id="currentYear"></span>
                </div>
                <button id="nextMonth" class="nav-btn">
                    <i class="material-icons">chevron_right</i>
                </button>
            </div>
            <div class="calendar-tools">
                <button id="todayBtn" class="tool-btn">
                    <i class="material-icons">today</i>
                    <span>Bugün</span>
                </button>
                <button id="addEventBtn" class="tool-btn primary">
                    <i class="material-icons">add</i>
                    <span>Yeni Etkinlik</span>
                </button>
            </div>
        </div>

        <!-- Takvim Grid -->
        <div class="calendar-container">
            <div class="weekdays">
                <div>Pazartesi</div>
                <div>Salı</div>
                <div>Çarşamba</div>
                <div>Perşembe</div>
                <div>Cuma</div>
                <div>Cumartesi</div>
                <div>Pazar</div>
            </div>
            <div id="calendar-grid"></div>
        </div>
    </div>
</div>

<!-- Etkinlik Modalı -->
<div id="eventModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Yeni Etkinlik</h3>
            <button class="close-btn">
                <i class="material-icons">close</i>
            </button>
        </div>
        <form id="eventForm" data-event-id="">
            <div class="modal-body">
                <div class="form-group">
                    <label>Etkinlik Türü</label>
                    <div class="select-wrapper">
                        <select id="eventType" name="event_type" required>
                            <option value="durusma">Duruşma</option>
                            <option value="e-durusma">E-Duruşma</option>
                            <option value="tahliye">Tahliye</option>
                            <option value="is">Yapılacak İş</option>
                            <option value="randevu">Randevu</option>
                            <option value="diger">Diğer</option>
                        </select>
                    </div>
                </div>
                <input type="hidden" id="selectedDate" name="date" required>
                <div class="form-group">
                    <label>Saat</label>
                    <div class="input-wrapper">
                        <input type="time" id="eventTime" name="time" required>
                        <i class="material-icons">schedule</i>
                    </div>
                </div>
                <div class="form-group">
                    <label>Başlık</label>
                    <div class="input-wrapper">
                        <input type="text" id="eventTitle" name="title" required placeholder="Etkinlik başlığı">
                        <i class="material-icons">title</i>
                    </div>
                </div>
                <div class="form-group">
                    <label>Açıklama</label>
                    <div class="input-wrapper">
                        <textarea id="eventDescription" name="description" rows="3" placeholder="Etkinlik detayları"></textarea>
                        <i class="material-icons">description</i>
                    </div>
                </div>
                <div class="form-group" id="assignedToGroup">
                    <label>Atanan Kişi</label>
                    <div class="select-wrapper">
                        <select id="assignedTo" name="assigned_to" required>
                            <option value="Av.Mustafa Kaplan">Av. Mustafa Kaplan</option>
                            <option value="Av.Perize Kaplan">Av. Perize Kaplan</option>
                            <option value="Av.Batuhan Kaplan">Av. Batuhan Kaplan</option>
                            <option value="Av.Selvi Dertli">Av. Selvi Dertli</option>
                            <option value="Neva Hanım">Neva Hanım</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" id="deadlineDateGroup">
                    <label>Son Tarih</label>
                    <div class="input-wrapper">
                        <input type="date" id="deadlineDate" name="deadline_date">
                        <i class="material-icons">event</i>
                    </div>
                </div>
                <div class="form-group" id="isCompletedGroup">
                    <label>
                        <input type="checkbox" id="isCompleted" name="is_completed">
                        Tamamlandı
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn secondary" id="cancelBtn">İptal</button>
                <button type="submit" class="btn primary">Kaydet</button>
            </div>
        </form>
    </div>
</div>

<!-- Etkinlik Detay Modalı - HTML kısmına ekleyin -->
<div id="eventDetailModal" class="modal">
    <div class="modal-content detail-modal">
        <div class="modal-header">
            <div class="event-type-badge" id="detailEventType"></div>
            <button class="close-btn" id="closeDetailModal">
                <i class="material-icons">close</i>
            </button>
        </div>
        <div class="modal-body">
            <div class="event-detail-content">
                <h3 id="detailTitle"></h3>
                <div class="event-meta">
                    <div class="meta-item">
                        <i class="material-icons">event</i>
                        <span id="detailDate"></span>
                    </div>
                    <div class="meta-item">
                        <i class="material-icons">schedule</i>
                        <span id="detailTime"></span>
                    </div>
                </div>
                <div class="event-description">
                    <p id="detailDescription"></p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn secondary" id="editDetailBtn">
                <i class="material-icons">edit</i>
                Düzenle
            </button>
            <button class="btn danger" id="deleteDetailBtn">
                <i class="material-icons">delete</i>
                Sil
            </button>
        </div>
    </div>
</div>

<style>
.page-container {
    padding: 1rem;
    min-height: auto;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    box-sizing: border-box;
    margin-bottom: 0;
}

.calendar-wrapper {
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    width: 90%;
    margin: 0 auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
}

.calendar-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    margin-top: 0.5rem;
    margin-bottom: 0;
}

#calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, minmax(120px, 1fr));
    grid-template-rows: repeat(6, minmax(170px, 170px));
    gap: 1px;
    background: #e0e0e0;
    border: 1px solid #e0e0e0;
    min-width: min-content;
}

.calendar-day {
    position: relative;
    background: white;
    padding: 0.5rem;
    display: flex;
    flex-direction: column;
    height: 170px;
    min-width: 120px;
    box-sizing: border-box;
}

.weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #f5f5f5;
    padding: 0.5rem 0;
    font-weight: 600;
    font-size: 0.9rem;
    text-align: center;
}

.calendar-header {
    background: #f8f9fa;
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.calendar-nav {
    display: flex;
    align-items: center;
    gap: 20px;
}

.current-month {
    text-align: center;
}

.current-month h2 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 600;
    color: #2c3e50;
}

.current-month span {
    color: #95a5a6;
    font-size: 1.1rem;
}

.nav-btn, .tool-btn {
    background: none;
    border: none;
    padding: 10px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    color: #2c3e50;
    transition: all 0.2s ease;
}

.nav-btn:hover {
    background: #e9ecef;
}

.tool-btn {
    padding: 8px 16px;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 6px;
}

.tool-btn:hover {
    background: #e9ecef;
    border-color: #ced4da;
}

.tool-btn.primary {
    background: var(--primary-color);
    color: white;
    border: none;
}

.tool-btn.primary:hover {
    background: var(--hover-color);
}

.tool-btn.today-active {
    background: #e3f2fd;
    color: var(--primary-color);
    border-color: var(--primary-color);
}

.calendar-tools {
    display: flex;
    gap: 10px;
}

.calendar-day {
    min-height: 150px;
    padding: 10px;
    background: white;
}

.calendar-day:hover {
    border-color: var(--primary-color);
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

.calendar-day.today {
    background-color: #e3f2fd !important;
    color: #1976d2 !important;
    font-weight: bold;
}

.calendar-day.today .day-number {
    color: #1976d2 !important;
}

.calendar-day.other-month {
    background: #f8f9fa;
    border-color: #f1f3f5;
}

.day-number {
    font-size: 1rem;
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 4px;
    flex-shrink: 0;
    height: 20px;
}

.add-event-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    border: none;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s ease;
}

.calendar-day:hover .add-event-btn {
    display: flex;
}

.add-event-btn:hover {
    background: var(--hover-color);
    transform: scale(1.1);
}

.event-list {
    flex: 1;
    overflow-y: auto;
    margin-top: 4px;
    padding-right: 4px;
    max-height: calc(100% - 25px);
}

.calendar-event {
    padding: 4px 6px;
    margin-bottom: 4px;
    border-radius: 4px;
    background: #f8f9fa;
    border-left: 3px solid;
    font-size: 0.8em;
    cursor: pointer;
    height: 45px;
}

.calendar-event .time-and-type {
    font-weight: 500;
    font-size: 0.85em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 2px;
}

.calendar-event .assigned-to {
    font-size: 0.8em;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.event-durusma { background: #e74c3c; }
.event-e-durusma { background: #FF9800; }
.event-tahliye { background: #3498db; }
.event-is { background: #2ecc71; }
.event-randevu { background: #9b59b6; }
.event-diger { background: #f1c40f; }

/* Modal Stilleri */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal-content {
    background: white;
    border-radius: 10px;
    padding: 20px;
    position: relative;
    width: 90%;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
}

/* Modal başlık */
.modal-header {
    padding: 20px;
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    color: #333;
    font-size: 1.5rem;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.4;
}

/* Form grupları */
.modal-body {
    margin: 20px 0;
    overflow-y: auto;
    max-height: calc(80vh - 140px);
}

.form-group {
    margin-bottom: 20px;
    width: 100%;
    box-sizing: border-box;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #2c3e50;
    font-weight: 500;
    font-size: 0.9rem;
}

/* Input ve Select wrapper */
.input-wrapper, .select-wrapper {
    position: relative;
    width: 100%;
    box-sizing: border-box;
}

.input-wrapper input,
.input-wrapper textarea,
.select-wrapper select {
    width: 100%;
    padding: 10px 12px;
    padding-right: 40px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    font-size: 0.95rem;
    color: #2c3e50;
    background: white;
    transition: border-color 0.2s;
    box-sizing: border-box;
}

.input-wrapper input:focus,
.input-wrapper textarea:focus,
.select-wrapper select:focus {
    outline: none;
    border-color: var(--primary-color);
}

/* İkonlar */
.input-wrapper i,
.select-wrapper i {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #95a5a6;
    pointer-events: none;
}

.input-wrapper textarea {
    min-height: 100px;
    resize: vertical;
    width: 100%;
    box-sizing: border-box;
}

.input-wrapper textarea + i {
    top: 24px;
    transform: none;
}

/* Chrome'un varsayılan saat ikonunu gizle */
input[type="time"]::-webkit-calendar-picker-indicator {
    display: none;
}

/* Modal footer */
.modal-footer {
    padding: 15px 20px;
    background: #f8f9fa;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

/* Butonlar */
.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
}

.btn.primary {
    background: var(--primary-color);
    color: white;
}

.btn.primary:hover {
    background: var(--hover-color);
}

.btn.secondary {
    background: #e9ecef;
    color: #2c3e50;
}

.btn.secondary:hover {
    background: #dee2e6;
}

/* Responsive düzenlemeler */
@media (max-width: 768px) {
    .modal-content {
        width: 95%;
        margin: 10px;
    }
    
    .modal-body {
        padding: 15px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
}

.event-actions {
    display: none;
    gap: 4px;
}

.event-item:hover .event-actions {
    display: flex;
}

.event-action-btn {
    padding: 2px;
    background: rgba(255,255,255,0.2);
    border: none;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.event-action-btn:hover {
    background: rgba(255,255,255,0.3);
}

@media (max-width: 768px) {
    .calendar-header {
        flex-direction: column;
        gap: 15px;
    }
    
    .calendar-tools {
        width: 100%;
        justify-content: center;
    }
    
    .weekdays div {
        font-size: 0.9rem;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .modal-content {
        width: 95%;
        margin: 10px;
    }
    
    .modal-body {
        padding: 15px;
    }
    
    .calendar-day {
        padding: 5px;
    }
    
    .event-item {
        font-size: 0.7rem;
    }
}

/* Detay modalı için stiller */
.detail-modal {
    max-width: 450px;
}

.event-type-badge {
    padding: 6px 12px;
    border-radius: 20px;
    color: white;
    font-size: 0.9rem;
    font-weight: 500;
}

.event-type-badge.durusma { background: #dc3545; }
.event-type-badge.e-durusma { background: #0d6efd; }
.event-type-badge.tahliye { background: #198754; }
.event-type-badge.is { background: #ffc107; }
.event-type-badge.randevu { background: #9b59b6; }
.event-type-badge.diger { background: #6c757d; }

.event-detail-content {
    padding: 10px 0;
}

.event-detail-content h3 {
    margin: 0 0 15px 0;
    font-size: 1.4rem;
    color: #333;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.4;
}

.event-meta {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.meta-item {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #666;
}

.meta-item i {
    font-size: 20px;
}

.event-description {
    margin-top: 15px;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
    max-width: 100%;
}

.event-detail-description {
    margin-top: 15px;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.5;
    max-width: 100%;
}

.btn.danger {
    background: #e74c3c;
    color: white;
}

.btn.danger:hover {
    background: #c0392b;
}

/* Event item'a tıklama olayı ekleyin */
.event-item {
    cursor: pointer;
}

/* Chrome'un kendi saat ikonunu gizle */
input[type="time"]::-webkit-calendar-picker-indicator {
    display: none;
}

/* Etkinlik listesi scrollbar stilleri */
.event-list::-webkit-scrollbar {
    width: 4px;
}

.event-list::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px;
}

.event-list::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 2px;
}

.event-list::-webkit-scrollbar-thumb:hover {
    background: #999;
}

.weekend {
    background-color: #faf6f3;
}

.weekend.holiday {
    background-color: #ffebee !important;
}

.weekend .day-number {
    color: #8b7355;
}

.holiday {
    background-color: #ffebee;
    position: relative;
}

.holiday-name {
    font-size: 0.7rem;
    color: #e53935;
    margin-top: 0;
    margin-bottom: 4px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex-shrink: 0;
    height: 16px;
}

.holiday .day-number {
    color: #e53935;
}

.weekend .day-number {
    color: #495057;
}

/* Hafta sonu ve bugün çakıştığında bugünün stilini koruyalım */
.calendar-day.weekend.today {
    background-color: #e3f2fd !important;
}

.calendar-day.weekend.today .day-number {
    color: #1976d2 !important;
}

/* Tatil günleri için stil */
.holiday {
    background-color: #ffebee;
    position: relative;
}

/* Tatil günü bugüne denk geldiğinde de bugünün stilini koruyalım */
.calendar-day.holiday.today {
    background-color: #e3f2fd !important;
}

.calendar-day.holiday.today .day-number {
    color: #1976d2 !important;
}

/* Adli tatil günleri için stil */
.calendar-day.adli-tatil {
    background-color: rgba(76, 175, 80, 0.1);
}

.calendar-day.adli-tatil .day-number {
    color: #4CAF50;
}

.calendar-day.adli-tatil .holiday-name {
    color: #4CAF50;
    font-size: 0.7rem;
}

.event-title {
    font-weight: 500;
    margin: 5px 0;
    font-size: 0.9rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
}

#detailTitle {
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    line-height: 1.4;
    margin-bottom: 15px;
    font-size: 1.5rem;
    color: #333;
}

.calendar-day .event {
    background: #f8f9fa;
    border-radius: 4px;
    padding: 4px 8px;
    margin-bottom: 4px;
    font-size: 0.85rem;
    cursor: pointer;
    border-left: 3px solid;
}

.calendar-day .event-title {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
    display: block;
}

@media (max-height: 800px) {
    #calendar-grid {
        grid-template-rows: repeat(6, minmax(170px, 170px));
    }
    
    .calendar-day {
        height: 170px;
    }
}

@media (max-width: 1024px) {
    #calendar-grid {
        grid-template-rows: repeat(6, minmax(170px, 170px));
    }
    
    .calendar-day {
        height: 170px;
        min-width: 100px;
    }
}

@media (max-width: 768px) {
    #calendar-grid {
        grid-template-rows: repeat(6, minmax(170px, 170px));
    }
    
    .calendar-day {
        height: 170px;
        min-width: 90px;
    }
}

/* Scrollbar stilleri */
.calendar-container::-webkit-scrollbar {
    display: none;
}

.calendar-container {
    -ms-overflow-style: none;
    scrollbar-width: none;
}

.calendar-event {
    padding: 6px;
    margin-bottom: 4px;
    border-radius: 4px;
    background: #f8f9fa;
    border-left: 3px solid;
    font-size: 0.8em;
    cursor: pointer;
    min-height: 40px;
}

.calendar-event .time-and-type {
    font-weight: 500;
    font-size: 0.9em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.calendar-event .assigned-to {
    font-size: 0.85em;
    color: #666;
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.calendar-event.completed {
    opacity: 0.7;
    text-decoration: line-through;
}

.calendar-event[data-type="durusma"] { color: #dc3545; }
.calendar-event[data-type="e-durusma"] { color: #0d6efd; }
.calendar-event[data-type="tahliye"] { color: #198754; }
.calendar-event[data-type="is"] { color: #ffc107; }
.calendar-event[data-type="randevu"] { color: #9b59b6; }
.calendar-event[data-type="diger"] { color: #6c757d; }

.calendar-day.empty {
    background: #f8f9fa;
    border: none;
    pointer-events: none;
}

.holiday {
    background-color: #ffebee;
}

.holiday .holiday-name {
    color: #e53935;
    font-size: 0.7rem;
    margin-top: 4px;
    font-weight: 500;
}

.adli-tatil {
    background-color: rgba(76, 175, 80, 0.1);
}

.adli-tatil .holiday-name {
    color: #4CAF50;
    font-size: 0.7rem;
    margin-top: 4px;
    font-weight: 500;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentDate = new Date();
    const events = {{ events|tojson|safe }};
    
    const months = [
        'Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran',
        'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'
    ];

    const eventTypes = {
        'durusma': 'Duruşma',
        'e-durusma': 'E-Duruşma',
        'tahliye': 'Tahliye',
        'is': 'Yapılacak İş',
        'randevu': 'Randevu',
        'diger': 'Diğer'
    };

    // Resmi tatiller ve özel günler
    const holidays = {
        '2024-01-01': 'Yılbaşı',
        '2024-04-10': 'Ramazan Bayramı',
        '2024-04-11': 'Ramazan Bayramı',
        '2024-04-12': 'Ramazan Bayramı',
        '2024-04-23': 'Ulusal Egemenlik ve Çocuk Bayramı',
        '2024-05-01': 'Emek ve Dayanışma Günü',
        '2024-05-19': 'Atatürkü Anma, Gençlik ve Spor Bayramı',
        '2024-06-15': 'Kurban Bayramı Arefesi',
        '2024-06-16': 'Kurban Bayramı',
        '2024-06-17': 'Kurban Bayramı',
        '2024-06-18': 'Kurban Bayramı',
        '2024-06-19': 'Kurban Bayramı',
        '2024-07-15': 'Demokrasi ve Milli Birlik Günü',
        '2024-08-30': 'Zafer Bayramı',
        '2024-10-29': 'Cumhuriyet Bayramı',
        '2025-01-01': 'Yılbaşı',
        '2025-03-31': 'Ramazan Bayramı',
        '2025-04-01': 'Ramazan Bayramı',
        '2025-04-02': 'Ramazan Bayramı',
        '2025-04-23': 'Ulusal Egemenlik ve Çocuk Bayramı',
        '2025-05-01': 'Emek ve Dayanışma Günü',
        '2025-05-19': 'Atatürkü Anma, Gençlik ve Spor Bayramı',
        '2025-06-06': 'Kurban Bayramı Arefesi',
        '2025-06-07': 'Kurban Bayramı',
        '2025-06-08': 'Kurban Bayramı',
        '2025-06-09': 'Kurban Bayramı',
        '2025-06-10': 'Kurban Bayramı',
        '2025-07-15': 'Demokrasi ve Milli Birlik Günü',
        '2025-08-30': 'Zafer Bayramı',
        '2025-10-29': 'Cumhuriyet Bayramı',
        '2026-01-01': 'Yılbaşı',
        '2026-03-19': 'Ramazan Bayramı Arefesi',
        '2026-03-20': 'Ramazan Bayramı',
        '2026-03-21': 'Ramazan Bayramı',
        '2026-03-22': 'Ramazan Bayramı',
        '2026-04-23': 'Ulusal Egemenlik ve Çocuk Bayramı',
        '2026-05-01': 'Emek ve Dayanışma Günü',
        '2026-05-19': 'Atatürkü Anma, Gençlik ve Spor Bayramı',
        '2026-05-26': 'Kurban Bayramı Arefesi',
        '2026-05-27': 'Kurban Bayramı',
        '2026-05-28': 'Kurban Bayramı',
        '2026-05-29': 'Kurban Bayramı',
        '2026-05-30': 'Kurban Bayramı',
        '2026-07-15': 'Demokrasi ve Milli Birlik Günü',
        '2026-08-30': 'Zafer Bayramı',
        '2026-10-28': 'Cumhuriyet Bayramı Arefesi',
        '2026-10-29': 'Cumhuriyet Bayramı'
    };

    function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        
        document.getElementById('currentMonth').textContent = months[month];
        document.getElementById('currentYear').textContent = year;
        
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        
        let startDay = firstDay.getDay();
        if (startDay === 0) startDay = 7;
        startDay--;
        
        const calendar = document.getElementById('calendar-grid');
        calendar.innerHTML = '';
        
        // Önceki ayın günlerini gösterme
        for (let i = 0; i < startDay; i++) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'calendar-day empty';
            calendar.appendChild(emptyDiv);
        }
        
        // Bu ayın günleri
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const date = new Date(year, month, day);
            calendar.appendChild(createDayElement(date));
        }
        
        // Sonraki ayın günlerini gösterme
        const totalCells = startDay + lastDay.getDate();
        const remainingCells = Math.ceil(totalCells / 7) * 7 - totalCells;
        for (let i = 0; i < remainingCells; i++) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'calendar-day empty';
            calendar.appendChild(emptyDiv);
        }
    }

    function isAdliTatil(date) {
        const month = date.getMonth();
        const day = date.getDate();
        return (month === 6 && day >= 20) || month === 7; // Temmuz 20'den sonra veya tüm Ağustos ayı
    }

    function formatDateForAPI(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function createDayElement(date) {
        const div = document.createElement('div');
        div.className = 'calendar-day';
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = date.getDate();
        div.appendChild(dayNumber);
        
        // Hafta sonu kontrolü
        const dayOfWeek = date.getDay();
        if (dayOfWeek === 0 || dayOfWeek === 6) {
            div.classList.add('weekend');
        }
        
        // Bugün kontrolü
        if (date.toDateString() === new Date().toDateString()) {
            div.classList.add('today');
        }
        
        // Resmi tatil kontrolü - UTC dönüşümü olmadan
        const dateStr = formatDateForAPI(date);
        if (holidays[dateStr]) {
            div.classList.add('holiday');
            const holidayName = document.createElement('div');
            holidayName.className = 'holiday-name';
            holidayName.textContent = holidays[dateStr];
            div.appendChild(holidayName);
        }
        
        // Adli tatil kontrolü
        if (isAdliTatil(date)) {
            div.classList.add('adli-tatil');
            if (!holidays[dateStr]) {
                const adliTatilText = document.createElement('div');
                adliTatilText.className = 'holiday-name';
                adliTatilText.textContent = 'Adli Tatil';
                div.appendChild(adliTatilText);
            }
        }

        // Etkinlikleri göster - UTC dönüşümü olmadan
        const dayEvents = events.filter(e => e.date === dateStr);
        if (dayEvents.length > 0) {
            const eventList = document.createElement('div');
            eventList.className = 'event-list';
            
            dayEvents.sort((a, b) => a.time.localeCompare(b.time));
            
            dayEvents.forEach(event => {
                const eventDiv = document.createElement('div');
                eventDiv.className = 'calendar-event';
                eventDiv.setAttribute('data-type', event.event_type);
                
                const eventContent = document.createElement('div');
                eventContent.className = 'event-content';
                
                const timeAndType = document.createElement('div');
                timeAndType.className = 'time-and-type';
                timeAndType.textContent = `${event.time} / ${eventTypes[event.event_type]}`;
                
                const assignedTo = document.createElement('div');
                assignedTo.className = 'assigned-to';
                assignedTo.textContent = event.assigned_to || '';
                
                eventContent.appendChild(timeAndType);
                eventContent.appendChild(assignedTo);
                eventDiv.appendChild(eventContent);
                
                if (event.is_completed) {
                    eventDiv.classList.add('completed');
                }
                
                eventDiv.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showEventDetail(event);
                });
                
                eventList.appendChild(eventDiv);
            });
            
            div.appendChild(eventList);
        }
        
        div.addEventListener('click', () => showModal(date));
        
        return div;
    }

    function showModal(date) {
        const modal = document.getElementById('eventModal');
        const form = document.getElementById('eventForm');
        
        // Formu sıfırla
        form.reset();
        form.removeAttribute('data-event-id');
        
        // Tarihi ayarla - UTC dönüşümü olmadan
        document.getElementById('selectedDate').value = formatDateForAPI(date);
        
        // Varsayılan saat değerini ayarla
        document.getElementById('eventTime').value = '09:00';
        
        // Form alanlarının görünürlüğünü kontrol et
        toggleFormFields();
        
        modal.style.display = 'flex';
    }

    // Modal kapatma fonksiyonunu güncelle
    function closeModal() {
        const modal = document.getElementById('eventModal');
        const form = document.getElementById('eventForm');
        
        // Formu sıfırla
        form.reset();
        form.removeAttribute('data-event-id');
        
        // Form alanlarının görünürlüğünü sıfırla
        document.getElementById('assignedToGroup').style.display = 'none';
        document.getElementById('deadlineDateGroup').style.display = 'none';
        document.getElementById('isCompletedGroup').style.display = 'none';
        
        // Modal'ı kapat
        modal.style.display = 'none';
    }

    // Kapatma butonları için event listener'ları güncelle
    document.querySelector('.close-btn').onclick = closeModal;
    document.getElementById('cancelBtn').onclick = closeModal;

    // Etkinlik düzenleme fonksiyonunu güncelle
    function editEvent(event) {
        const modal = document.getElementById('eventModal');
        const form = document.getElementById('eventForm');
        
        document.getElementById('modalTitle').textContent = 'Etkinlik Düzenle';
        document.getElementById('selectedDate').value = event.date;
        document.getElementById('eventType').value = event.event_type;
        document.getElementById('eventTime').value = event.time;
        document.getElementById('eventTitle').value = event.title;
        document.getElementById('eventDescription').value = event.description || '';
        
        if (event.assigned_to) {
            document.getElementById('assignedTo').value = event.assigned_to;
        }
        if (event.deadline_date) {
            document.getElementById('deadlineDate').value = event.deadline_date;
        }
        document.getElementById('isCompleted').checked = event.is_completed || false;
        
        // Form alanlarının görünürlüğünü kontrol et
        toggleFormFields();
        
        form.setAttribute('data-event-id', event.id);
        modal.style.display = 'flex';
    }

    // Etkinlik silme fonksiyonu
    function deleteEvent(eventId) {
        if (confirm('Bu etkinliği silmek istediğinizden emin misiniz?')) {
            fetch(`/delete_event/${eventId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        }
    }

    // Yeni fonksiyonları ekleyin
    function showEventDetail(event) {
        const modal = document.getElementById('eventDetailModal');
        const badge = document.getElementById('detailEventType');
        
        // Etkinlik türü badge'ini ayarla
        badge.className = `event-type-badge ${event.event_type}`;
        badge.textContent = getEventTypeName(event.event_type);
        
        // Detayları doldur
        document.getElementById('detailTitle').textContent = event.title;
        document.getElementById('detailDate').textContent = formatDate(event.date);
        document.getElementById('detailTime').textContent = event.time;
        
        // Açıklama ve atanan kişi bilgilerini ekle
        let description = event.description || '';
        if (event.assigned_to) {
            description = `Atanan Kişi: ${event.assigned_to}\n\n${description}`;
        }
        if (event.deadline_date) {
            description = `Son Tarih: ${formatDate(event.deadline_date)}\n\n${description}`;
        }
        if (event.is_completed) {
            description = `Durum: Tamamlandı\n\n${description}`;
        }
        document.getElementById('detailDescription').textContent = description || 'Açıklama bulunmuyor';
        
        // Düzenle ve Sil butonları için event listener'ları ekle
        document.getElementById('editDetailBtn').onclick = () => {
            modal.style.display = 'none';
            editEvent(event);
        };
        
        document.getElementById('deleteDetailBtn').onclick = () => {
            if (confirm('Bu etkinliği silmek istediğinizden emin misiniz?')) {
                deleteEvent(event.id);
            }
        };
        
        // Modalı göster
        modal.style.display = 'flex';
    }

    // Kapatma butonu için event listener
    document.getElementById('closeDetailModal').onclick = function() {
        document.getElementById('eventDetailModal').style.display = 'none';
    };

    // Etkinlik türü adını döndüren yardımcı fonksiyon
    function getEventTypeName(type) {
        const types = {
            'durusma': 'Duruşma',
            'e-durusma': 'E-Duruşma',
            'tahliye': 'Tahliye',
            'is': 'Yapılacak İş',
            'randevu': 'Randevu',
            'diger': 'Diğer'
        };
        return types[type] || type;
    }

    // Tarih formatlama fonksiyonu
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        return date.toLocaleDateString('tr-TR', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
    }

    // Etkinlik türüne göre form alanlarını göster/gizle
    function toggleFormFields() {
        const eventType = document.getElementById('eventType').value;
        const assignedToGroup = document.getElementById('assignedToGroup');
        const deadlineDateGroup = document.getElementById('deadlineDateGroup');
        const isCompletedGroup = document.getElementById('isCompletedGroup');
        
        // Kişi atama alanını tüm etkinlik türlerinde göster
        assignedToGroup.style.display = 'block';
        document.getElementById('assignedTo').required = true;
        
        // Tamamlandı seçeneğini tüm etkinlik türlerinde göster
        isCompletedGroup.style.display = 'block';
        
        // Son tarih alanını gizle
        deadlineDateGroup.style.display = 'none';
    }

    // Event listener'ları ekle
    document.getElementById('eventType').addEventListener('change', toggleFormFields);
    
    // Modal açıldığında da kontrol et
    document.getElementById('addEventBtn').addEventListener('click', function() {
        setTimeout(toggleFormFields, 100); // Modal açıldıktan sonra çalışması için küçük bir gecikme
    });

    // Etkinlik oluşturma fonksiyonunu güncelle
    function createEventElement(event) {
        const eventDiv = document.createElement('div');
        eventDiv.className = 'calendar-event';
        eventDiv.setAttribute('data-type', event.event_type);
        eventDiv.setAttribute('data-id', event.id);
        if (event.is_completed) {
            eventDiv.classList.add('completed');
        }
        
        const timeDiv = document.createElement('div');
        timeDiv.className = 'event-time';
        timeDiv.textContent = event.time;
        
        const typeDiv = document.createElement('div');
        typeDiv.className = 'event-type';
        typeDiv.textContent = eventTypes[event.event_type];
        
        eventDiv.appendChild(timeDiv);
        eventDiv.appendChild(typeDiv);
        
        if (event.assigned_to) {
            const assignedDiv = document.createElement('div');
            assignedDiv.className = 'assigned-to';
            assignedDiv.textContent = event.assigned_to;
            eventDiv.appendChild(assignedDiv);
        }
        
        eventDiv.addEventListener('click', () => showEventDetails(event));
        
        return eventDiv;
    }

    // Etkinlikleri sırala
    function sortEvents(events) {
        return events.sort((a, b) => {
            return a.time.localeCompare(b.time);
        });
    }

    // Takvim günü oluşturma fonksiyonunu güncelle
    function createCalendarDay(date, events = []) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        
        const dateHeader = document.createElement('div');
        dateHeader.className = 'date-header';
        dateHeader.textContent = date.getDate();
        dayDiv.appendChild(dateHeader);
        
        const sortedEvents = sortEvents(events);
        sortedEvents.forEach(event => {
            dayDiv.appendChild(createEventElement(event));
        });
        
        return dayDiv;
    }

    // Bugün butonu için geliştirilen fonksiyon
    function updateTodayButton() {
        const todayBtn = document.getElementById('todayBtn');
        const today = new Date();
        const isCurrentMonth = today.getMonth() === currentDate.getMonth() && 
                             today.getFullYear() === currentDate.getFullYear();
        
        if (isCurrentMonth) {
            todayBtn.classList.add('today-active');
        } else {
            todayBtn.classList.remove('today-active');
        }
    }

    // Bugün butonu
    document.getElementById('todayBtn').onclick = function() {
        currentDate = new Date();
        renderCalendar();
        updateTodayButton();
    };

    // Ay değiştirme butonları
    document.getElementById('prevMonth').onclick = function() {
        const newDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
        currentDate = newDate;
        renderCalendar();
        updateTodayButton();
    };

    document.getElementById('nextMonth').onclick = function() {
        const newDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
        currentDate = newDate;
        renderCalendar();
        updateTodayButton();
    };

    // İlk yüklemede takvimi ve bugün butonunu güncelle
    currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1); // Ayın ilk gününe ayarla
    renderCalendar();
    updateTodayButton();

    // Form submit işlemi
    document.getElementById('eventForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const form = this;
        const eventId = form.getAttribute('data-event-id');
        const submitButton = form.querySelector('button[type="submit"]');
        
        submitButton.disabled = true;
        
        try {
            const formData = {
                event_type: document.getElementById('eventType').value,
                date: document.getElementById('selectedDate').value,
                time: document.getElementById('eventTime').value,
                title: document.getElementById('eventTitle').value,
                description: document.getElementById('eventDescription').value,
                assigned_to: document.getElementById('assignedTo').value,
                deadline_date: document.getElementById('deadlineDate').value || null,
                is_completed: document.getElementById('isCompleted').checked
            };
            
            const url = eventId ? `/update_event/${eventId}` : '/add_event';
            const method = eventId ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                closeModal();
                location.reload();
            } else {
                alert('Etkinlik kaydedilirken bir hata oluştu: ' + (result.error || 'Bilinmeyen hata'));
            }
        } catch (error) {
            alert('Bir hata oluştu: ' + error.message);
        } finally {
            submitButton.disabled = false;
        }
    });
});
</script>
{% endblock %} 