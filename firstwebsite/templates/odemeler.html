{% extends "layout.html" %}

{% block title %}Ödemeler{% endblock %}

{% block content %}
    <div class="header-left">
        <h1>Ödemeler</h1>
    </div>

    <div class="form-container">
        <form method="POST" id="paymentForm" onsubmit="savePayment(event)">
            <div class="input-group">
                <label for="name">Ad</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="input-group">
                <label for="surname">Soyad</label>
                <input type="text" id="surname" name="surname" required>
            </div>
            <div class="input-group">
                <label for="tc">TC Kimlik No</label>
                <input type="text" id="tc" name="tc" required>
            </div>
            <div class="input-group">
                <label for="amount">Tutar</label>
                <div style="display: flex; gap: 5px;">
                    <input type="number" id="amount" name="amount" required style="flex: 1;">
                    <select id="currency" name="currency" required>
                        <option value="TRY">TRY</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
            </div>
            <div class="input-group">
                <label for="installments">Taksit Sayısı</label>
                <select id="installments" name="installments" required>
                    {% for i in range(1, 13) %}
                        <option value="{{ i }}">{{ i }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="input-group">
                <label for="date">Ödeme Tarihi</label>
                <input type="date" id="date" name="date" required>
            </div>
            <button type="submit">Kaydet</button>
        </form>
    </div>

    <div class="table-container">
        <h2>Müvekkil Ödeme Listesi</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Ad</th>
                    <th>Soyad</th>
                    <th>TC Kimlik No</th>
                    <th>Tutar</th>
                    <th>Taksit Sayısı</th>
                    <th>Ödeme Tarihi</th>
                    <th>Durum</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody>
                {% for client in clients %}
                <tr data-client-id="{{ client.id }}" data-description="{{ client.description }}">
                    <td contenteditable="false">{{ client.name }}</td>
                    <td contenteditable="false">{{ client.surname }}</td>
                    <td contenteditable="false">{{ client.tc }}</td>
                    <td contenteditable="false">{{ client.amount }} {{ client.currency }}</td>
                    <td contenteditable="false">{{ client.installments }}</td>
                    <td contenteditable="false">{{ client.date }}</td>
                    <td>
                        {% if client.status == 'Ödendi' %}
                            <span class="status-paid">Ödendi</span>
                        {% else %}
                            <span class="status-unpaid">Ödenmedi</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="edit-btn" onclick="openEditModal(this)">
                                <i class="material-icons">edit</i>
                            </button>
                            <button class="delete-btn" onclick="deletePayment(this)">
                                <i class="material-icons">delete</i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Düzenleme Modalı -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ödeme Düzenle</h2>
                <span class="close">&times;</span>
            </div>
            <form id="editForm">
                <input type="hidden" id="editClientId" name="editClientId">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editName">Ad</label>
                            <input type="text" id="editName" name="editName" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="editSurname">Soyad</label>
                            <input type="text" id="editSurname" name="editSurname" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group tc-group">
                            <label for="editTc">TC Kimlik No</label>
                            <input type="text" id="editTc" name="editTc" class="form-control" required maxlength="11">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group amount-group">
                            <label for="editAmount">Tutar</label>
                            <div class="amount-input">
                                <input type="number" id="editAmount" name="editAmount" class="form-control" required>
                                <select id="editCurrency" name="editCurrency" class="form-control currency-select" required>
                                    <option value="TRY">TRY</option>
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="editInstallments">Taksit Sayısı</label>
                            <select id="editInstallments" name="editInstallments" class="form-control" required>
                                {% for i in range(1, 13) %}
                                    <option value="{{ i }}">{{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group date-group">
                            <label for="editDate">Ödeme Tarihi</label>
                            <input type="date" id="editDate" name="editDate" class="form-control" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ödeme Durumu</label>
                            <div class="toggle-container">
                                <div class="toggle-switch">
                                    <input type="checkbox" id="editStatus" name="editStatus">
                                    <label for="editStatus"></label>
                                </div>
                                <span class="status-text">Ödenmedi</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editDescription">Açıklama</label>
                            <div class="textarea-container">
                                <textarea id="editDescription" name="editDescription" class="form-control" rows="3" placeholder="Açıklama bulunmuyor"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-btn">İptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .status-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-container label {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .status-paid {
            color: #4CAF50;
            font-weight: 500;
        }
        
        .status-unpaid {
            color: #ff4444;
            font-weight: 500;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        .action-buttons button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }
        .edit-btn i {
            color: #2196F3;
        }
        .delete-btn i {
            color: #000;
        }
        
        /* Modern Modal Stilleri */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: #fff;
            margin: 3% auto;
            width: 90%;
            max-width: 600px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            animation: slideIn 0.3s ease;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
            color: #333;
            font-weight: 600;
        }
        
        .modal-body {
            padding: 25px;
            overflow-y: visible;
        }
        
        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .close {
            font-size: 24px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close:hover {
            color: #333;
        }
        
        /* Form Stilleri */
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .form-group.tc-group {
            flex: 0 0 200px;
        }
        
        .form-group.date-group {
            flex: 0 0 200px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-sizing: border-box;
        }
        
        .form-control:focus {
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            outline: none;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }
        
        /* Tutar Input Grubu */
        .amount-group {
            flex: 2;
            min-width: 250px;
        }
        
        .amount-input {
            display: flex;
            gap: 10px;
        }
        
        .currency-select {
            width: 80px;
            flex-shrink: 0;
        }
        
        /* Toggle Switch Stilleri */
        .toggle-container {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-top: 8px;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }
        
        .toggle-switch input {
            display: none;
        }
        
        .toggle-switch label {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #ff4444;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .toggle-switch label:after {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: white;
            top: 3px;
            left: 3px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .toggle-switch input:checked + label {
            background-color: #4CAF50;
        }
        
        .toggle-switch input:checked + label:after {
            transform: translateX(30px);
        }
        
        .status-text {
            font-weight: 500;
            color: #666;
        }
        
        /* Buton Stilleri */
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary {
            background-color: #2196F3;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1976D2;
        }
        
        .btn-secondary {
            background-color: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #d5d5d5;
        }
        
        /* Textarea placeholder stili */
        textarea::placeholder {
            color: #999;
            font-style: italic;
        }

        /* Textarea Stili */
        textarea.form-control {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
    </style>

    <script>
        // Modal ve düzenleme işlemleri
        const modal = document.getElementById('editModal');
        const closeBtn = document.getElementsByClassName('close')[0];
        const cancelBtn = document.querySelector('.close-btn');
        
        function closeModal() {
            modal.style.display = 'none';
        }
        
        closeBtn.onclick = closeModal;
        cancelBtn.onclick = closeModal;
        
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        // Ödeme durumu toggle switch işlevi
        const statusToggle = document.getElementById('editStatus');
        const statusText = document.querySelector('.status-text');
        
        statusToggle.addEventListener('change', function() {
            statusText.textContent = this.checked ? 'Ödendi' : 'Ödenmedi';
        });

        function openEditModal(button) {
            const row = button.closest('tr');
            const clientId = row.getAttribute('data-client-id');
            
            // Form alanlarını doldur
            document.getElementById('editClientId').value = clientId;
            document.getElementById('editName').value = row.querySelector('td:nth-child(1)').innerText;
            document.getElementById('editSurname').value = row.querySelector('td:nth-child(2)').innerText;
            document.getElementById('editTc').value = row.querySelector('td:nth-child(3)').innerText;
            
            const amountAndCurrency = row.querySelector('td:nth-child(4)').innerText.split(' ');
            document.getElementById('editAmount').value = amountAndCurrency[0];
            document.getElementById('editCurrency').value = amountAndCurrency[1];
            
            document.getElementById('editInstallments').value = row.querySelector('td:nth-child(5)').innerText;
            document.getElementById('editDate').value = row.querySelector('td:nth-child(6)').innerText;
            
            const isPaid = row.querySelector('td:nth-child(7)').textContent.trim() === 'Ödendi';
            document.getElementById('editStatus').checked = isPaid;
            document.querySelector('.status-text').textContent = isPaid ? 'Ödendi' : 'Ödenmedi';

            // Açıklama alanını doldur (eğer varsa)
            const description = row.getAttribute('data-description');
            const descriptionArea = document.getElementById('editDescription');
            descriptionArea.value = description === 'None' ? '' : (description || '');
            
            modal.style.display = 'block';
        }

        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const clientId = document.getElementById('editClientId').value;
            const isPaid = document.getElementById('editStatus').checked;
            
            fetch(`/update_client/${clientId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: document.getElementById('editName').value,
                    surname: document.getElementById('editSurname').value,
                    tc: document.getElementById('editTc').value,
                    amount: document.getElementById('editAmount').value,
                    currency: document.getElementById('editCurrency').value,
                    installments: document.getElementById('editInstallments').value,
                    date: document.getElementById('editDate').value,
                    status: isPaid ? 'Ödendi' : 'Ödenmedi',
                    description: document.getElementById('editDescription').value
                })
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      alert('Kayıt güncellendi!');
                      // Tablodaki satırı güncelle
                      const row = document.querySelector(`tr[data-client-id="${clientId}"]`);
                      row.querySelector('td:nth-child(1)').innerText = document.getElementById('editName').value;
                      row.querySelector('td:nth-child(2)').innerText = document.getElementById('editSurname').value;
                      row.querySelector('td:nth-child(3)').innerText = document.getElementById('editTc').value;
                      row.querySelector('td:nth-child(4)').innerText = `${document.getElementById('editAmount').value} ${document.getElementById('editCurrency').value}`;
                      row.querySelector('td:nth-child(5)').innerText = document.getElementById('editInstallments').value;
                      row.querySelector('td:nth-child(6)').innerText = document.getElementById('editDate').value;
                      
                      // Ödeme durumunu güncelle
                      const statusCell = row.querySelector('td:nth-child(7)');
                      if (isPaid) {
                          statusCell.innerHTML = '<span class="status-paid">Ödendi</span>';
                      } else {
                          statusCell.innerHTML = '<span class="status-unpaid">Ödenmedi</span>';
                      }
                      
                      // Açıklamayı data attribute olarak kaydet
                      row.setAttribute('data-description', document.getElementById('editDescription').value);
                      
                      modal.style.display = 'none';
                  } else {
                      alert('Güncelleme başarısız!');
                  }
              });
        });

        function deletePayment(button) {
            if (confirm('Bu ödemeyi silmek istediğinizden emin misiniz?')) {
                const row = button.closest('tr');
                const clientId = row.getAttribute('data-client-id');
                
                fetch(`/delete_client/${clientId}`, {
                    method: 'DELETE',  
                    headers: {
                        'Content-Type': 'application/json'
                    }
                }).then(response => response.json())
                  .then(data => {
                      if (data.success) {
                          alert('Ödeme başarıyla silindi!');
                          row.remove();
                      } else {
                          alert('Silme işlemi başarısız: ' + (data.message || 'Bilinmeyen bir hata oluştu'));
                      }
                  })
                  .catch(error => {
                      alert('Silme işlemi sırasında bir hata oluştu: ' + error.message);
                  });
            }
        }

        // Yeni ödeme kaydetme fonksiyonu
        function savePayment(event) {
            event.preventDefault(); // Formun normal gönderimini engelle
            
            const formData = new FormData(document.getElementById('paymentForm'));
            
            fetch('/odemeler', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Ödeme başarıyla kaydedildi!');
                    // Formu temizle
                    document.getElementById('paymentForm').reset();
                    // Sayfayı yenile - yeni ödemeyi tabloda görmek için
                    window.location.reload();
                } else {
                    alert('Ödeme kaydedilirken bir hata oluştu: ' + (data.message || 'Bilinmeyen bir hata'));
                }
            })
            .catch(error => {
                alert('Ödeme kaydedilirken bir hata oluştu: ' + error.message);
            });
        }
    </script>
{% endblock %}